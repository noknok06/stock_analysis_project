<!-- ========================================
templates/notes/edit.html - 修正版（作成ページと一致）
======================================== -->

{% extends 'base.html' %}

{% block title %}{{ notebook.title }} - 編集 - 株式分析記録アプリ{% endblock %}

{% block extra_css %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/tag-manager.css' %}">
<style>
    .form-section {
        background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
    }
    .status-indicator {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }
    .animate-in {
        animation: slideInFromLeft 0.3s ease-out;
    }
    @keyframes slideInFromLeft {
        from { transform: translateX(-10px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    /* 変更差分ハイライト */
    .field-changed {
        animation: fieldGlow 2s ease-in-out;
    }
    
    @keyframes fieldGlow {
        0%, 100% { 
            box-shadow: 0 0 0 rgba(59, 130, 246, 0);
        }
        50% { 
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center space-x-4 mb-4">
            <a href="{% url 'notes:detail' notebook.pk %}" 
               class="text-gray-400 hover:text-white transition-colors">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </a>
            <div>
                <h1 class="text-3xl font-bold text-white">ノート編集</h1>
                <p class="text-gray-400">{{ notebook.title }}</p>
            </div>
            <div class="ml-auto">
                <span class="status-indicator px-3 py-1 text-sm rounded-full 
                           {% if notebook.status == 'ACTIVE' %}bg-green-900 text-green-300
                           {% elif notebook.status == 'MONITORING' %}bg-yellow-900 text-yellow-300
                           {% elif notebook.status == 'ATTENTION' %}bg-red-900 text-red-300
                           {% else %}bg-gray-700 text-gray-300{% endif %}">
                    {{ notebook.get_status_display }}
                </span>
            </div>
        </div>
        <p class="text-gray-400">ノートの内容を更新しましょう</p>
    </div>

    <!-- Form -->
    <form method="POST" id="notebook-form" class="space-y-8">
        {% csrf_token %}
        
        <!-- 基本情報セクション -->
        <section class="form-section bg-gray-800 border border-gray-700 rounded-lg p-8">
            <h2 class="text-xl font-semibold text-white mb-6 flex items-center">
                <svg class="h-6 w-6 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-6m-2-5.5V9.5a2 2 0 012-2h6a2 2 0 012 2V16"></path>
                </svg>
                基本情報
            </h2>
            
            <div class="space-y-6">
                <!-- ノートタイプ -->
                <div>
                    <label for="id_notebook_type" class="block text-sm font-medium text-gray-300 mb-2">ノートタイプ</label>
                    <select id="id_notebook_type" 
                            name="notebook_type"
                            class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="THEME" {% if notebook.notebook_type == 'THEME' %}selected{% endif %}>テーマ型（複数銘柄）</option>
                        <option value="STOCK_FOCUSED" {% if notebook.notebook_type == 'STOCK_FOCUSED' %}selected{% endif %}>銘柄特化型（1銘柄集中）</option>
                        <option value="PORTFOLIO" {% if notebook.notebook_type == 'PORTFOLIO' %}selected{% endif %}>ポートフォリオ管理</option>
                        <option value="RESEARCH" {% if notebook.notebook_type == 'RESEARCH' %}selected{% endif %}>調査・研究</option>
                    </select>
                </div>

                <!-- タイトル -->
                <div>
                    <label for="id_title" class="block text-sm font-medium text-gray-300 mb-2">
                        ノートタイトル <span class="text-red-400">*</span>
                    </label>
                    <input type="text" 
                           id="id_title" 
                           name="title" 
                           value="{{ notebook.title }}"
                           required
                           placeholder="例: 2025年 高配当株ウォッチ"
                           class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    {% if form.title.errors %}
                        <p class="text-red-400 text-sm mt-1">{{ form.title.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- 説明 -->
                <div>
                    <label for="id_description" class="block text-sm font-medium text-gray-300 mb-2">ノートの説明</label>
                    <textarea id="id_description" 
                              name="description" 
                              rows="3"
                              placeholder="このノートの目的や投資方針を記述してください"
                              class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">{{ notebook.description }}</textarea>
                    {% if form.description.errors %}
                        <p class="text-red-400 text-sm mt-1">{{ form.description.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- ステータス -->
                <div>
                    <label for="id_status" class="block text-sm font-medium text-gray-300 mb-2">ステータス</label>
                    <select id="id_status" 
                            name="status"
                            class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="ACTIVE" {% if notebook.status == 'ACTIVE' %}selected{% endif %}>アクティブ</option>
                        <option value="MONITORING" {% if notebook.status == 'MONITORING' %}selected{% endif %}>監視中</option>
                        <option value="ATTENTION" {% if notebook.status == 'ATTENTION' %}selected{% endif %}>要注意</option>
                        <option value="ARCHIVED" {% if notebook.status == 'ARCHIVED' %}selected{% endif %}>アーカイブ</option>
                    </select>
                    {% if form.status.errors %}
                        <p class="text-red-400 text-sm mt-1">{{ form.status.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
        </section>

        <!-- 投資戦略セクション -->
        <section class="form-section bg-gray-800 border border-gray-700 rounded-lg p-8">
            <h2 class="text-xl font-semibold text-white mb-6 flex items-center">
                <svg class="h-6 w-6 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                </svg>
                選定基準・リスク要因
            </h2>

            <div class="space-y-6">
                <!-- 選定基準 -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">選定基準</label>
                    <div id="key-criteria-container">
                        {% for criteria in notebook.key_criteria %}
                            <div class="key-criteria-item flex gap-2 mb-2">
                                <input type="text" 
                                       name="key_criteria_{{ forloop.counter0 }}" 
                                       value="{{ criteria }}"
                                       placeholder="選定基準 {{ forloop.counter }}"
                                       class="flex-1 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button type="button" 
                                        onclick="window.NotebookEditor.removeCriteria(this)"
                                        class="px-3 py-2 text-red-400 hover:text-red-300 {% if forloop.first and notebook.key_criteria|length == 1 %}hidden{% endif %}">
                                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        {% empty %}
                            <div class="key-criteria-item flex gap-2 mb-2">
                                <input type="text" 
                                       name="key_criteria_0" 
                                       placeholder="選定基準 1"
                                       class="flex-1 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button type="button" 
                                        onclick="window.NotebookEditor.removeCriteria(this)"
                                        class="px-3 py-2 text-red-400 hover:text-red-300 hidden">
                                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                    <button type="button" 
                            onclick="window.NotebookEditor.addCriteria()"
                            class="text-blue-400 hover:text-blue-300 text-sm flex items-center">
                        <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        基準を追加
                    </button>
                </div>

                <!-- リスク要因 -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">リスク要因</label>
                    <div id="risk-factors-container">
                        {% for risk in notebook.risk_factors %}
                            <div class="risk-factor-item flex gap-2 mb-2">
                                <input type="text" 
                                       name="risk_factor_{{ forloop.counter0 }}" 
                                       value="{{ risk }}"
                                       placeholder="リスク要因 {{ forloop.counter }}"
                                       class="flex-1 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button type="button" 
                                        onclick="window.NotebookEditor.removeRiskFactor(this)"
                                        class="px-3 py-2 text-red-400 hover:text-red-300 {% if forloop.first and notebook.risk_factors|length == 1 %}hidden{% endif %}">
                                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        {% empty %}
                            <div class="risk-factor-item flex gap-2 mb-2">
                                <input type="text" 
                                       name="risk_factor_0" 
                                       placeholder="リスク要因 1"
                                       class="flex-1 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button type="button" 
                                        onclick="window.NotebookEditor.removeRiskFactor(this)"
                                        class="px-3 py-2 text-red-400 hover:text-red-300 hidden">
                                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        {% endfor %}
                    </div>
                    <button type="button" 
                            onclick="window.NotebookEditor.addRiskFactor()"
                            class="text-yellow-400 hover:text-yellow-300 text-sm flex items-center">
                        <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        リスクを追加
                    </button>
                </div>
            </div>
        </section>

        <!-- サブノート・タグ設定セクション -->
        <section class="form-section bg-gray-800 border border-gray-700 rounded-lg p-8">
            <h2 class="text-xl font-semibold text-white mb-6 flex items-center">
                <svg class="h-6 w-6 mr-2 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.99 1.99 0 013 12V7a2 2 0 012-2z"></path>
                </svg>
                サブノート・タグ設定
            </h2>

            <!-- サブノート設定 -->
            <div class="mb-8">
                <label class="block text-sm font-medium text-gray-300 mb-4">サブノート（章立て）</label>
                <div id="sub-notebooks-container">
                    {% for sub_notebook in notebook.sub_notebooks.all %}
                        <div class="sub-notebook-item flex gap-2 mb-2">
                            <input type="text" 
                                   name="sub_notebook_{{ forloop.counter0 }}" 
                                   value="{{ sub_notebook.title }}"
                                   placeholder="例: 日本株"
                                   class="flex-1 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="button" 
                                    onclick="window.NotebookEditor.removeSubNotebook(this)"
                                    class="px-3 py-2 text-red-400 hover:text-red-300 {% if forloop.first and notebook.sub_notebooks.count == 1 %}hidden{% endif %}">
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    {% empty %}
                        <div class="sub-notebook-item flex gap-2 mb-2">
                            <input type="text" 
                                   name="sub_notebook_0" 
                                   placeholder="例: 日本株"
                                   class="flex-1 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="button" 
                                    onclick="window.NotebookEditor.removeSubNotebook(this)"
                                    class="px-3 py-2 text-red-400 hover:text-red-300 hidden">
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" 
                        onclick="window.NotebookEditor.addSubNotebook()"
                        class="text-green-400 hover:text-green-300 text-sm flex items-center">
                    <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    サブノートを追加
                </button>
                <p class="text-xs text-gray-400 mt-2">サブノートを使ってノート内を分類できます（例：日本株、米国株）</p>
            </div>

            <!-- タグ設定 -->
            <div>
                <!-- カスタムタグ入力 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-300 mb-2">カスタムタグ</label>
                    <div class="flex gap-2">
                        <input type="text" 
                               id="custom-tag-input"
                               placeholder="#から始まるタグを入力..."
                               class="flex-1 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="button" 
                                onclick="window.NotebookEditor.addCustomTag()"
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            追加
                        </button>
                    </div>
                </div>

                <!-- 選択済みタグ -->
                <div id="selected-tags" class="mb-6">
                    <label class="block text-sm font-medium text-gray-300 mb-2">選択済みタグ</label>
                    <div id="selected-tags-container" class="flex flex-wrap gap-2 min-h-[2.5rem] p-3 bg-gray-700 border border-gray-600 rounded-lg">
                        {% for tag in notebook.tags.all %}
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-600 text-white">
                                {{ tag.name }}
                                <button type="button" 
                                        onclick="window.NotebookEditor.removeTag('{{ tag.name|escapejs }}')"
                                        class="ml-2 text-blue-200 hover:text-white">
                                    <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </span>
                        {% empty %}
                            <span class="text-gray-400 text-sm">タグが選択されていません</span>
                        {% endfor %}
                    </div>
                </div>

                <!-- AI推奨タグ -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                        <svg class="h-4 w-4 mr-1 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        AI推奨タグ
                    </label>
                    <div id="suggested-tags" class="flex flex-wrap gap-2">
                        <!-- AI推奨タグがここに動的に表示される -->
                    </div>
                </div>
            </div>

            <!-- 隠しフィールド -->
            <input type="hidden" name="selected_tags_json" id="selected-tags-json">
            <input type="hidden" name="key_criteria" id="key-criteria-hidden">
            <input type="hidden" name="risk_factors" id="risk-factors-hidden">
            <input type="hidden" name="sub_notebooks_json" id="sub-notebooks-hidden">
        </section>

        <!-- 統計情報 -->
        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                <svg class="h-5 w-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                ノート統計
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                <div class="bg-gray-700 p-3 rounded-lg">
                    <div class="text-2xl font-bold text-blue-400">{{ notebook.entry_count|default:0 }}</div>
                    <div class="text-sm text-gray-400">エントリー数</div>
                </div>
                <div class="bg-gray-700 p-3 rounded-lg">
                    <div class="text-2xl font-bold text-green-400">{{ notebook.tags.count|default:0 }}</div>
                    <div class="text-sm text-gray-400">タグ数</div>
                </div>
                <div class="bg-gray-700 p-3 rounded-lg">
                    <div class="text-2xl font-bold text-purple-400">{{ notebook.created_at|date:"m/d" }}</div>
                    <div class="text-sm text-gray-400">作成日</div>
                </div>
                <div class="bg-gray-700 p-3 rounded-lg">
                    <div class="text-2xl font-bold text-yellow-400">{{ notebook.updated_at|date:"m/d" }}</div>
                    <div class="text-sm text-gray-400">最終更新</div>
                </div>
            </div>
        </div>

        <!-- アクションボタン -->
        <div class="flex justify-between items-center pt-6 border-t border-gray-700">
            <a href="{% url 'notes:detail' notebook.pk %}" 
               class="px-6 py-3 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition-colors">
                キャンセル
            </a>
            
            <div class="flex gap-3">
                <button type="button" 
                        onclick="window.NotebookEditor.previewChanges()"
                        class="px-6 py-3 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition-colors">
                    変更をプレビュー
                </button>
                <button type="submit" 
                        class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center">
                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    変更を保存
                </button>
            </div>
        </div>
    </form>
</div>

<!-- プレビューモーダル -->
<div id="preview-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-gray-900 border border-gray-700 rounded-lg w-full max-w-3xl max-h-[80vh] overflow-hidden">
        <div class="flex items-center justify-between p-6 border-b border-gray-700">
            <h3 class="text-xl font-semibold text-white">変更プレビュー</h3>
            <button onclick="window.NotebookEditor.closePreview()" class="text-gray-400 hover:text-white">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div id="preview-content" class="p-6 overflow-y-auto max-h-[60vh]">
            <!-- プレビュー内容がここに表示される -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'js/common.js' %}"></script>
<script>
// ========================================
// ノート編集専用クラス（作成フォームと統一）
// ========================================

class NotebookEditor {
    constructor() {
        this.criteriaCount = {{ notebook.key_criteria|length|default:1 }};
        this.riskFactorCount = {{ notebook.risk_factors|length|default:1 }};
        this.subNotebookCount = {{ notebook.sub_notebooks.count|default:1 }};
        this.selectedTags = [];
        this.tagChanges = { added: [], removed: [] };
        
        this.init();
    }
    
    init() {
        console.log('NotebookEditor初期化開始');
        this.setupEventListeners();
        this.initializeExistingTags();
        this.updateRemoveButtons('key-criteria-item');
        this.updateRemoveButtons('risk-factor-item');
        this.updateRemoveButtons('sub-notebook-item');
        this.setupFormValidation();
        console.log('NotebookEditor初期化完了');
    }
    
    setupEventListeners() {
        // カスタムタグ入力のEnterキー対応
        const customTagInput = document.getElementById('custom-tag-input');
        if (customTagInput) {
            customTagInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.addCustomTag();
                }
            });
        }
    }
    
    initializeExistingTags() {
        // 既存タグを配列に設定
        const existingTagElements = document.querySelectorAll('#selected-tags-container span:not(.text-gray-400)');
        existingTagElements.forEach(element => {
            const tagName = element.textContent.trim();
            if (tagName && !this.selectedTags.includes(tagName)) {
                this.selectedTags.push(tagName);
            }
        });
        
        console.log('既存タグ初期化:', this.selectedTags);
        this.updateTagsHiddenField();
    }
    
    // ========================================
    // 動的項目管理
    // ========================================
    
    addCriteria() {
        console.log('基準追加');
        this.addDynamicItem('key-criteria-container', 'key-criteria-item', 'key_criteria', this.criteriaCount, '選定基準', 'removeCriteria');
        this.criteriaCount++;
        this.updateRemoveButtons('key-criteria-item');
    }
    
    addRiskFactor() {
        console.log('リスク要因追加');
        this.addDynamicItem('risk-factors-container', 'risk-factor-item', 'risk_factor', this.riskFactorCount, 'リスク要因', 'removeRiskFactor');
        this.riskFactorCount++;
        this.updateRemoveButtons('risk-factor-item');
    }
    
    addSubNotebook() {
        console.log('サブノート追加');
        this.addDynamicItem('sub-notebooks-container', 'sub-notebook-item', 'sub_notebook', this.subNotebookCount, 'サブノート', 'removeSubNotebook');
        this.subNotebookCount++;
        this.updateRemoveButtons('sub-notebook-item');
    }
    
    addDynamicItem(containerId, itemClass, namePrefix, count, placeholder, removeFunction, value = '') {
        const container = document.getElementById(containerId);
        if (!container) {
            console.error(`Container ${containerId} not found`);
            return;
        }
        
        const newItem = document.createElement('div');
        newItem.className = `${itemClass} flex gap-2 mb-2 animate-in`;
        newItem.innerHTML = `
            <input type="text" 
                   name="${namePrefix}_${count}" 
                   value="${this.escapeHtml(value)}"
                   placeholder="${placeholder} ${count + 1}"
                   class="flex-1 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button type="button" 
                    onclick="window.NotebookEditor.${removeFunction}(this)"
                    class="px-3 py-2 text-red-400 hover:text-red-300">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        `;
        container.appendChild(newItem);
        
        // フォーカスを新しい入力欄に移動
        const input = newItem.querySelector('input');
        if (input) {
            input.focus();
        }
    }
    
    removeCriteria(button) {
        button.closest('.key-criteria-item').remove();
        this.updateRemoveButtons('key-criteria-item');
    }
    
    removeRiskFactor(button) {
        button.closest('.risk-factor-item').remove();
        this.updateRemoveButtons('risk-factor-item');
    }
    
    removeSubNotebook(button) {
        button.closest('.sub-notebook-item').remove();
        this.updateRemoveButtons('sub-notebook-item');
    }
    
    updateRemoveButtons(className) {
        const items = document.querySelectorAll(`.${className}`);
        items.forEach((item, index) => {
            const removeButton = item.querySelector('button');
            if (removeButton) {
                if (items.length > 1) {
                    removeButton.classList.remove('hidden');
                } else {
                    removeButton.classList.add('hidden');
                }
            }
        });
    }
    
    // ========================================
    // タグ管理
    // ========================================
    
    addCustomTag() {
        const input = document.getElementById('custom-tag-input');
        if (!input) return;
        
        let tagName = input.value.trim();
        if (!tagName) {
            CommonUtils.showNotification('タグ名を入力してください', 'warning');
            return;
        }
        
        // #がない場合は自動で追加
        if (!tagName.startsWith('#')) {
            tagName = '#' + tagName;
        }
        
        // 重複チェック
        if (this.selectedTags.includes(tagName)) {
            CommonUtils.showNotification('このタグは既に選択されています', 'warning');
            return;
        }
        
        // タグを追加
        this.selectedTags.push(tagName);
        this.tagChanges.added.push(tagName);
        this.updateSelectedTagsDisplay();
        
        // 入力欄をクリア
        input.value = '';
        
        CommonUtils.showNotification(`タグ「${tagName}」を追加しました`, 'success');
    }
    
    removeTag(tagName) {
        const index = this.selectedTags.indexOf(tagName);
        if (index > -1) {
            this.selectedTags.splice(index, 1);
            
            // 追加リストから削除（新規追加タグの場合）
            const addedIndex = this.tagChanges.added.indexOf(tagName);
            if (addedIndex > -1) {
                this.tagChanges.added.splice(addedIndex, 1);
            } else {
                // 既存タグの場合は削除リストに追加
                this.tagChanges.removed.push(tagName);
            }
            
            this.updateSelectedTagsDisplay();
            CommonUtils.showNotification(`タグ「${tagName}」を削除しました`, 'info');
        }
    }
    
    updateSelectedTagsDisplay() {
        const container = document.getElementById('selected-tags-container');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (this.selectedTags.length === 0) {
            container.innerHTML = '<span class="text-gray-400 text-sm">タグが選択されていません</span>';
        } else {
            this.selectedTags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-600 text-white';
                tagElement.innerHTML = `
                    ${this.escapeHtml(tag)}
                    <button type="button" 
                            onclick="window.NotebookEditor.removeTag('${this.escapeHtml(tag)}')"
                            class="ml-2 text-blue-200 hover:text-white">
                        <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                `;
                container.appendChild(tagElement);
            });
        }
        
        // 隠しフィールドを更新
        this.updateTagsHiddenField();
    }
    
    updateTagsHiddenField() {
        const hiddenField = document.getElementById('selected-tags-json');
        if (hiddenField) {
            const tagData = {
                selected: this.selectedTags,
                changes: this.tagChanges
            };
            hiddenField.value = JSON.stringify(tagData);
        }
    }
    
    // ========================================
    // プレビュー機能
    // ========================================
    
    previewChanges() {
        console.log('変更プレビュー表示');
        const formData = this.collectFormData();
        const previewHtml = this.generatePreviewHtml(formData);
        
        document.getElementById('preview-content').innerHTML = previewHtml;
        document.getElementById('preview-modal').classList.remove('hidden');
    }
    
    closePreview() {
        document.getElementById('preview-modal').classList.add('hidden');
    }
    
    collectFormData() {
        const keyCriteria = Array.from(document.querySelectorAll('input[name^="key_criteria_"]'))
            .map(input => input.value)
            .filter(value => value.trim());
            
        const riskFactors = Array.from(document.querySelectorAll('input[name^="risk_factor_"]'))
            .map(input => input.value)
            .filter(value => value.trim());
            
        const subNotebooks = Array.from(document.querySelectorAll('input[name^="sub_notebook_"]'))
            .map(input => input.value)
            .filter(value => value.trim());

        return {
            title: document.getElementById('id_title').value,
            description: document.getElementById('id_description').value,
            notebookType: document.getElementById('id_notebook_type').value,
            status: document.getElementById('id_status').value,
            keyCriteria: keyCriteria,
            riskFactors: riskFactors,
            subNotebooks: subNotebooks,
            selectedTags: this.selectedTags
        };
    }
    
    generatePreviewHtml(data) {
        const statusLabels = {
            'ACTIVE': 'アクティブ',
            'MONITORING': '監視中',
            'ATTENTION': '要注意',
            'ARCHIVED': 'アーカイブ'
        };
        
        const typeLabels = {
            'THEME': 'テーマ型（複数銘柄）',
            'STOCK_FOCUSED': '銘柄特化型（1銘柄集中）',
            'PORTFOLIO': 'ポートフォリオ管理',
            'RESEARCH': '調査・研究'
        };
        
        const statusColors = {
            'ACTIVE': 'bg-green-900 text-green-300',
            'MONITORING': 'bg-yellow-900 text-yellow-300',
            'ATTENTION': 'bg-red-900 text-red-300',
            'ARCHIVED': 'bg-gray-700 text-gray-300'
        };
        
        return `
            <div class="space-y-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="text-xl font-semibold text-white">${this.escapeHtml(data.title)}</h4>
                        <span class="inline-block px-2 py-1 text-xs rounded bg-gray-600 text-gray-300 mt-1">${typeLabels[data.notebookType]}</span>
                    </div>
                    <span class="px-3 py-1 text-sm rounded ${statusColors[data.status]}">${statusLabels[data.status]}</span>
                </div>
                
                ${data.description ? `
                <div>
                    <h5 class="font-medium text-white mb-2">説明</h5>
                    <p class="text-gray-300">${this.escapeHtml(data.description)}</p>
                </div>
                ` : ''}
                
                ${data.keyCriteria.length > 0 ? `
                <div>
                    <h5 class="font-medium text-white mb-2">選定基準</h5>
                    <ul class="list-disc list-inside space-y-1 text-gray-300">
                        ${data.keyCriteria.map(criteria => `<li>${this.escapeHtml(criteria)}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
                
                ${data.riskFactors.length > 0 ? `
                <div>
                    <h5 class="font-medium text-white mb-2">リスク要因</h5>
                    <ul class="list-disc list-inside space-y-1 text-gray-300">
                        ${data.riskFactors.map(risk => `<li>${this.escapeHtml(risk)}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
                
                ${data.subNotebooks.length > 0 ? `
                <div>
                    <h5 class="font-medium text-white mb-2">サブノート</h5>
                    <div class="flex flex-wrap gap-2">
                        ${data.subNotebooks.map(sub => `<span class="px-2 py-1 bg-green-600 text-white text-sm rounded">${this.escapeHtml(sub)}</span>`).join('')}
                    </div>
                </div>
                ` : ''}
                
                <div>
                    <h5 class="font-medium text-white mb-2">タグ</h5>
                    <div class="flex flex-wrap gap-2">
                        ${data.selectedTags.map(tag => `<span class="px-2 py-1 bg-blue-600 text-white text-sm rounded">${this.escapeHtml(tag)}</span>`).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    // ========================================
    // フォーム検証
    // ========================================
    
    setupFormValidation() {
        const form = document.getElementById('notebook-form');
        if (!form) return;
        
        form.addEventListener('submit', (e) => {
            // 動的項目を隠しフィールドに設定
            const keyCriteria = Array.from(document.querySelectorAll('input[name^="key_criteria_"]'))
                .map(input => input.value)
                .filter(value => value.trim());
                
            const riskFactors = Array.from(document.querySelectorAll('input[name^="risk_factor_"]'))
                .map(input => input.value)
                .filter(value => value.trim());
                
            const subNotebooks = Array.from(document.querySelectorAll('input[name^="sub_notebook_"]'))
                .map(input => input.value)
                .filter(value => value.trim());
            
            document.getElementById('key-criteria-hidden').value = JSON.stringify(keyCriteria);
            document.getElementById('risk-factors-hidden').value = JSON.stringify(riskFactors);
            document.getElementById('sub-notebooks-hidden').value = JSON.stringify(subNotebooks);
            
            // タグデータを更新
            this.updateTagsHiddenField();
            
            // バリデーション
            let isValid = true;
            const requiredFields = ['id_title'];
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.classList.add('border-red-500');
                    isValid = false;
                } else {
                    field.classList.remove('border-red-500');
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                CommonUtils.showNotification('必須項目を入力してください', 'error');
            }
        });
    }
    
    // ========================================
    // ユーティリティ
    // ========================================
    
    escapeHtml(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.toString().replace(/[&<>"']/g, m => map[m]);
    }
}

// ========================================
// 初期化
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM読み込み完了（編集）');
    
    // グローバルインスタンスを作成
    window.NotebookEditor = new NotebookEditor();
    
    console.log('ノート編集システムが初期化されました');
});

// モーダル外クリックで閉じる
document.addEventListener('click', function(e) {
    if (e.target.id === 'preview-modal') {
        window.NotebookEditor.closePreview();
    }
});

// ESCキーでモーダルを閉じる
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        window.NotebookEditor.closePreview();
    }
});
</script>
{% endblock %}