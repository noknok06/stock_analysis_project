<!-- ========================================
templates/notes/create.html - è¦‹ç›´ã—ç‰ˆï¼ˆãƒ†ãƒ¼ãƒå˜ä½ãƒãƒ¼ãƒˆå¯¾å¿œï¼‰
======================================== -->

{% extends 'base.html' %}

{% block title %}æ–°è¦ãƒãƒ¼ãƒˆä½œæˆ - æ ªå¼åˆ†æè¨˜éŒ²ã‚¢ãƒ—ãƒª{% endblock %}

{% block extra_css %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/tag-manager.css' %}">
<style>
    .template-card {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
    }
    .template-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    .template-card.selected {
        border-color: #3b82f6;
        background-color: rgba(59, 130, 246, 0.1);
    }
    .form-section {
        background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
    }
    .step-indicator {
        background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
    }
    .animate-in {
        animation: slideInFromLeft 0.3s ease-out;
    }
    @keyframes slideInFromLeft {
        from { transform: translateX(-10px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center space-x-4 mb-4">
            <a href="{% url 'notes:list' %}" 
               class="text-gray-400 hover:text-white transition-colors">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </a>
            <h1 class="text-3xl font-bold text-white">æ–°è¦ãƒãƒ¼ãƒˆä½œæˆ</h1>
            <!-- ğŸ‘‡ ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³ã‚’è¿½åŠ  -->
            <a href="{% url 'notes:help' %}" 
            target="_blank"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors">
                <span>â“</span>
                <span>è¨˜å…¥ã‚¬ã‚¤ãƒ‰</span>
            </a>
        </div>
        <p class="text-gray-400">æŠ•è³‡ãƒ†ãƒ¼ãƒã«æ²¿ã£ãŸãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ã€è¤‡æ•°éŠ˜æŸ„ã®åˆ†æã‚’ä½“ç³»çš„ã«ç®¡ç†ã—ã¾ã—ã‚‡ã†</p>
    </div>

    <!-- Progress Steps -->
    <div class="mb-8">
        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
                <div class="step-indicator w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold">1</div>
                <span class="text-white font-medium">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ</span>
            </div>
            <div class="h-1 w-16 bg-gray-700 rounded"></div>
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 text-sm font-bold">2</div>
                <span class="text-gray-400">åŸºæœ¬è¨­å®š</span>
            </div>
            <div class="h-1 w-16 bg-gray-700 rounded"></div>
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-gray-400 text-sm font-bold">3</div>
                <span class="text-gray-400">æˆ¦ç•¥ãƒ»ã‚¿ã‚°è¨­å®š</span>
            </div>
        </div>
    </div>

    <!-- Form -->
    <form method="POST" id="notebook-form" class="space-y-8">
        {% csrf_token %}
        <input type="hidden" id="selected-template" name="template">
        
        <!-- åŸºæœ¬æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section class="form-section bg-gray-800 border border-gray-700 rounded-lg p-8">
            <h2 class="text-xl font-semibold text-white mb-6 flex items-center">
                <svg class="h-6 w-6 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-6m-2-5.5V9.5a2 2 0 012-2h6a2 2 0 012 2V16"></path>
                </svg>
                åŸºæœ¬æƒ…å ±
            </h2>
            
            <div class="space-y-6">
                <!-- ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ— -->
                <div>
                    <label for="id_notebook_type" class="block text-sm font-medium text-gray-300 mb-2">ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒ—</label>
                    <select id="id_notebook_type" 
                            name="notebook_type"
                            class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="THEME">ãƒ†ãƒ¼ãƒå‹ï¼ˆè¤‡æ•°éŠ˜æŸ„ï¼‰</option>
                        <option value="STOCK_FOCUSED">éŠ˜æŸ„ç‰¹åŒ–å‹ï¼ˆ1éŠ˜æŸ„é›†ä¸­ï¼‰</option>
                        <option value="PORTFOLIO">ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªç®¡ç†</option>
                        <option value="RESEARCH">èª¿æŸ»ãƒ»ç ”ç©¶</option>
                    </select>
                </div>

                <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
                <div>
                    <label for="id_title" class="block text-sm font-medium text-gray-300 mb-2">
                        ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒˆãƒ« <span class="text-red-400">*</span>
                    </label>
                    <input type="text" 
                           id="id_title" 
                           name="title" 
                           required
                           placeholder="ä¾‹: 2025å¹´ é«˜é…å½“æ ªã‚¦ã‚©ãƒƒãƒ"
                           class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    {% if form.title.errors %}
                        <p class="text-red-400 text-sm mt-1">{{ form.title.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ« -->
                <div>
                    <label for="id_subtitle" class="block text-sm font-medium text-gray-300 mb-2">ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" 
                           id="id_subtitle" 
                           name="subtitle" 
                           placeholder="ä¾‹: é…å½“åˆ©å›ã‚Š3%ä»¥ä¸Šã®å®‰å®šéŠ˜æŸ„ã‚’é¸å®š"
                           class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- èª¬æ˜ -->
                <div>
                    <label for="id_description" class="block text-sm font-medium text-gray-300 mb-2">ãƒãƒ¼ãƒˆã®èª¬æ˜</label>
                    <textarea id="id_description" 
                              name="description" 
                              rows="3"
                              placeholder="ã“ã®ãƒãƒ¼ãƒˆã®ç›®çš„ã‚„æŠ•è³‡æ–¹é‡ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„"
                              class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>

                <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
                <div>
                    <label for="id_status" class="block text-sm font-medium text-gray-300 mb-2">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                    <select id="id_status" 
                            name="status"
                            class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="ACTIVE">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</option>
                        <option value="MONITORING">ç›£è¦–ä¸­</option>
                        <option value="ATTENTION">è¦æ³¨æ„</option>
                        <option value="ARCHIVED">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- æŠ•è³‡æˆ¦ç•¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section class="form-section bg-gray-800 border border-gray-700 rounded-lg p-8">
            <h2 class="text-xl font-semibold text-white mb-6 flex items-center">
                <svg class="h-6 w-6 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                </svg>
                æŠ•è³‡æˆ¦ç•¥ãƒ»ãƒ†ãƒ¼ãƒ
            </h2>

            <div class="space-y-6">
                <!-- æŠ•è³‡æˆ¦ç•¥ -->
                <div>
                    <label for="id_investment_strategy" class="block text-sm font-medium text-gray-300 mb-2">
                        æŠ•è³‡æˆ¦ç•¥ <span class="text-red-400">*</span>
                    </label>
                    <textarea id="id_investment_strategy" 
                              name="investment_strategy" 
                              required
                              rows="4"
                              placeholder="ã“ã®ãƒ†ãƒ¼ãƒã§ã®æŠ•è³‡æˆ¦ç•¥ã‚„æ–¹é‡ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„"
                              class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    {% if form.investment_strategy.errors %}
                        <p class="text-red-400 text-sm mt-1">{{ form.investment_strategy.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- ç›®æ¨™é…åˆ† -->
                <div>
                    <label for="id_target_allocation" class="block text-sm font-medium text-gray-300 mb-2">ç›®æ¨™é…åˆ†</label>
                    <input type="text" 
                           id="id_target_allocation" 
                           name="target_allocation" 
                           placeholder="ä¾‹: ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã®30%ã€æœˆé¡3ä¸‡å††"
                           class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- é¸å®šåŸºæº– -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">é¸å®šåŸºæº–</label>
                    <div id="key-criteria-container">
                        <div class="key-criteria-item flex gap-2 mb-2">
                            <input type="text" 
                                   name="key_criteria_0" 
                                   placeholder="é¸å®šåŸºæº– 1"
                                   class="flex-1 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="button" 
                                    onclick="removeCriteria(this)"
                                    class="px-3 py-2 text-red-400 hover:text-red-300 hidden">
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button type="button" 
                            onclick="addCriteria()"
                            class="text-blue-400 hover:text-blue-300 text-sm flex items-center">
                        <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        åŸºæº–ã‚’è¿½åŠ 
                    </button>
                </div>

                <!-- ãƒªã‚¹ã‚¯è¦å›  -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">ãƒªã‚¹ã‚¯è¦å› </label>
                    <div id="risk-factors-container">
                        <div class="risk-factor-item flex gap-2 mb-2">
                            <input type="text" 
                                   name="risk_factor_0" 
                                   placeholder="ãƒªã‚¹ã‚¯è¦å›  1"
                                   class="flex-1 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="button" 
                                    onclick="removeRiskFactor(this)"
                                    class="px-3 py-2 text-red-400 hover:text-red-300 hidden">
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button type="button" 
                            onclick="addRiskFactor()"
                            class="text-yellow-400 hover:text-yellow-300 text-sm flex items-center">
                        <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        ãƒªã‚¹ã‚¯ã‚’è¿½åŠ 
                    </button>
                </div>
            </div>
        </section>

        <!-- ã‚µãƒ–ãƒãƒ¼ãƒˆãƒ»ã‚¿ã‚°è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <section class="form-section bg-gray-800 border border-gray-700 rounded-lg p-8">
            <h2 class="text-xl font-semibold text-white mb-6 flex items-center">
                <svg class="h-6 w-6 mr-2 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.99 1.99 0 013 12V7a2 2 0 012-2z"></path>
                </svg>
                ã‚µãƒ–ãƒãƒ¼ãƒˆãƒ»ã‚¿ã‚°è¨­å®š
            </h2>

            <!-- ã‚µãƒ–ãƒãƒ¼ãƒˆè¨­å®š -->
            <div class="mb-8">
                <label class="block text-sm font-medium text-gray-300 mb-4">ã‚µãƒ–ãƒãƒ¼ãƒˆï¼ˆç« ç«‹ã¦ï¼‰</label>
                <div id="sub-notebooks-container">
                    <div class="sub-notebook-item flex gap-2 mb-2">
                        <input type="text" 
                               name="sub_notebook_0" 
                               placeholder="ä¾‹: æ—¥æœ¬æ ª"
                               class="flex-1 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="button" 
                                onclick="removeSubNotebook(this)"
                                class="px-3 py-2 text-red-400 hover:text-red-300 hidden">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <button type="button" 
                        onclick="addSubNotebook()"
                        class="text-green-400 hover:text-green-300 text-sm flex items-center">
                    <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    ã‚µãƒ–ãƒãƒ¼ãƒˆã‚’è¿½åŠ 
                </button>
                <p class="text-xs text-gray-400 mt-2">ã‚µãƒ–ãƒãƒ¼ãƒˆã‚’ä½¿ã£ã¦ãƒãƒ¼ãƒˆå†…ã‚’åˆ†é¡ã§ãã¾ã™ï¼ˆä¾‹ï¼šæ—¥æœ¬æ ªã€ç±³å›½æ ªï¼‰</p>
            </div>

            <!-- ã‚¿ã‚°è¨­å®š -->
            <div>
                <!-- ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚°å…¥åŠ› -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-300 mb-2">ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚°</label>
                    <div class="flex gap-2">
                        <input type="text" 
                               id="custom-tag-input"
                               placeholder="#ã‹ã‚‰å§‹ã¾ã‚‹ã‚¿ã‚°ã‚’å…¥åŠ›..."
                               class="flex-1 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="button" 
                                onclick="addCustomTag()"
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            è¿½åŠ 
                        </button>
                    </div>
                </div>

                <!-- é¸æŠæ¸ˆã¿ã‚¿ã‚° -->
                <div id="selected-tags" class="mb-6">
                    <label class="block text-sm font-medium text-gray-300 mb-2">é¸æŠæ¸ˆã¿ã‚¿ã‚°</label>
                    <div id="selected-tags-container" class="flex flex-wrap gap-2 min-h-[2.5rem] p-3 bg-gray-700 border border-gray-600 rounded-lg">
                        <span class="text-gray-400 text-sm">ã‚¿ã‚°ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</span>
                    </div>
                </div>

                <!-- AIæ¨å¥¨ã‚¿ã‚° -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                        <svg class="h-4 w-4 mr-1 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        AIæ¨å¥¨ã‚¿ã‚°
                    </label>
                    <div id="suggested-tags" class="flex flex-wrap gap-2">
                        <!-- AIæ¨å¥¨ã‚¿ã‚°ãŒã“ã“ã«å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                </div>
            </div>

            <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
            <input type="hidden" name="selected_tags_json" id="selected-tags-json">
            <input type="hidden" name="key_criteria" id="key-criteria-hidden">
            <input type="hidden" name="risk_factors" id="risk-factors-hidden">
            <input type="hidden" name="sub_notebooks_json" id="sub-notebooks-hidden">
        </section>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
        <div class="flex justify-between items-center pt-6 border-t border-gray-700">
            <a href="{% url 'notes:list' %}" 
               class="px-6 py-3 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition-colors">
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </a>
            
            <div class="flex gap-3">
                <button type="button" 
                        onclick="previewNotebook()"
                        class="px-6 py-3 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition-colors">
                    ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                </button>
                <button type="submit" 
                        class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center">
                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    ãƒãƒ¼ãƒˆã‚’ä½œæˆ
                </button>
            </div>
        </div>
    </form>
</div>

<!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="preview-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-gray-900 border border-gray-700 rounded-lg w-full max-w-3xl max-h-[80vh] overflow-hidden">
        <div class="flex items-center justify-between p-6 border-b border-gray-700">
            <h3 class="text-xl font-semibold text-white">ãƒãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
            <button onclick="closePreview()" class="text-gray-400 hover:text-white">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div id="preview-content" class="p-6 overflow-y-auto max-h-[60vh]">
            <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'js/tag-manager.js' %}"></script>
<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let criteriaCount = 1;
let riskFactorCount = 1;
let subNotebookCount = 1;
let tagManager = null;
let selectedTemplate = null;

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    // ã‚¿ã‚°ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–
    tagManager = initTagManager({
        selectedTagsContainer: 'selected-tags-container',
        suggestedTagsContainer: 'suggested-tags',
        tagInput: 'custom-tag-input',
        tagChangesInput: 'selected-tags-json'
    });
    
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ã®è¨­å®š
    setupTemplateCards();
    
    // ãã®ä»–ã®åˆæœŸåŒ–
    updateRemoveButtons('key-criteria-item');
    updateRemoveButtons('risk-factor-item');
    updateRemoveButtons('sub-notebook-item');
    setupFormValidation();
});

// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰è¨­å®š
function setupTemplateCards() {
    const templateCards = document.querySelectorAll('.template-card');
    
    templateCards.forEach(card => {
        card.addEventListener('click', function() {
            // å…¨ã¦ã®ã‚«ãƒ¼ãƒ‰ã‹ã‚‰é¸æŠçŠ¶æ…‹ã‚’å‰Šé™¤
            templateCards.forEach(c => c.classList.remove('selected'));
            
            // é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            this.classList.add('selected');
            
            const templateId = this.dataset.template;
            selectedTemplate = templateId === 'custom' ? null : templateId;
            
            // éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
            document.getElementById('selected-template').value = selectedTemplate || '';
            
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨
            if (templateId !== 'custom') {
                applyTemplateData(this.dataset);
            } else {
                clearTemplateData();
            }
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            showTemplatePreview(this.dataset);
        });
    });
}

// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨
function applyTemplateData(templateData) {
    if (templateData.title) {
        document.getElementById('id_title').value = templateData.title;
    }
    
    if (templateData.strategy) {
        document.getElementById('id_investment_strategy').value = templateData.strategy;
    }
    
    // é¸å®šåŸºæº–ã‚’é©ç”¨
    if (templateData.criteria) {
        try {
            const criteria = JSON.parse(templateData.criteria);
            applyCriteriaToForm(criteria);
        } catch (e) {
            console.error('åŸºæº–ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', e);
        }
    }
    
    // ã‚µãƒ–ãƒãƒ¼ãƒˆã‚’é©ç”¨
    if (templateData.subNotebooks) {
        try {
            const subNotebooks = JSON.parse(templateData.subNotebooks);
            applySubNotebooksToForm(subNotebooks);
        } catch (e) {
            console.error('ã‚µãƒ–ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', e);
        }
    }
    
    // ã‚¿ã‚°ã‚’é©ç”¨
    if (templateData.tags && tagManager) {
        try {
            const tags = JSON.parse(templateData.tags);
            tags.forEach(tag => {
                if (!tagManager.selectedTags.includes(tag)) {
                    tagManager.addTag(tag);
                }
            });
        } catch (e) {
            console.error('ã‚¿ã‚°ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', e);
        }
    }
}

// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
function clearTemplateData() {
    document.getElementById('id_title').value = '';
    document.getElementById('id_investment_strategy').value = '';
    
    // åŸºæº–ã¨ãƒªã‚¹ã‚¯è¦å› ã‚’ã‚¯ãƒªã‚¢
    clearDynamicItems('key-criteria-container', 'key-criteria-item');
    clearDynamicItems('risk-factors-container', 'risk-factor-item');
    clearDynamicItems('sub-notebooks-container', 'sub-notebook-item');
    
    // ã‚¿ã‚°ã‚’ã‚¯ãƒªã‚¢
    if (tagManager) {
        tagManager.selectedTags = [];
        tagManager.updateSelectedTagsDisplay();
    }
}

// å‹•çš„é …ç›®ã‚’ã‚¯ãƒªã‚¢
function clearDynamicItems(containerId, itemClass) {
    const container = document.getElementById(containerId);
    const items = container.querySelectorAll(`.${itemClass}`);
    
    // æœ€åˆã®é …ç›®ä»¥å¤–ã‚’å‰Šé™¤
    for (let i = 1; i < items.length; i++) {
        items[i].remove();
    }
    
    // æœ€åˆã®é …ç›®ã®å€¤ã‚’ã‚¯ãƒªã‚¢
    if (items.length > 0) {
        const input = items[0].querySelector('input');
        if (input) input.value = '';
    }
}

// åŸºæº–ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«é©ç”¨
function applyCriteriaToForm(criteria) {
    const container = document.getElementById('key-criteria-container');
    container.innerHTML = '';
    
    criteria.forEach((criterion, index) => {
        addDynamicItem('key-criteria-container', 'key-criteria-item', 'key_criteria', index, 'é¸å®šåŸºæº–', 'removeCriteria', criterion);
    });
    
    criteriaCount = criteria.length;
    updateRemoveButtons('key-criteria-item');
}

// ã‚µãƒ–ãƒãƒ¼ãƒˆã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«é©ç”¨
function applySubNotebooksToForm(subNotebooks) {
    const container = document.getElementById('sub-notebooks-container');
    container.innerHTML = '';
    
    subNotebooks.forEach((subNotebook, index) => {
        addDynamicItem('sub-notebooks-container', 'sub-notebook-item', 'sub_notebook', index, 'ã‚µãƒ–ãƒãƒ¼ãƒˆ', 'removeSubNotebook', subNotebook);
    });
    
    subNotebookCount = subNotebooks.length;
    updateRemoveButtons('sub-notebook-item');
}

// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
function showTemplatePreview(templateData) {
    const preview = document.getElementById('template-preview');
    const content = document.getElementById('template-content');
    
    if (templateData.template === 'custom') {
        preview.classList.add('hidden');
        return;
    }
    
    let previewHtml = '';
    
    if (templateData.title) {
        previewHtml += `<p><strong>ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¤ãƒˆãƒ«:</strong> ${templateData.title}</p>`;
    }
    
    if (templateData.strategy) {
        previewHtml += `<p><strong>æ¨å¥¨æˆ¦ç•¥:</strong> ${templateData.strategy}</p>`;
    }
    
    if (templateData.subNotebooks) {
        try {
            const subNotebooks = JSON.parse(templateData.subNotebooks);
            previewHtml += `<p><strong>æ¨å¥¨ã‚µãƒ–ãƒãƒ¼ãƒˆ:</strong> ${subNotebooks.join(', ')}</p>`;
        } catch (e) {}
    }
    
    if (templateData.tags) {
        try {
            const tags = JSON.parse(templateData.tags);
            previewHtml += `<p><strong>æ¨å¥¨ã‚¿ã‚°:</strong> ${tags.join(', ')}</p>`;
        } catch (e) {}
    }
    
    content.innerHTML = previewHtml;
    preview.classList.remove('hidden');
}

// å‹•çš„é …ç›®ç®¡ç†ï¼ˆDRYåŸå‰‡é©ç”¨ï¼‰
function addCriteria() {
    addDynamicItem('key-criteria-container', 'key-criteria-item', 'key_criteria', criteriaCount, 'é¸å®šåŸºæº–', 'removeCriteria');
    criteriaCount++;
    updateRemoveButtons('key-criteria-item');
}

function addRiskFactor() {
    addDynamicItem('risk-factors-container', 'risk-factor-item', 'risk_factor', riskFactorCount, 'ãƒªã‚¹ã‚¯è¦å› ', 'removeRiskFactor');
    riskFactorCount++;
    updateRemoveButtons('risk-factor-item');
}

function addSubNotebook() {
    addDynamicItem('sub-notebooks-container', 'sub-notebook-item', 'sub_notebook', subNotebookCount, 'ã‚µãƒ–ãƒãƒ¼ãƒˆ', 'removeSubNotebook');
    subNotebookCount++;
    updateRemoveButtons('sub-notebook-item');
}

function addDynamicItem(containerId, itemClass, namePrefix, count, placeholder, removeFunction, value = '') {
    const container = document.getElementById(containerId);
    const newItem = document.createElement('div');
    newItem.className = `${itemClass} flex gap-2 mb-2 animate-in`;
    newItem.innerHTML = `
        <input type="text" 
               name="${namePrefix}_${count}" 
               value="${value}"
               placeholder="${placeholder} ${count + 1}"
               class="flex-1 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <button type="button" 
                onclick="${removeFunction}(this)"
                class="px-3 py-2 text-red-400 hover:text-red-300">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    `;
    container.appendChild(newItem);
}

function removeCriteria(button) {
    button.closest('.key-criteria-item').remove();
    updateRemoveButtons('key-criteria-item');
}

function removeRiskFactor(button) {
    button.closest('.risk-factor-item').remove();
    updateRemoveButtons('risk-factor-item');
}

function removeSubNotebook(button) {
    button.closest('.sub-notebook-item').remove();
    updateRemoveButtons('sub-notebook-item');
}

function updateRemoveButtons(className) {
    const items = document.querySelectorAll(`.${className}`);
    items.forEach((item, index) => {
        const removeButton = item.querySelector('button');
        if (items.length > 1) {
            removeButton.classList.remove('hidden');
        } else {
            removeButton.classList.add('hidden');
        }
    });
}

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
function previewNotebook() {
    const formData = collectFormData();
    const previewHtml = generatePreviewHtml(formData);
    
    document.getElementById('preview-content').innerHTML = previewHtml;
    document.getElementById('preview-modal').classList.remove('hidden');
}

function closePreview() {
    document.getElementById('preview-modal').classList.add('hidden');
}

function collectFormData() {
    const keyCriteria = Array.from(document.querySelectorAll('input[name^="key_criteria_"]'))
        .map(input => input.value)
        .filter(value => value.trim());
        
    const riskFactors = Array.from(document.querySelectorAll('input[name^="risk_factor_"]'))
        .map(input => input.value)
        .filter(value => value.trim());
        
    const subNotebooks = Array.from(document.querySelectorAll('input[name^="sub_notebook_"]'))
        .map(input => input.value)
        .filter(value => value.trim());

    return {
        title: document.getElementById('id_title').value,
        subtitle: document.getElementById('id_subtitle').value,
        description: document.getElementById('id_description').value,
        notebookType: document.getElementById('id_notebook_type').value,
        investmentStrategy: document.getElementById('id_investment_strategy').value,
        targetAllocation: document.getElementById('id_target_allocation').value,
        status: document.getElementById('id_status').value,
        keyCriteria: keyCriteria,
        riskFactors: riskFactors,
        subNotebooks: subNotebooks,
        selectedTags: tagManager ? tagManager.selectedTags : []
    };
}

function generatePreviewHtml(data) {
    const statusLabels = {
        'ACTIVE': 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–',
        'MONITORING': 'ç›£è¦–ä¸­',
        'ATTENTION': 'è¦æ³¨æ„',
        'ARCHIVED': 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–'
    };
    
    const typeLabels = {
        'THEME': 'ãƒ†ãƒ¼ãƒå‹ï¼ˆè¤‡æ•°éŠ˜æŸ„ï¼‰',
        'STOCK_FOCUSED': 'éŠ˜æŸ„ç‰¹åŒ–å‹ï¼ˆ1éŠ˜æŸ„é›†ä¸­ï¼‰',
        'PORTFOLIO': 'ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªç®¡ç†',
        'RESEARCH': 'èª¿æŸ»ãƒ»ç ”ç©¶'
    };
    
    return `
        <div class="space-y-6">
            <div class="flex items-center justify-between">
                <div>
                    <h4 class="text-xl font-semibold text-white">${data.title}</h4>
                    ${data.subtitle ? `<p class="text-gray-400">${data.subtitle}</p>` : ''}
                    <span class="inline-block px-2 py-1 text-xs rounded bg-gray-600 text-gray-300 mt-1">${typeLabels[data.notebookType]}</span>
                </div>
                <span class="px-3 py-1 text-sm rounded bg-blue-600 text-white">${statusLabels[data.status]}</span>
            </div>
            
            ${data.description ? `
            <div>
                <h5 class="font-medium text-white mb-2">èª¬æ˜</h5>
                <p class="text-gray-300">${data.description}</p>
            </div>
            ` : ''}
            
            <div>
                <h5 class="font-medium text-white mb-2">æŠ•è³‡æˆ¦ç•¥</h5>
                <p class="text-gray-300">${data.investmentStrategy}</p>
            </div>
            
            ${data.targetAllocation ? `
            <div>
                <h5 class="font-medium text-white mb-2">ç›®æ¨™é…åˆ†</h5>
                <p class="text-green-400 font-semibold">${data.targetAllocation}</p>
            </div>
            ` : ''}
            
            ${data.keyCriteria.length > 0 ? `
            <div>
                <h5 class="font-medium text-white mb-2">é¸å®šåŸºæº–</h5>
                <ul class="list-disc list-inside space-y-1 text-gray-300">
                    ${data.keyCriteria.map(criteria => `<li>${criteria}</li>`).join('')}
                </ul>
            </div>
            ` : ''}
            
            ${data.riskFactors.length > 0 ? `
            <div>
                <h5 class="font-medium text-white mb-2">ãƒªã‚¹ã‚¯è¦å› </h5>
                <ul class="list-disc list-inside space-y-1 text-gray-300">
                    ${data.riskFactors.map(risk => `<li>${risk}</li>`).join('')}
                </ul>
            </div>
            ` : ''}
            
            ${data.subNotebooks.length > 0 ? `
            <div>
                <h5 class="font-medium text-white mb-2">ã‚µãƒ–ãƒãƒ¼ãƒˆ</h5>
                <div class="flex flex-wrap gap-2">
                    ${data.subNotebooks.map(sub => `<span class="px-2 py-1 bg-green-600 text-white text-sm rounded">${sub}</span>`).join('')}
                </div>
            </div>
            ` : ''}
            
            <div>
                <h5 class="font-medium text-white mb-2">ã‚¿ã‚°</h5>
                <div class="flex flex-wrap gap-2">
                    ${data.selectedTags.map(tag => `<span class="px-2 py-1 bg-blue-600 text-white text-sm rounded">${tag}</span>`).join('')}
                </div>
            </div>
        </div>
    `;
}

// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‰ã®å‡¦ç†
function setupFormValidation() {
    const form = document.getElementById('notebook-form');
    form.addEventListener('submit', function(e) {
        // å‹•çš„é …ç›®ã‚’éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
        const keyCriteria = Array.from(document.querySelectorAll('input[name^="key_criteria_"]'))
            .map(input => input.value)
            .filter(value => value.trim());
            
        const riskFactors = Array.from(document.querySelectorAll('input[name^="risk_factor_"]'))
            .map(input => input.value)
            .filter(value => value.trim());
            
        const subNotebooks = Array.from(document.querySelectorAll('input[name^="sub_notebook_"]'))
            .map(input => input.value)
            .filter(value => value.trim());
        
        document.getElementById('key-criteria-hidden').value = JSON.stringify(keyCriteria);
        document.getElementById('risk-factors-hidden').value = JSON.stringify(riskFactors);
        document.getElementById('sub-notebooks-hidden').value = JSON.stringify(subNotebooks);
        
        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        let isValid = true;
        const requiredFields = ['id_title', 'id_investment_strategy'];
        
        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (!field.value.trim()) {
                field.classList.add('border-red-500');
                isValid = false;
            } else {
                field.classList.remove('border-red-500');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            if (tagManager) {
                tagManager.showNotification('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
            }
        }
    });
}

// ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚°è¿½åŠ é–¢æ•°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰
function addCustomTag() {
    if (tagManager) {
        tagManager.addCustomTag();
    }
}
</script>
{% endblock %}