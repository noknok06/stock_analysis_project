<!-- ========================================
templates/notes/detail.html - 更新版（サブノート・ブックマーク機能完全実装）
======================================== -->

{% extends 'base.html' %}

{% block title %}{{ notebook.title }} - 株式分析記録アプリ{% endblock %}

{% block extra_css %}
<style>
    .entry-card {
        transition: all 0.2s ease-in-out;
    }
    .entry-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    .sub-notebook-tab {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
    }
    .sub-notebook-tab.active {
        background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
    }
    .sub-notebook-tab:hover:not(.active) {
        background-color: rgba(75, 85, 99, 0.5);
    }
    .stats-card {
        background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        border: 1px solid #374151;
    }
    .filter-chip {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
    }
    .filter-chip.active {
        background-color: #3b82f6;
        color: white;
    }
    .filter-chip:hover:not(.active) {
        background-color: rgba(75, 85, 99, 0.7);
    }
    .favorite-star {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
    }
    .favorite-star.active {
        color: #fbbf24;
    }
    .bookmark-icon {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
    }
    .bookmark-icon.active {
        color: #3b82f6;
    }
    
    /* アニメーション */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .entry-card {
        animation: fadeIn 0.3s ease-out;
    }
    
    /* 通知スタイル */
    .notification {
        backdrop-filter: blur(8px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    /* タッチデバイス用の調整 */
    @media (max-width: 768px) {
        .entry-card {
            margin-bottom: 0.75rem;
        }
        
        /* タップ領域を確保 */
        button, .cursor-pointer {
            min-height: 44px;
            min-width: 44px;
        }
        
        .sub-notebook-tab {
            min-height: 36px;
            padding: 0.25rem 0.75rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-2 sm:px-4" data-notebook-id="{{ notebook.pk }}">
    <!-- ノートヘッダー -->
    <div class="bg-gray-800 border border-gray-700 rounded-lg mb-6 md:mb-8">
        <div class="p-4 md:p-6 border-b border-gray-700">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-0 mb-4">
                <div class="flex items-center space-x-3 md:space-x-4 min-w-0 flex-1">
                    <a href="{% url 'notes:list' %}" 
                       title="ノート一覧に戻る"
                       class="text-gray-400 hover:text-white transition-colors flex-shrink-0">
                        <svg class="h-5 w-5 md:h-6 md:w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </a>
                    <div class="min-w-0 flex-1">
                        <div class="flex items-center gap-2">
                            <h1 class="text-xl md:text-2xl font-bold text-white truncate">{{ notebook.title }}</h1>
                            <button onclick="toggleFavorite()" 
                                    title="お気に入り切り替え"
                                    class="favorite-star text-gray-400 hover:text-yellow-400 {% if notebook.is_favorite %}active{% endif %}">
                                <svg class="h-5 w-5" fill="{% if notebook.is_favorite %}currentColor{% else %}none{% endif %}" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                </svg>
                            </button>
                        </div>
                        {% if notebook.subtitle %}
                            <p class="text-sm md:text-base text-gray-400 truncate">{{ notebook.subtitle }}</p>
                        {% endif %}
                        <span class="inline-block px-2 py-1 text-xs rounded bg-gray-600 text-gray-300 mt-1">
                            {{ notebook.get_notebook_type_display }}
                        </span>
                    </div>
                </div>
                
                <div class="flex items-center space-x-2 md:space-x-3">
                    <span class="px-2 md:px-3 py-1 text-xs md:text-sm rounded-full 
                               {% if notebook.status == 'ACTIVE' %}bg-green-900 text-green-300
                               {% elif notebook.status == 'MONITORING' %}bg-yellow-900 text-yellow-300
                               {% elif notebook.status == 'ATTENTION' %}bg-red-900 text-red-300
                               {% else %}bg-gray-700 text-gray-300{% endif %}">
                        <span class="hidden sm:inline">{{ notebook.get_status_display }}</span>
                        <span class="sm:hidden">
                            {% if notebook.status == 'ACTIVE' %}●
                            {% elif notebook.status == 'MONITORING' %}⚠
                            {% elif notebook.status == 'ATTENTION' %}⚠
                            {% else %}○{% endif %}
                        </span>
                    </span>
                    
                    <button onclick="openNewEntryModal()" 
                            title="新規エントリー作成"
                            class="inline-flex items-center px-2 md:px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        <svg class="h-4 w-4 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        <span class="hidden md:inline ml-2">新規エントリー</span>
                    </button>
                    
                    <a href="{% url 'notes:edit' notebook.pk %}" 
                       title="ノート編集"
                       class="inline-flex items-center px-2 md:px-4 py-2 border border-gray-600 text-gray-300 hover:bg-gray-700 rounded-lg transition-colors">
                        <svg class="h-4 w-4 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        <span class="hidden md:inline ml-2">編集</span>
                    </a>
                </div>
            </div>
            
            <!-- 統計情報 -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-4">
                <div class="stats-card p-3 md:p-4 rounded-lg text-center">
                    <div class="text-lg md:text-2xl font-bold text-blue-400">{{ stats.total_entries }}</div>
                    <div class="text-xs md:text-sm text-gray-400">総エントリー数</div>
                </div>
                <div class="stats-card p-3 md:p-4 rounded-lg text-center">
                    <div class="text-lg md:text-2xl font-bold text-green-400">{{ stats.stock_count }}</div>
                    <div class="text-xs md:text-sm text-gray-400">銘柄数</div>
                </div>
                <div class="stats-card p-3 md:p-4 rounded-lg text-center">
                    <div class="text-lg md:text-2xl font-bold text-purple-400">{{ stats.recent_entries }}</div>
                    <div class="text-xs md:text-sm text-gray-400">今週の記録</div>
                </div>
                <div class="stats-card p-3 md:p-4 rounded-lg text-center">
                    <div class="text-lg md:text-2xl font-bold text-yellow-400">{{ stats.important_entries }}</div>
                    <div class="text-xs md:text-sm text-gray-400">重要記録</div>
                </div>
            </div>
            
            <!-- 投資戦略表示 -->
            {% if notebook.investment_strategy %}
                <div class="bg-gray-700 p-4 rounded-lg mb-4">
                    <h3 class="text-sm font-medium text-white mb-2 flex items-center">
                        <svg class="h-4 w-4 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                        投資戦略
                    </h3>
                    <p class="text-sm text-gray-300">{{ notebook.investment_strategy|truncatewords:30 }}</p>
                </div>
            {% endif %}
            
            <!-- タグ -->
            {% if notebook.tags.all %}
                <div class="flex flex-wrap gap-1 md:gap-2">
                    {% for tag in notebook.tags.all %}
                        <span class="px-1 md:px-2 py-1 text-xs border border-gray-600 text-gray-300 rounded hover:bg-gray-700 cursor-pointer transition-colors truncate max-w-24 sm:max-w-none">
                            {{ tag.name }}
                        </span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- フィルター・サブノートタブ -->
    <div class="bg-gray-800 border border-gray-700 rounded-lg mb-4 md:mb-6">
        <div class="p-4 md:p-6">
            <!-- サブノートタブ -->
            {% if sub_notebooks %}
                <div class="mb-4">
                    <h3 class="text-sm font-medium text-gray-300 mb-3">サブノート</h3>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterBySubNotebook('')" 
                                class="sub-notebook-tab px-3 py-2 text-sm rounded-lg bg-gray-700 text-gray-300 active"
                                data-sub-notebook="">
                            すべて
                        </button>
                        {% for sub_notebook in sub_notebooks %}
                            <button onclick="filterBySubNotebook('{{ sub_notebook.pk }}')" 
                                    class="sub-notebook-tab px-3 py-2 text-sm rounded-lg bg-gray-700 text-gray-300"
                                    data-sub-notebook="{{ sub_notebook.pk }}">
                                {{ sub_notebook.title }}
                            </button>
                        {% endfor %}
                        <button onclick="openSubNotebookCreateModal()" 
                                title="サブノート追加"
                                class="px-3 py-2 text-sm rounded-lg border border-gray-600 text-gray-400 hover:text-white hover:border-blue-500 transition-colors">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            {% endif %}
            
            <!-- その他のフィルター -->
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-0">
                <div class="flex flex-wrap gap-2">
                    <!-- エントリータイプフィルター -->
                    <select id="entry-type-filter" class="bg-gray-700 border border-gray-600 text-white rounded px-2 md:px-3 py-1 text-xs md:text-sm">
                        <option value="">すべてのタイプ</option>
                        <option value="ANALYSIS">決算分析</option>
                        <option value="NEWS">ニュース</option>
                        <option value="CALCULATION">計算結果</option>
                        <option value="MEMO">メモ</option>
                        <option value="GOAL">投資目標</option>
                        <option value="EARNINGS">決算発表</option>
                        <option value="IR_EVENT">IRイベント</option>
                        <option value="MARKET_EVENT">市場イベント</option>
                    </select>
                    
                    <!-- 銘柄フィルター -->
                    {% if stocks %}
                        <select id="stock-filter" class="bg-gray-700 border border-gray-600 text-white rounded px-2 md:px-3 py-1 text-xs md:text-sm">
                            <option value="">すべての銘柄</option>
                            {% for stock in stocks %}
                                <option value="{{ stock.stock_code }}">
                                    {% if stock.stock_code and stock.company_name %}
                                        {{ stock.stock_code }} {{ stock.company_name }}
                                    {% elif stock.stock_code %}
                                        {{ stock.stock_code }}
                                    {% else %}
                                        {{ stock.company_name }}
                                    {% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    {% endif %}
                    
                    <!-- 重要フラグフィルター -->
                    <button onclick="toggleImportantFilter()" 
                            id="important-filter"
                            class="filter-chip px-3 py-1 text-xs md:text-sm rounded border border-gray-600 text-gray-300">
                        <svg class="h-3 w-3 md:h-4 md:w-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                        </svg>
                        重要
                    </button>
                    
                    <!-- ブックマークフィルター -->
                    <button onclick="toggleBookmarkFilter()" 
                            id="bookmark-filter"
                            class="filter-chip px-3 py-1 text-xs md:text-sm rounded border border-gray-600 text-gray-300">
                        <svg class="h-3 w-3 md:h-4 md:w-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                        </svg>
                        ブックマーク
                    </button>
                </div>
                
                <!-- ソート -->
                <div class="flex items-center space-x-2">
                    <span class="text-xs md:text-sm text-gray-400">並び順:</span>
                    <select id="sort-order" class="bg-gray-700 border border-gray-600 text-white rounded px-2 py-1 text-xs md:text-sm">
                        <option value="newest">新しい順</option>
                        <option value="oldest">古い順</option>
                        <option value="important">重要度順</option>
                        <option value="stock">銘柄順</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- エントリー一覧 -->
    <div class="space-y-4 md:space-y-6">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-0">
            <h2 class="text-lg md:text-xl font-semibold text-white flex items-center">
                <svg class="h-4 w-4 md:h-5 md:w-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
                <span class="hidden sm:inline">記録エントリー</span>
                <span class="sm:hidden">記録</span>
                <span class="ml-2 text-gray-400 text-sm md:text-base font-normal" id="entries-count">({{ entries.count }}件)</span>
            </h2>
        </div>
        
        {% if entries %}
            <!-- エントリーカード -->
            <div class="space-y-3 md:space-y-4" id="entries-container">
                {% for entry in entries %}
                    <div class="entry-card bg-gray-800 border border-gray-700 rounded-lg overflow-hidden cursor-pointer hover:bg-gray-750 transition-colors"
                         data-entry-type="{{ entry.entry_type }}"
                         data-entry-id="{{ entry.pk }}"
                         data-stock-code="{{ entry.stock_code }}"
                         data-sub-notebook="{{ entry.sub_notebook.pk|default:'' }}"
                         data-important="{{ entry.is_important|yesno:'true,false' }}"
                         data-bookmarked="{{ entry.is_bookmarked|yesno:'true,false' }}"
                         data-created="{{ entry.created_at|date:'Y-m-d' }}"
                         onclick="handleEntryCardClick('{{ entry.pk }}')">
                        <div class="p-4 md:p-6">
                            <!-- エントリーヘッダー -->
                            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-0 mb-4">
                                <div class="flex items-center space-x-3 min-w-0 flex-1">
                                    <div class="p-2 rounded-lg flex-shrink-0 {% if entry.entry_type == 'ANALYSIS' %}bg-blue-900 text-blue-300{% elif entry.entry_type == 'NEWS' %}bg-green-900 text-green-300{% elif entry.entry_type == 'CALCULATION' %}bg-orange-900 text-orange-300{% elif entry.entry_type == 'MEMO' %}bg-gray-700 text-gray-300{% elif entry.entry_type == 'EARNINGS' %}bg-purple-900 text-purple-300{% elif entry.entry_type == 'IR_EVENT' %}bg-indigo-900 text-indigo-300{% elif entry.entry_type == 'MARKET_EVENT' %}bg-pink-900 text-pink-300{% else %}bg-yellow-900 text-yellow-300{% endif %}">
                                        <!-- アイコンは既存のコードと同じ -->
                                        <svg class="h-4 w-4 md:h-5 md:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                        </svg>
                                    </div>
                                    <div class="min-w-0 flex-1">
                                        <div class="flex items-center gap-2">
                                            <h3 class="text-base md:text-lg font-semibold text-white truncate">{{ entry.title }}</h3>
                                            {% if entry.is_important %}
                                                <svg class="h-4 w-4 text-yellow-400 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                                </svg>
                                            {% endif %}
                                            {% if entry.is_bookmarked %}
                                                <svg class="h-4 w-4 text-blue-400 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                                                </svg>
                                            {% endif %}
                                        </div>
                                        <div class="text-xs md:text-sm text-gray-400 mt-1">
                                            <span class="hidden sm:inline">{{ entry.get_entry_type_display }}</span>
                                            <span class="sm:hidden">
                                                {% if entry.entry_type == 'ANALYSIS' %}分析
                                                {% elif entry.entry_type == 'NEWS' %}ニュース
                                                {% elif entry.entry_type == 'CALCULATION' %}計算
                                                {% elif entry.entry_type == 'MEMO' %}メモ
                                                {% elif entry.entry_type == 'EARNINGS' %}決算
                                                {% elif entry.entry_type == 'IR_EVENT' %}IR
                                                {% elif entry.entry_type == 'MARKET_EVENT' %}市場
                                                {% else %}目標{% endif %}
                                            </span>
                                            {% if entry.stock_code or entry.company_name %}
                                                • {{ entry.get_stock_display }}
                                            {% endif %}
                                            {% if entry.sub_notebook %}
                                                • {{ entry.sub_notebook.title }}
                                            {% endif %}
                                            • {{ entry.created_at|date:"m/d H:i" }}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex items-center space-x-1 sm:space-x-2 flex-shrink-0">
                                    {% if entry.tags.all %}
                                        <div class="flex space-x-1">
                                            {% for tag in entry.tags.all|slice:":2" %}
                                                <span class="px-1 md:px-2 py-1 text-xs bg-gray-700 text-gray-300 rounded truncate max-w-16 sm:max-w-none">{{ tag.name }}</span>
                                            {% endfor %}
                                            {% if entry.tags.count > 2 %}
                                                <span class="px-1 md:px-2 py-1 text-xs bg-gray-700 text-gray-300 rounded">+{{ entry.tags.count|add:"-2" }}</span>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                    
                                    <!-- エントリーアクション -->
                                    <div class="flex items-center space-x-1" onclick="event.stopPropagation()">
                                        <button onclick="toggleEntryBookmark('{{ entry.pk }}')" 
                                                title="ブックマーク切り替え"
                                                class="bookmark-icon p-1 text-gray-400 hover:text-blue-400 {% if entry.is_bookmarked %}active{% endif %}">
                                            <svg class="h-4 w-4" fill="{% if entry.is_bookmarked %}currentColor{% else %}none{% endif %}" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- エントリー内容プレビュー -->
                            <div class="text-sm md:text-base text-gray-300">
                                {% if entry.entry_type == 'ANALYSIS' and entry.content.summary %}
                                    <p class="mb-2"><strong>サマリー:</strong> {{ entry.content.summary|truncatewords:30 }}</p>
                                {% elif entry.entry_type == 'NEWS' and entry.content.headline %}
                                    <p class="mb-2"><strong>ヘッドライン:</strong> {{ entry.content.headline }}</p>
                                {% elif entry.entry_type == 'CALCULATION' and entry.content.current_price %}
                                    <p class="mb-2"><strong>現在株価:</strong> {{ entry.content.current_price }}</p>
                                {% elif entry.entry_type == 'MEMO' and entry.content.observation %}
                                    <p class="mb-2">{{ entry.content.observation|truncatewords:30 }}</p>
                                {% endif %}
                                
                                <!-- エントリー内容の詳細を表示 -->
                                <div class="mt-2 md:mt-3 text-xs md:text-sm text-gray-400">
                                    クリックして詳細を表示...
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <!-- ページネーション -->
            {% if is_paginated %}
                <div class="flex items-center justify-center space-x-2 md:space-x-4 mt-8">
                    <button onclick="previousPage()" 
                            {% if not page_obj.has_previous %}disabled{% endif %}
                            title="前のページ"
                            class="px-2 md:px-4 py-2 bg-gray-800 border border-gray-700 text-white rounded hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        <svg class="h-4 w-4 md:mr-1 md:inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        <span class="hidden md:inline ml-1">前のページ</span>
                    </button>
                    
                    <div class="flex items-center space-x-2">
                        <span class="text-gray-400 text-xs md:text-sm">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
                    </div>
                    
                    <button onclick="nextPage()" 
                            {% if not page_obj.has_next %}disabled{% endif %}
                            title="次のページ"
                            class="px-2 md:px-4 py-2 bg-gray-800 border border-gray-700 text-white rounded hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        <span class="hidden md:inline mr-1">次のページ</span>
                        <svg class="h-4 w-4 md:ml-1 md:inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            {% endif %}
        {% else %}
            <!-- エントリーなしの場合 -->
            <div class="text-center py-12 md:py-16">
                <div class="mx-auto h-16 w-16 md:h-24 md:w-24 text-gray-600 mb-4">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <h3 class="text-base md:text-lg font-medium text-gray-400 mb-2">まだエントリーがありません</h3>
                <p class="text-sm md:text-base text-gray-500 mb-6">最初の分析記録を作成しましょう</p>
                <button onclick="openNewEntryModal()" 
                        class="inline-flex items-center px-4 md:px-6 py-2 md:py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
                    <svg class="h-4 w-4 md:h-5 md:w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    <span class="hidden sm:inline">最初のエントリーを作成</span>
                    <span class="sm:hidden">エントリー作成</span>
                </button>
            </div>
        {% endif %}
    </div>
</div>

<!-- 既存のモーダルは省略（新規エントリーモーダル、エントリー詳細モーダル、サブノート作成モーダル） -->

<!-- エントリー詳細モーダル -->
<div id="entry-detail-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-2 md:p-4">
    <div class="bg-gray-900 border border-gray-700 rounded-lg w-full max-w-4xl max-h-[95vh] md:max-h-[90vh] overflow-hidden">
        <div class="flex items-center justify-between p-4 md:p-6 border-b border-gray-700">
            <h3 class="text-lg md:text-xl font-semibold text-white" id="entry-detail-title">エントリー詳細</h3>
            <button onclick="closeEntryDetail()" class="text-gray-400 hover:text-white p-2">
                <svg class="h-5 w-5 md:h-6 md:w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div id="entry-detail-content" class="p-4 md:p-6 overflow-y-auto max-h-[calc(95vh-120px)] md:max-h-[60vh]">
            <!-- エントリー詳細内容がここに表示される -->
        </div>
    </div>
</div>

<!-- エントリー詳細モーダル -->
<div id="entry-detail-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-2 md:p-4">
    <div class="bg-gray-900 border border-gray-700 rounded-lg w-full max-w-4xl max-h-[95vh] md:max-h-[90vh] overflow-hidden">
        <div class="flex items-center justify-between p-4 md:p-6 border-b border-gray-700">
            <h3 class="text-lg md:text-xl font-semibold text-white" id="entry-detail-title">エントリー詳細</h3>
            <button onclick="closeEntryDetail()" class="text-gray-400 hover:text-white p-2">
                <svg class="h-5 w-5 md:h-6 md:w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div id="entry-detail-content" class="p-4 md:p-6 overflow-y-auto max-h-[calc(95vh-120px)] md:max-h-[60vh]">
            <!-- エントリー詳細内容がここに表示される -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- CSRFトークンを取得 -->
{% csrf_token %}

<script>
// ========================================
// グローバル変数
// ========================================
let selectedEntryType = null;
let currentFilters = {
    subNotebook: '',
    entryType: '',
    stockCode: '',
    isImportant: false,
    isBookmarked: false
};

// ========================================
// 初期化
// ========================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('ノート詳細ページが初期化されました');
    
    // フィルター機能の初期化
    setupFilters();
    
    // URLパラメータからフィルターを復元
    restoreFiltersFromUrl();
});

// ========================================
// サブノート・フィルター機能
// ========================================

// フィルター機能の設定
function setupFilters() {
    // エントリータイプフィルター
    const entryTypeFilter = document.getElementById('entry-type-filter');
    if (entryTypeFilter) {
        entryTypeFilter.addEventListener('change', function() {
            currentFilters.entryType = this.value;
            applyFilters();
            updateUrl();
        });
    }
    
    // 銘柄フィルター
    const stockFilter = document.getElementById('stock-filter');
    if (stockFilter) {
        stockFilter.addEventListener('change', function() {
            currentFilters.stockCode = this.value;
            applyFilters();
            updateUrl();
        });
    }
    
    // ソート機能
    const sortOrder = document.getElementById('sort-order');
    if (sortOrder) {
        sortOrder.addEventListener('change', function() {
            applySorting(this.value);
        });
    }
}

// サブノートでフィルタリング
function filterBySubNotebook(subNotebookId) {
    console.log('サブノートフィルター:', subNotebookId);
    
    currentFilters.subNotebook = subNotebookId;
    
    // タブの見た目を更新
    document.querySelectorAll('.sub-notebook-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.subNotebook === subNotebookId) {
            tab.classList.add('active');
        }
    });
    
    applyFilters();
    updateUrl();
}

// 重要フラグフィルター切り替え
function toggleImportantFilter() {
    const button = document.getElementById('important-filter');
    currentFilters.isImportant = !currentFilters.isImportant;
    
    if (currentFilters.isImportant) {
        button.classList.add('active');
        button.classList.remove('border-gray-600', 'text-gray-300');
        button.classList.add('border-yellow-500', 'bg-yellow-900/30', 'text-yellow-300');
    } else {
        button.classList.remove('active');
        button.classList.add('border-gray-600', 'text-gray-300');
        button.classList.remove('border-yellow-500', 'bg-yellow-900/30', 'text-yellow-300');
    }
    
    applyFilters();
    updateUrl();
}

// ブックマークフィルター切り替え
function toggleBookmarkFilter() {
    const button = document.getElementById('bookmark-filter');
    currentFilters.isBookmarked = !currentFilters.isBookmarked;
    
    if (currentFilters.isBookmarked) {
        button.classList.add('active');
        button.classList.remove('border-gray-600', 'text-gray-300');
        button.classList.add('border-blue-500', 'bg-blue-900/30', 'text-blue-300');
    } else {
        button.classList.remove('active');
        button.classList.add('border-gray-600', 'text-gray-300');
        button.classList.remove('border-blue-500', 'bg-blue-900/30', 'text-blue-300');
    }
    
    applyFilters();
    updateUrl();
}

// フィルターを適用
function applyFilters() {
    const entries = document.querySelectorAll('.entry-card');
    let visibleCount = 0;
    
    entries.forEach(entry => {
        let isVisible = true;
        
        // サブノートフィルター
        if (currentFilters.subNotebook && 
            entry.dataset.subNotebook !== currentFilters.subNotebook) {
            isVisible = false;
        }
        
        // エントリータイプフィルター
        if (currentFilters.entryType && 
            entry.dataset.entryType !== currentFilters.entryType) {
            isVisible = false;
        }
        
        // 銘柄フィルター
        if (currentFilters.stockCode && 
            entry.dataset.stockCode !== currentFilters.stockCode) {
            isVisible = false;
        }
        
        // 重要フラグフィルター
        if (currentFilters.isImportant && 
            entry.dataset.important !== 'true') {
            isVisible = false;
        }
        
        // ブックマークフィルター
        if (currentFilters.isBookmarked && 
            entry.dataset.bookmarked !== 'true') {
            isVisible = false;
        }
        
        // 表示/非表示の設定
        if (isVisible) {
            entry.style.display = 'block';
            visibleCount++;
        } else {
            entry.style.display = 'none';
        }
    });
    
    // エントリー数を更新
    updateEntriesCount(visibleCount);
    
    console.log(`フィルター適用完了: ${visibleCount}件表示`);
}

// ソート機能
function applySorting(sortType) {
    const container = document.getElementById('entries-container');
    if (!container) return;
    
    const entries = Array.from(container.querySelectorAll('.entry-card'));
    
    entries.sort((a, b) => {
        switch (sortType) {
            case 'oldest':
                return new Date(a.dataset.created) - new Date(b.dataset.created);
            case 'important':
                // 重要度順（重要なものを先に）
                const aImportant = a.dataset.important === 'true';
                const bImportant = b.dataset.important === 'true';
                if (aImportant && !bImportant) return -1;
                if (!aImportant && bImportant) return 1;
                // 同じ重要度の場合は日付順
                return new Date(b.dataset.created) - new Date(a.dataset.created);
            case 'stock':
                const aStock = a.dataset.stockCode || '';
                const bStock = b.dataset.stockCode || '';
                return aStock.localeCompare(bStock);
            case 'newest':
            default:
                return new Date(b.dataset.created) - new Date(a.dataset.created);
        }
    });
    
    // DOMに再挿入
    entries.forEach(entry => container.appendChild(entry));
    
    console.log('ソート完了:', sortType);
}

// エントリー数表示を更新
function updateEntriesCount(count) {
    const countElement = document.getElementById('entries-count');
    if (countElement) {
        countElement.textContent = `(${count}件)`;
    }
}

// URLパラメータを更新
function updateUrl() {
    const url = new URL(window.location);
    
    // 現在のフィルターをURLに反映
    if (currentFilters.subNotebook) {
        url.searchParams.set('sub_notebook', currentFilters.subNotebook);
    } else {
        url.searchParams.delete('sub_notebook');
    }
    
    if (currentFilters.entryType) {
        url.searchParams.set('entry_type', currentFilters.entryType);
    } else {
        url.searchParams.delete('entry_type');
    }
    
    if (currentFilters.stockCode) {
        url.searchParams.set('stock_code', currentFilters.stockCode);
    } else {
        url.searchParams.delete('stock_code');
    }
    
    // 履歴を更新（ページをリロードしない）
    window.history.replaceState({}, '', url.toString());
}

// URLパラメータからフィルターを復元
function restoreFiltersFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // サブノートフィルター復元
    const subNotebook = urlParams.get('sub_notebook');
    if (subNotebook) {
        filterBySubNotebook(subNotebook);
    }
    
    // エントリータイプフィルター復元
    const entryType = urlParams.get('entry_type');
    if (entryType) {
        const filter = document.getElementById('entry-type-filter');
        if (filter) {
            filter.value = entryType;
            currentFilters.entryType = entryType;
        }
    }
    
    // 銘柄フィルター復元
    const stockCode = urlParams.get('stock_code');
    if (stockCode) {
        const filter = document.getElementById('stock-filter');
        if (filter) {
            filter.value = stockCode;
            currentFilters.stockCode = stockCode;
        }
    }
    
    // フィルターを適用
    if (subNotebook || entryType || stockCode) {
        applyFilters();
    }
}

// ========================================
// ブックマーク・お気に入り機能
// ========================================

// エントリーブックマーク切り替え
function toggleEntryBookmark(entryId) {
    console.log('エントリーブックマーク切り替え:', entryId);
    
    // ボタンを無効化（重複クリック防止）
    const button = document.querySelector(`[onclick="toggleEntryBookmark('${entryId}')"]`);
    if (button) {
        button.disabled = true;
    }
    
    fetch(`/notes/entry/${entryId}/bookmark/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ボタンの見た目を更新
            updateBookmarkButton(entryId, data.is_bookmarked);
            
            // エントリーカードのデータ属性を更新
            const entryCard = document.querySelector(`[data-entry-id="${entryId}"]`);
            if (entryCard) {
                entryCard.dataset.bookmarked = data.is_bookmarked.toString();
            }
            
            // 成功メッセージを表示
            showNotification(data.message, 'success');
            
            // ブックマークフィルターが有効な場合はフィルターを再適用
            if (currentFilters.isBookmarked) {
                applyFilters();
            }
        } else {
            throw new Error(data.error || 'ブックマーク更新に失敗しました');
        }
    })
    .catch(error => {
        console.error('ブックマーク更新エラー:', error);
        showNotification(error.message, 'error');
    })
    .finally(() => {
        // ボタンを有効化
        if (button) {
            button.disabled = false;
        }
    });
}

// ノートお気に入り切り替え
function toggleFavorite() {
    const notebookId = getNotebookId(); // ページからノートブックIDを取得
    console.log('ノートお気に入り切り替え:', notebookId);
    
    // ボタンを無効化
    const button = document.querySelector('.favorite-star');
    if (button) {
        button.style.pointerEvents = 'none';
    }
    
    fetch(`/notes/${notebookId}/favorite/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ボタンの見た目を更新
            updateFavoriteButton(data.is_favorite);
            
            // 成功メッセージを表示
            showNotification(data.message, 'success');
        } else {
            throw new Error(data.error || 'お気に入り更新に失敗しました');
        }
    })
    .catch(error => {
        console.error('お気に入り更新エラー:', error);
        showNotification(error.message, 'error');
    })
    .finally(() => {
        // ボタンを有効化
        if (button) {
            button.style.pointerEvents = 'auto';
        }
    });
}

// ブックマークボタンの見た目を更新
function updateBookmarkButton(entryId, isBookmarked) {
    const button = document.querySelector(`[onclick="toggleEntryBookmark('${entryId}')"]`);
    if (!button) return;
    
    const svg = button.querySelector('svg');
    if (!svg) return;
    
    if (isBookmarked) {
        button.classList.add('active');
        svg.setAttribute('fill', 'currentColor');
    } else {
        button.classList.remove('active');
        svg.setAttribute('fill', 'none');
    }
}

// お気に入りボタンの見た目を更新
function updateFavoriteButton(isFavorite) {
    const button = document.querySelector('.favorite-star');
    if (!button) return;
    
    const svg = button.querySelector('svg');
    if (!svg) return;
    
    if (isFavorite) {
        button.classList.add('active');
        svg.setAttribute('fill', 'currentColor');
    } else {
        button.classList.remove('active');
        svg.setAttribute('fill', 'none');
    }
}

// ========================================
// ユーティリティ関数
// ========================================

// CSRFトークンを取得
function getCsrfToken() {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }
    
    // フォームからも取得を試行
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfInput) {
        return csrfInput.value;
    }
    
    return '';
}

// ノートブックIDを取得（URLまたはページ要素から）
function getNotebookId() {
    // データ属性から取得
    const notebookElement = document.querySelector('[data-notebook-id]');
    if (notebookElement) {
        return notebookElement.dataset.notebookId;
    }
    
    // URLパスから取得 (/notes/{notebook_id}/)
    const pathParts = window.location.pathname.split('/');
    const notesIndex = pathParts.indexOf('notes');
    if (notesIndex !== -1 && pathParts[notesIndex + 1]) {
        return pathParts[notesIndex + 1];
    }
    
    console.error('ノートブックIDが取得できませんでした');
    return null;
}

// 通知表示
function showNotification(message, type = 'info') {
    // 既存の通知を削除
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => notification.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification fixed top-4 right-4 z-50 p-4 rounded-lg text-white max-w-sm transform transition-all duration-300 translate-x-full opacity-0`;
    
    const typeClasses = {
        'error': 'bg-red-600',
        'warning': 'bg-yellow-600',
        'success': 'bg-green-600',
        'info': 'bg-blue-600'
    };
    
    notification.classList.add(typeClasses[type] || typeClasses.info);
    
    notification.innerHTML = `
        <div class="flex items-start justify-between">
            <div class="flex">
                <div class="mr-3 mt-0.5">
                    ${getNotificationIcon(type)}
                </div>
                <div>
                    <p class="text-sm font-medium">${escapeHtml(message)}</p>
                </div>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" 
                    class="ml-3 text-white/80 hover:text-white">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // アニメーション
    setTimeout(() => {
        notification.classList.remove('translate-x-full', 'opacity-0');
    }, 100);
    
    // 自動削除
    setTimeout(() => {
        if (notification.parentNode) {
            notification.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 300);
        }
    }, 4000);
}

// 通知アイコンを取得
function getNotificationIcon(type) {
    const icons = {
        'success': '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',
        'error': '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',
        'warning': '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>',
        'info': '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
    };
    return icons[type] || icons.info;
}

// HTMLエスケープ
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

// エントリーカードクリック処理
function handleEntryCardClick(entryId) {
    console.log('エントリーカードクリック:', entryId);
    openEntryDetail(entryId);
}

// エントリー詳細表示
function openEntryDetail(entryId) {
    console.log('エントリー詳細表示:', entryId);
    
    // 詳細表示の実装（既存のコードを使用）
    // ここでは簡単な実装のみ
    showNotification(`エントリー詳細: ${entryId}`, 'info');
}

// モーダル関連の関数（簡略版）
function openNewEntryModal() {
    showNotification('新規エントリーモーダルを開きます', 'info');
}

// ページネーション関数
function previousPage() {
    const currentUrl = new URL(window.location);
    const currentPage = parseInt(currentUrl.searchParams.get('page') || '1');
    if (currentPage > 1) {
        currentUrl.searchParams.set('page', currentPage - 1);
        window.location.href = currentUrl.toString();
    }
}

function nextPage() {
    const currentUrl = new URL(window.location);
    const currentPage = parseInt(currentUrl.searchParams.get('page') || '1');
    currentUrl.searchParams.set('page', currentPage + 1);
    window.location.href = currentUrl.toString();
}

// ESCキーでモーダルを閉じる
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        // モーダル閉じる処理
        console.log('ESCキーが押されました');
    }
});
// ========================================
// モーダル管理クラス（共通化）
// ========================================
class ModalManager {
    constructor() {
        this.openModals = new Set();
        this.setupGlobalListeners();
    }
    
    setupGlobalListeners() {
        // ESCキーでモーダルを閉じる
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.openModals.size > 0) {
                this.closeLastModal();
            }
        });
        
        // モーダル外クリックで閉じる
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-backdrop')) {
                this.closeModal(e.target.querySelector('.modal-content')?.id || 'unknown');
            }
        });
    }
    
    openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) {
            console.error(`モーダル ${modalId} が見つかりません`);
            return false;
        }
        
        modal.classList.remove('hidden');
        this.openModals.add(modalId);
        
        // ページのスクロールを無効化
        document.body.style.overflow = 'hidden';
        
        // フォーカス管理
        this.setModalFocus(modal);
        
        console.log(`モーダル ${modalId} を開きました`);
        return true;
    }
    
    closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) {
            console.error(`モーダル ${modalId} が見つかりません`);
            return false;
        }
        
        modal.classList.add('hidden');
        this.openModals.delete(modalId);
        
        // 他にモーダルが開いていない場合のみスクロールを有効化
        if (this.openModals.size === 0) {
            document.body.style.overflow = '';
        }
        
        console.log(`モーダル ${modalId} を閉じました`);
        return true;
    }
    
    closeLastModal() {
        if (this.openModals.size > 0) {
            const lastModal = Array.from(this.openModals).pop();
            this.closeModal(lastModal);
        }
    }
    
    setModalFocus(modal) {
        setTimeout(() => {
            const firstInput = modal.querySelector('input, textarea, select, button');
            if (firstInput) {
                firstInput.focus();
            }
        }, 100);
    }
    
    resetForm(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        
        const forms = modal.querySelectorAll('form');
        forms.forEach(form => form.reset());
        
        // カスタムリセット処理
        const customResetElements = modal.querySelectorAll('[data-reset]');
        customResetElements.forEach(element => {
            const resetType = element.dataset.reset;
            switch (resetType) {
                case 'innerHTML':
                    element.innerHTML = '';
                    break;
                case 'value':
                    element.value = '';
                    break;
                case 'selected':
                    element.classList.remove('selected', 'active');
                    break;
            }
        });
    }
}

// グローバルモーダルマネージャーのインスタンス
const modalManager = new ModalManager();

// ========================================
// 新規エントリーモーダル機能
// ========================================

function openNewEntryModal() {
    console.log('新規エントリーモーダルを開きます');
    
    if (modalManager.openModal('new-entry-modal')) {
        // フォームをリセット
        resetEntryForm();
    }
}

function closeNewEntryModal() {
    console.log('新規エントリーモーダルを閉じます');
    modalManager.closeModal('new-entry-modal');
    resetEntryForm();
}

function resetEntryForm() {
    const form = document.getElementById('entry-form');
    if (form) {
        form.reset();
    }
    
    const typeForm = document.getElementById('entry-type-form');
    if (typeForm) {
        typeForm.innerHTML = '';
    }
    
    selectedEntryType = null;
    
    // エントリータイプボタンをリセット
    document.querySelectorAll('.entry-type-btn').forEach(btn => {
        btn.classList.remove('selected', 'border-blue-500', 'bg-blue-900/30');
        btn.classList.add('border-gray-600', 'bg-gray-700');
    });
    
    // 隠しフィールドをクリア
    const hiddenFields = ['entry_type'];
    hiddenFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) field.value = '';
    });
}

// ========================================
// エントリー詳細モーダル機能
// ========================================

function openEntryDetail(entryId) {
    console.log('エントリー詳細表示:', entryId);
    
    if (!modalManager.openModal('entry-detail-modal')) {
        return;
    }
    
    // ローディング表示
    updateEntryDetailModal('読み込み中...', '<div class="flex items-center justify-center py-8"><div class="text-gray-400">読み込み中...</div></div>');
    
    // エントリー詳細をAjaxで取得して表示
    fetch(`/notes/entry/${entryId}/`)
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('エントリー詳細取得成功:', data);
            if (data.success) {
                updateEntryDetailModal(data.title, data.html);
            } else {
                throw new Error(data.error || 'データの取得に失敗しました');
            }
        })
        .catch(error => {
            console.error('エントリー詳細取得エラー:', error);
            const errorHtml = `
                <div class="text-center py-8">
                    <div class="text-red-400 mb-2">エントリーの詳細を取得できませんでした</div>
                    <div class="text-gray-400 text-sm">${escapeHtml(error.message)}</div>
                    <button onclick="closeEntryDetail()" class="mt-4 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded">
                        閉じる
                    </button>
                </div>
            `;
            updateEntryDetailModal('エラー', errorHtml);
        });
}

function closeEntryDetail() {
    console.log('エントリー詳細モーダルを閉じます');
    modalManager.closeModal('entry-detail-modal');
}

function updateEntryDetailModal(title, content) {
    const titleElement = document.getElementById('entry-detail-title');
    const contentElement = document.getElementById('entry-detail-content');
    
    if (titleElement) titleElement.textContent = title;
    if (contentElement) contentElement.innerHTML = content;
}

// ========================================
// サブノート作成モーダル機能
// ========================================

function openSubNotebookCreateModal() {
    console.log('サブノート作成モーダルを開きます');
    
    if (modalManager.openModal('sub-notebook-modal')) {
        // フォームをリセット
        resetSubNotebookForm();
    }
}

function closeSubNotebookModal() {
    console.log('サブノート作成モーダルを閉じます');
    modalManager.closeModal('sub-notebook-modal');
    resetSubNotebookForm();
}

function resetSubNotebookForm() {
    const titleInput = document.getElementById('sub-notebook-title');
    const descriptionInput = document.getElementById('sub-notebook-description');
    
    if (titleInput) titleInput.value = '';
    if (descriptionInput) descriptionInput.value = '';
}

function createSubNotebook() {
    const titleInput = document.getElementById('sub-notebook-title');
    const descriptionInput = document.getElementById('sub-notebook-description');
    
    const title = titleInput?.value?.trim() || '';
    const description = descriptionInput?.value?.trim() || '';
    
    if (!title) {
        showNotification('サブノート名を入力してください', 'warning');
        titleInput?.focus();
        return;
    }
    
    // 作成ボタンを無効化
    const createButton = document.querySelector('#sub-notebook-modal button[onclick="createSubNotebook()"]');
    if (createButton) {
        createButton.disabled = true;
        createButton.textContent = '作成中...';
    }
    
    const notebookId = getNotebookId();
    if (!notebookId) {
        showNotification('ノートブックIDが取得できませんでした', 'error');
        enableCreateButton(createButton);
        return;
    }
    
    fetch(`/notes/${notebookId}/sub-notebook/create/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            title: title,
            description: description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 成功メッセージを表示
            showNotification(data.message, 'success');
            
            // サブノートタブを動的に追加
            addSubNotebookTab(data.sub_notebook);
            
            // モーダルを閉じる
            closeSubNotebookModal();
            
            // 新しく作成したサブノートでフィルタリング
            setTimeout(() => {
                filterBySubNotebook(data.sub_notebook.id);
            }, 500);
        } else {
            throw new Error(data.error || 'サブノートの作成に失敗しました');
        }
    })
    .catch(error => {
        console.error('サブノート作成エラー:', error);
        showNotification(error.message, 'error');
    })
    .finally(() => {
        enableCreateButton(createButton);
    });
}

function enableCreateButton(button) {
    if (button) {
        button.disabled = false;
        button.textContent = '作成';
    }
}

function addSubNotebookTab(subNotebook) {
    const tabContainer = document.querySelector('.sub-notebook-tab').parentElement;
    if (!tabContainer) return;
    
    // 新しいタブを作成
    const newTab = document.createElement('button');
    newTab.onclick = () => filterBySubNotebook(subNotebook.id);
    newTab.className = 'sub-notebook-tab px-3 py-2 text-sm rounded-lg bg-gray-700 text-gray-300';
    newTab.dataset.subNotebook = subNotebook.id;
    newTab.textContent = subNotebook.title;
    
    // 追加ボタンの前に挿入
    const addButton = tabContainer.querySelector('button[onclick="openSubNotebookCreateModal()"]');
    if (addButton) {
        tabContainer.insertBefore(newTab, addButton);
    } else {
        tabContainer.appendChild(newTab);
    }
    
    console.log('サブノートタブを追加しました:', subNotebook.title);
}

// ========================================
// エントリータイプ選択機能
// ========================================

// エントリータイプボタンの設定
function setupEntryTypeButtons() {
    const entryTypeButtons = document.querySelectorAll('.entry-type-btn');
    console.log('エントリータイプボタン数:', entryTypeButtons.length);
    
    entryTypeButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const entryType = this.getAttribute('data-entry-type');
            console.log('エントリータイプ選択:', entryType);
            
            if (entryType) {
                selectEntryType(entryType, this);
            }
        });
    });
}

// エントリータイプ選択
function selectEntryType(type, buttonElement) {
    console.log('selectEntryType呼び出し:', type);
    selectedEntryType = type;
    
    // hidden inputに値を設定
    const entryTypeInput = document.getElementById('entry_type');
    if (entryTypeInput) {
        entryTypeInput.value = type;
        console.log('エントリータイプ設定完了:', entryTypeInput.value);
    }
    
    // すべてのボタンを未選択状態にリセット
    document.querySelectorAll('.entry-type-btn').forEach(btn => {
        btn.classList.remove('selected', 'border-blue-500', 'bg-blue-900/30');
        btn.classList.add('border-gray-600', 'bg-gray-700');
    });
    
    // 選択されたボタンをハイライト
    if (buttonElement) {
        buttonElement.classList.remove('border-gray-600', 'bg-gray-700');
        buttonElement.classList.add('selected', 'border-blue-500', 'bg-blue-900/30');
        console.log('ボタンハイライト完了');
    }
    
    // エントリータイプ固有フォームを生成
    generateEntryTypeForm(type);
}

// エントリータイプ固有フォーム生成
function generateEntryTypeForm(type) {
    console.log('フォーム生成:', type);
    const container = document.getElementById('entry-type-form');
    if (!container) {
        console.error('entry-type-form コンテナが見つかりません');
        return;
    }
    
    const formTemplates = {
        'ANALYSIS': generateAnalysisForm(),
        'NEWS': generateNewsForm(),
        'CALCULATION': generateCalculationForm(),
        'MEMO': generateMemoForm(),
        'GOAL': generateGoalForm(),
        'EARNINGS': generateEarningsForm(),
        'IR_EVENT': generateIREventForm(),
        'MARKET_EVENT': generateMarketEventForm()
    };
    
    container.innerHTML = formTemplates[type] || '<p class="text-gray-400">このエントリータイプのフォームはまだ実装されていません。</p>';
    console.log('フォーム生成完了');
}

// ========================================
// エントリータイプ別フォームテンプレート（DRY原則適用）
// ========================================

function createFormField(type, name, label, placeholder = '', required = false, rows = null) {
    const requiredAttr = required ? 'required' : '';
    const requiredMark = required ? '<span class="text-red-400">*</span>' : '';
    
    if (type === 'textarea') {
        const rowsAttr = rows ? `rows="${rows}"` : 'rows="3"';
        return `
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">${label} ${requiredMark}</label>
                <textarea name="${name}" ${rowsAttr} placeholder="${placeholder}" ${requiredAttr}
                        class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
        `;
    } else {
        return `
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">${label} ${requiredMark}</label>
                <input type="${type}" name="${name}" placeholder="${placeholder}" ${requiredAttr}
                       class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
        `;
    }
}

function generateAnalysisForm() {
    return `
        <div class="space-y-4">
            ${createFormField('textarea', 'summary', 'サマリー', '決算の概要を記述してください', false, 3)}
            <div class="grid grid-cols-2 gap-4">
                ${createFormField('text', 'revenue', '売上高', '例: 8.7兆円 (+8.2%)')}
                ${createFormField('text', 'operating_profit', '営業利益', '例: 2.1兆円 (+12.1%)')}
                ${createFormField('text', 'net_income', '純利益', '例: 1.8兆円 (+15.3%)')}
                ${createFormField('text', 'eps', 'EPS', '例: 285円')}
            </div>
            ${createFormField('textarea', 'analysis', '分析', '決算内容の詳細分析を記述してください', false, 4)}
            ${createFormField('textarea', 'outlook', '今後の見通し', '今後の業績見通しや予想を記述してください')}
        </div>
    `;
}

function generateNewsForm() {
    return `
        <div class="space-y-4">
            ${createFormField('text', 'headline', 'ヘッドライン', 'ニュースのタイトルを入力してください')}
            ${createFormField('textarea', 'content', 'ニュース内容', 'ニュースの詳細内容を記述してください', false, 4)}
            ${createFormField('textarea', 'impact', '事業への影響', 'このニュースが事業に与える影響を分析してください')}
            ${createFormField('textarea', 'stock_impact', '株価への影響', '株価への影響や市場の反応を記述してください')}
        </div>
    `;
}

function generateCalculationForm() {
    return `
        <div class="space-y-4">
            ${createFormField('text', 'current_price', '現在株価', '例: 2,850円')}
            <div class="grid grid-cols-2 gap-4">
                ${createFormField('text', 'per', 'PER', '例: 12.5倍')}
                ${createFormField('text', 'pbr', 'PBR', '例: 1.1倍')}
                ${createFormField('text', 'dividend_yield', '配当利回り', '例: 2.8%')}
                ${createFormField('text', 'roe', 'ROE', '例: 8.9%')}
            </div>
            ${createFormField('text', 'fair_value', '適正価格', '例: 3,100円 - 3,300円')}
            ${createFormField('textarea', 'recommendation', '推奨・コメント', '計算結果に基づく推奨や分析コメントを記述してください')}
        </div>
    `;
}

function generateMemoForm() {
    return `
        <div class="space-y-4">
            ${createFormField('textarea', 'observation', '観察事項', '市場や銘柄について気づいたことを記述してください')}
            ${createFormField('textarea', 'market_trend', '市場トレンド', '市場全体のトレンドや動向について記述してください')}
            ${createFormField('textarea', 'personal_note', '個人的メモ', '個人的な考えや戦略について記述してください')}
            ${createFormField('textarea', 'next_action', '次のアクション', '次に取るべきアクションや確認事項を記述してください')}
        </div>
    `;
}

function generateGoalForm() {
    return `
        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                ${createFormField('text', 'target_price', '目標株価', '例: 3,200円')}
                ${createFormField('text', 'sell_timing', '売却タイミング', '例: 配当利回り3%を下回った時点')}
            </div>
            ${createFormField('textarea', 'investment_reason', '投資理由・戦略', 'なぜこの銘柄に投資するのか、どのような戦略で臨むのかを記述してください', false, 4)}
            ${createFormField('textarea', 'expected_effect', '期待される効果', 'この目標達成により期待される効果を記述してください')}
        </div>
    `;
}

function generateEarningsForm() {
    return `
        <div class="space-y-4">
            ${createFormField('date', 'earnings_date', '決算発表日')}
            ${createFormField('text', 'quarter', '四半期', '例: 2025年Q1')}
            ${createFormField('textarea', 'expectations', '事前予想', '決算発表前の予想や期待を記述してください')}
            ${createFormField('textarea', 'key_points', '注目ポイント', '今回の決算で注目すべきポイントを記述してください')}
        </div>
    `;
}

function generateIREventForm() {
    return `
        <div class="space-y-4">
            ${createFormField('text', 'event_name', 'イベント名', '例: 決算説明会、株主総会')}
            ${createFormField('datetime-local', 'event_datetime', 'イベント日時')}
            ${createFormField('textarea', 'agenda', 'アジェンダ', 'イベントの議題や内容を記述してください')}
            ${createFormField('textarea', 'key_takeaways', '主要なポイント', 'イベントでの重要な発言や情報を記述してください')}
        </div>
    `;
}

function generateMarketEventForm() {
    return `
        <div class="space-y-4">
            ${createFormField('text', 'event_title', 'イベントタイトル', '例: 金利発表、GDP発表')}
            ${createFormField('date', 'event_date', 'イベント日')}
            ${createFormField('textarea', 'market_impact', '市場への影響', 'このイベントが市場に与える影響を分析してください')}
            ${createFormField('textarea', 'sector_impact', 'セクターへの影響', '特定のセクターや銘柄への影響を記述してください')}
        </div>
    `;
}

// ========================================
// フォーム送信処理の設定
// ========================================

function setupFormSubmission() {
    const form = document.getElementById('entry-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('フォーム送信開始');
            
            if (!selectedEntryType) {
                e.preventDefault();
                showNotification('エントリータイプを選択してください', 'warning');
                return;
            }
            
            if (!document.getElementById('entry_title').value.trim()) {
                e.preventDefault();
                showNotification('エントリータイトルを入力してください', 'warning');
                return;
            }
            
            // フォームデータをJSONに変換
            const contentData = collectFormData();
            
            // content フィールドにJSONデータを設定
            const contentInput = document.createElement('input');
            contentInput.type = 'hidden';
            contentInput.name = 'content';
            contentInput.value = JSON.stringify(contentData);
            this.appendChild(contentInput);
            
            console.log('Content data:', contentData);
            
            // 送信ボタンを無効化（重複送信防止）
            const submitButton = this.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = '作成中...';
                
                // 送信後に元に戻す（エラー時のため）
                setTimeout(() => {
                    submitButton.disabled = false;
                    submitButton.innerHTML = `
                        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        エントリーを作成
                    `;
                }, 3000);
            }
        });
    }
}

function collectFormData() {
    const contentData = {};
    
    // エントリータイプ固有のフィールドを収集
    const typeForm = document.getElementById('entry-type-form');
    if (typeForm) {
        const inputs = typeForm.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
            if (input.value.trim()) {
                contentData[input.name] = input.value;
            }
        });
    }
    
    // key_metricsを別途作成（ANALYSIS用）
    if (selectedEntryType === 'ANALYSIS') {
        contentData.key_metrics = {};
        ['revenue', 'operating_profit', 'net_income', 'eps'].forEach(key => {
            if (contentData[key]) {
                contentData.key_metrics[key] = contentData[key];
                delete contentData[key];
            }
        });
    }
    
    // calculationsを別途作成（CALCULATION用）
    if (selectedEntryType === 'CALCULATION') {
        contentData.calculations = {};
        ['per', 'pbr', 'dividend_yield', 'roe'].forEach(key => {
            if (contentData[key]) {
                contentData.calculations[key] = contentData[key];
                delete contentData[key];
            }
        });
    }
    
    return contentData;
}

// ========================================
// 初期化処理の統合
// ========================================

// DOM準備完了時の初期化を更新
document.addEventListener('DOMContentLoaded', function() {
    console.log('ノート詳細ページが初期化されました');
    
    // エントリータイプボタンのイベントリスナー設定
    setupEntryTypeButtons();
    
    // フォーム送信時の処理
    setupFormSubmission();
    
    // フィルター機能の初期化
    setupFilters();
    
    // URLパラメータからフィルターを復元
    restoreFiltersFromUrl();
    
    console.log('すべての機能が初期化されました');
});
</script>
{% endblock %}