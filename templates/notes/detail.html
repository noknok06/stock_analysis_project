<!-- ========================================
templates/notes/detail.html - 統計情報修正完全版
======================================== -->

{% extends 'base.html' %}

{% block title %}{{ notebook.title }} - 株式分析記録アプリ{% endblock %}

{% block extra_css %}
<style>
    .entry-card {
        transition: all 0.2s ease-in-out;
    }
    .entry-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    /* 詳細情報セクションのスタイル */
    .detail-section {
        background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        border: 1px solid #374151;
        transition: all 0.3s ease-in-out;
    }
    
    .detail-section.expanded {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .expand-button {
        transition: all 0.2s ease-in-out;
    }
    
    .expand-button:hover {
        background-color: rgba(75, 85, 99, 0.5);
    }
    
    .expand-button .chevron {
        transition: transform 0.3s ease-in-out;
    }
    
    .expand-button.expanded .chevron {
        transform: rotate(180deg);
    }
    
    .detail-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out;
    }
    
    .detail-content.expanded {
        max-height: 1000px; /* 十分大きな値 */
    }
    
    /* 基本情報のスタイル */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }
    
    .info-card {
        background: rgba(55, 65, 81, 0.5);
        border: 1px solid #4b5563;
        border-radius: 0.5rem;
        padding: 1rem;
        transition: all 0.2s ease-in-out;
    }
    
    .info-card:hover {
        background: rgba(55, 65, 81, 0.8);
        border-color: #6b7280;
    }
    
    .info-label {
        font-size: 0.75rem;
        font-weight: 500;
        color: #9ca3af;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.25rem;
    }
    
    .info-value {
        color: #f3f4f6;
        font-weight: 500;
    }
    
    /* 投資戦略表示の改善 */
    .strategy-full {
        background: linear-gradient(135deg, #312e81 0%, #1e1b4b 100%);
        border: 1px solid #4338ca;
    }
    
    /* リスト表示の改善 */
    .criteria-list, .risk-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .criteria-list li, .risk-list li {
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.2);
        padding: 0.5rem 0.75rem;
        margin: 0.25rem 0;
        border-radius: 0.375rem;
        color: #bbf7d0;
        font-size: 0.875rem;
        position: relative;
        padding-left: 2rem;
    }
    
    .criteria-list li::before {
        content: "✓";
        position: absolute;
        left: 0.75rem;
        color: #22c55e;
        font-weight: bold;
    }
    
    .risk-list li {
        background: rgba(239, 68, 68, 0.1);
        border-color: rgba(239, 68, 68, 0.2);
        color: #fecaca;
    }
    
    .risk-list li::before {
        content: "!";
        position: absolute;
        left: 0.75rem;
        color: #ef4444;
        font-weight: bold;
    }
    
    /* 統計情報の改善 */
    .stats-card {
        background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        border: 1px solid #374151;
        transition: all 0.2s ease-in-out;
    }
    
    .stats-card:hover {
        border-color: #4b5563;
        transform: translateY(-1px);
    }
    
    /* サブノートタブの改善 */
    .sub-notebook-tab {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
    }
    .sub-notebook-tab.active {
        background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
    }
    .sub-notebook-tab:hover:not(.active) {
        background-color: rgba(75, 85, 99, 0.5);
    }
    
    /* yfinance API ローディング表示 */
    .loading-company-name {
        display: inline-flex;
        align-items: center;
        color: #3b82f6;
        font-size: 0.875rem;
    }
    
    .loading-company-name svg {
        animation: spin 1s linear infinite;
        margin-right: 0.5rem;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    /* エントリー編集モーダルのスタイル */
    .edit-modal {
        backdrop-filter: blur(8px);
    }
    
    /* レスポンシブ対応 */
    @media (max-width: 768px) {
        .info-grid {
            grid-template-columns: 1fr;
        }
        
        .detail-content.expanded {
            max-height: 2000px; /* モバイルでは高さを大きく */
        }
        
        .info-card {
            padding: 0.75rem;
        }
        
        .criteria-list li, .risk-list li {
            font-size: 0.8rem;
            padding: 0.375rem 0.5rem;
            padding-left: 1.5rem;
        }
        
        .criteria-list li::before, .risk-list li::before {
            left: 0.5rem;
        }
    }
    
    /* アニメーション */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .entry-card {
        animation: fadeIn 0.3s ease-out;
    }
    
    /* その他の既存スタイル */
    .filter-chip {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
    }
    .filter-chip.active {
        background-color: #3b82f6;
        color: white;
    }
    .filter-chip:hover:not(.active) {
        background-color: rgba(75, 85, 99, 0.7);
    }
    .favorite-star {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
    }
    .favorite-star.active {
        color: #fbbf24;
    }
    .bookmark-icon {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
    }
    .bookmark-icon.active {
        color: #3b82f6;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-2 sm:px-4" data-notebook-id="{{ notebook.pk }}">
    <!-- ノートヘッダー（簡潔版） -->
    <div class="bg-gray-800 border border-gray-700 rounded-lg mb-4 md:mb-6">
        <div class="p-4 md:p-6 border-b border-gray-700">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-0 mb-4">
                <div class="flex items-center space-x-3 md:space-x-4 min-w-0 flex-1">
                    <a href="{% url 'notes:list' %}" 
                       title="ノート一覧に戻る"
                       class="text-gray-400 hover:text-white transition-colors flex-shrink-0">
                        <svg class="h-5 w-5 md:h-6 md:w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </a>
                    <div class="min-w-0 flex-1">
                        <div class="flex items-center gap-2">
                            <h1 class="text-xl md:text-2xl font-bold text-white truncate">{{ notebook.title }}</h1>
                            <button onclick="toggleFavorite()" 
                                    title="お気に入り切り替え"
                                    class="favorite-star text-gray-400 hover:text-yellow-400 {% if notebook.is_favorite %}active{% endif %}">
                                <svg class="h-5 w-5" fill="{% if notebook.is_favorite %}currentColor{% else %}none{% endif %}" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-2 md:space-x-3">
                    <button onclick="openNewEntryModal()" 
                            title="新規エントリー作成"
                            class="inline-flex items-center px-2 md:px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        <svg class="h-4 w-4 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        <span class="hidden md:inline ml-2">新規エントリー</span>
                    </button>
                    
                    <a href="{% url 'notes:edit' notebook.pk %}" 
                       title="ノート編集"
                       class="inline-flex items-center px-2 md:px-4 py-2 border border-gray-600 text-gray-300 hover:bg-gray-700 rounded-lg transition-colors">
                        <svg class="h-4 w-4 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        <span class="hidden md:inline ml-2">編集</span>
                    </a>
                </div>
            </div>
            
            <!-- 詳細情報の展開ボタン -->
            <div class="border-t border-gray-700 pt-4">
                <button onclick="toggleDetailSection()" 
                        id="detail-expand-btn"
                        class="expand-button w-full flex items-center justify-center gap-2 py-3 px-4 rounded-lg text-sm font-medium text-gray-300 hover:text-white transition-colors">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>ノート詳細情報を表示</span>
                    <svg class="h-4 w-4 chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    <!-- 詳細情報セクション（折りたたみ可能） -->
    <div class="detail-section rounded-lg mb-4 md:mb-6" id="detail-section">
        <div class="detail-content" id="detail-content">
            <div class="p-4 md:p-6 space-y-6">
                
                <!-- 基本情報グリッド -->
                <div class="info-grid">
                    {% if notebook.description %}
                        <div class="info-card">
                            <div class="info-label">ノートの説明</div>
                            <div class="info-value">{{ notebook.description }}</div>
                        </div>
                    {% endif %}
                    
                    <div class="info-card">
                        <div class="info-label">作成日</div>
                        <div class="info-value">{{ notebook.created_at|date:"Y年m月d日" }}</div>
                    </div>
                    
                    <div class="info-card">
                        <div class="info-label">最終更新</div>
                        <div class="info-value">{{ notebook.updated_at|date:"Y年m月d日 H:i" }}</div>
                    </div>
                </div>
                
                <!-- 選定基準とリスク要因 -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- 選定基準 -->
                    {% if notebook.key_criteria %}
                        <div>
                            <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                                <svg class="h-5 w-5 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                選定基準
                            </h3>
                            <ul class="criteria-list">
                                {% for criteria in notebook.key_criteria %}
                                    <li>{{ criteria }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                    
                    <!-- リスク要因 -->
                    {% if notebook.risk_factors %}
                        <div>
                            <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                                <svg class="h-5 w-5 mr-2 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                                リスク要因
                            </h3>
                            <ul class="risk-list">
                                {% for risk in notebook.risk_factors %}
                                    <li>{{ risk }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                </div>
                
                <!-- タグ表示 -->
                {% if notebook.tags.all %}
                    <div>
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <svg class="h-5 w-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.99 1.99 0 013 12V7a2 2 0 012-2z"></path>
                            </svg>
                            関連タグ
                        </h3>
                        <div class="flex flex-wrap gap-2">
                            {% for tag in notebook.tags.all %}
                                <span class="px-3 py-1 text-sm border border-gray-600 text-gray-300 rounded-full hover:bg-gray-700 cursor-pointer transition-colors {{ tag.get_color_class }}">
                                    {{ tag.name }}
                                </span>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                
                <!-- 統計情報（詳細版）- ★修正版 -->
                <div>
                    <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                        <svg class="h-5 w-5 mr-2 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        ノート統計情報
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="stats-card p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-400">{{ notebook.entry_count|default:0 }}</div>
                            <div class="text-sm text-gray-400">総エントリー数</div>
                        </div>
                        <div class="stats-card p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-400">{{ notebook.get_stock_count|default:0 }}</div>
                            <div class="text-sm text-gray-400">銘柄数</div>
                        </div>
                        <div class="stats-card p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-400">{{ notebook.get_recent_entries_count|default:0 }}</div>
                            <div class="text-sm text-gray-400">今週の記録</div>
                        </div>
                        <div class="stats-card p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-yellow-400">{{ notebook.get_important_entries_count|default:0 }}</div>
                            <div class="text-sm text-gray-400">重要記録</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- フィルター・サブノートタブ -->
    <div class="bg-gray-800 border border-gray-700 rounded-lg mb-4 md:mb-6">
        <div class="p-4 md:p-6">
            <!-- サブノートタブ -->
            {% if sub_notebooks %}
                <div class="mb-4">
                    <h3 class="text-sm font-medium text-gray-300 mb-3">サブノート</h3>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterBySubNotebook('')" 
                                class="sub-notebook-tab px-3 py-2 text-sm rounded-lg bg-gray-700 text-gray-300 active"
                                data-sub-notebook="">
                            すべて
                        </button>
                        {% for sub_notebook in sub_notebooks %}
                            <button onclick="filterBySubNotebook('{{ sub_notebook.pk }}')" 
                                    class="sub-notebook-tab px-3 py-2 text-sm rounded-lg bg-gray-700 text-gray-300"
                                    data-sub-notebook="{{ sub_notebook.pk }}">
                                {{ sub_notebook.title }}
                            </button>
                        {% endfor %}
                        <button onclick="openSubNotebookCreateModal()" 
                                title="サブノート追加"
                                class="px-3 py-2 text-sm rounded-lg border border-gray-600 text-gray-400 hover:text-white hover:border-blue-500 transition-colors">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            {% endif %}
            
            <!-- その他のフィルター -->
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-0">
                <div class="flex flex-wrap gap-2">
                    <!-- エントリータイプフィルター -->
                    <select id="entry-type-filter" class="bg-gray-700 border border-gray-600 text-white rounded px-2 md:px-3 py-1 text-xs md:text-sm">
                        <option value="">すべてのタイプ</option>
                        <option value="ANALYSIS">決算分析</option>
                        <option value="NEWS">ニュース</option>
                        <option value="MEMO">メモ</option>
                        <option value="GOAL">投資目標</option>
                        <option value="EARNINGS">決算発表</option>
                        <option value="IR_EVENT">IRイベント</option>
                        <option value="MARKET_EVENT">市場イベント</option>
                    </select>
                    
                    <!-- 銘柄フィルター -->
                    {% if stocks %}
                        <select id="stock-filter" class="bg-gray-700 border border-gray-600 text-white rounded px-2 md:px-3 py-1 text-xs md:text-sm">
                            <option value="">すべての銘柄</option>
                            {% for stock in stocks %}
                                <option value="{{ stock.stock_code }}">
                                    {% if stock.stock_code and stock.company_name %}
                                        {{ stock.stock_code }} {{ stock.company_name }}
                                    {% elif stock.stock_code %}
                                        {{ stock.stock_code }}
                                    {% else %}
                                        {{ stock.company_name }}
                                    {% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    {% endif %}
                    
                    <!-- 重要フラグフィルター -->
                    <button onclick="toggleImportantFilter()" 
                            id="important-filter"
                            class="filter-chip px-3 py-1 text-xs md:text-sm rounded border border-gray-600 text-gray-300">
                        <svg class="h-3 w-3 md:h-4 md:w-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                        </svg>
                        重要
                    </button>
                    
                    <!-- ブックマークフィルター -->
                    <button onclick="toggleBookmarkFilter()" 
                            id="bookmark-filter"
                            class="filter-chip px-3 py-1 text-xs md:text-sm rounded border border-gray-600 text-gray-300">
                        <svg class="h-3 w-3 md:h-4 md:w-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                        </svg>
                        ブックマーク
                    </button>
                </div>
                
                <!-- ソート -->
                <div class="flex items-center space-x-2">
                    <span class="text-xs md:text-sm text-gray-400">並び順:</span>
                    <select id="sort-order" class="bg-gray-700 border border-gray-600 text-white rounded px-2 py-1 text-xs md:text-sm">
                        <option value="newest">新しい順</option>
                        <option value="oldest">古い順</option>
                        <option value="important">重要度順</option>
                        <option value="stock">銘柄順</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- エントリー一覧 -->
    <div class="space-y-4 md:space-y-6">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-0">
            <h2 class="text-lg md:text-xl font-semibold text-white flex items-center">
                <svg class="h-4 w-4 md:h-5 md:w-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
                <span class="hidden sm:inline">記録エントリー</span>
                <span class="sm:hidden">記録</span>
                <span class="ml-2 text-gray-400 text-sm md:text-base font-normal" id="entries-count">({{ entries.count }}件)</span>
            </h2>
        </div>
        
        {% if entries %}
            <!-- エントリーカード -->
            <div class="space-y-3 md:space-y-4" id="entries-container">
                {% for entry in entries %}
                    <div class="entry-card bg-gray-800 border border-gray-700 rounded-lg overflow-hidden cursor-pointer hover:bg-gray-750 transition-colors"
                         data-entry-type="{{ entry.entry_type }}"
                         data-entry-id="{{ entry.pk }}"
                         data-stock-code="{{ entry.stock_code }}"
                         data-sub-notebook="{{ entry.sub_notebook.pk|default:'' }}"
                         data-important="{{ entry.is_important|yesno:'true,false' }}"
                         data-bookmarked="{{ entry.is_bookmarked|yesno:'true,false' }}"
                         data-created="{{ entry.created_at|date:'Y-m-d' }}"
                         onclick="handleEntryCardClick('{{ entry.pk }}')">
                        <div class="p-4 md:p-6">
                            <!-- エントリーヘッダー -->
                            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-0 mb-4">
                                <div class="flex items-center space-x-3 min-w-0 flex-1">
                                    <div class="p-2 rounded-lg flex-shrink-0 {% if entry.entry_type == 'ANALYSIS' %}bg-blue-900 text-blue-300{% elif entry.entry_type == 'NEWS' %}bg-green-900 text-green-300{% elif entry.entry_type == 'CALCULATION' %}bg-orange-900 text-orange-300{% elif entry.entry_type == 'MEMO' %}bg-gray-700 text-gray-300{% elif entry.entry_type == 'EARNINGS' %}bg-purple-900 text-purple-300{% elif entry.entry_type == 'IR_EVENT' %}bg-indigo-900 text-indigo-300{% elif entry.entry_type == 'MARKET_EVENT' %}bg-pink-900 text-pink-300{% else %}bg-yellow-900 text-yellow-300{% endif %}">
                                        <svg class="h-4 w-4 md:h-5 md:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                        </svg>
                                    </div>
                                    <div class="min-w-0 flex-1">
                                        <div class="flex items-center gap-2">
                                            <h3 class="text-base md:text-lg font-semibold text-white truncate">{{ entry.title }}</h3>
                                            {% if entry.is_important %}
                                                <svg class="h-4 w-4 text-yellow-400 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                                </svg>
                                            {% endif %}
                                            {% if entry.is_bookmarked %}
                                                <svg class="h-4 w-4 text-blue-400 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                                                </svg>
                                            {% endif %}
                                        </div>
                                        <div class="text-xs md:text-sm text-gray-400 mt-1">
                                            <span class="hidden sm:inline">{{ entry.get_entry_type_display }}</span>
                                            <span class="sm:hidden">
                                                {% if entry.entry_type == 'ANALYSIS' %}分析
                                                {% elif entry.entry_type == 'NEWS' %}ニュース
                                                {% elif entry.entry_type == 'CALCULATION' %}計算
                                                {% elif entry.entry_type == 'MEMO' %}メモ
                                                {% elif entry.entry_type == 'EARNINGS' %}決算
                                                {% elif entry.entry_type == 'IR_EVENT' %}IR
                                                {% elif entry.entry_type == 'MARKET_EVENT' %}市場
                                                {% else %}目標{% endif %}
                                            </span>
                                            {% if entry.stock_code or entry.company_name %}
                                                • {{ entry.get_stock_display }}
                                            {% endif %}
                                            {% if entry.sub_notebook %}
                                                • {{ entry.sub_notebook.title }}
                                            {% endif %}
                                            • {{ entry.created_at|date:"m/d H:i" }}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex items-center space-x-1 sm:space-x-2 flex-shrink-0">
                                    {% if entry.tags.all %}
                                        <div class="flex space-x-1">
                                            {% for tag in entry.tags.all|slice:":2" %}
                                                <span class="px-1 md:px-2 py-1 text-xs bg-gray-700 text-gray-300 rounded truncate max-w-16 sm:max-w-none">{{ tag.name }}</span>
                                            {% endfor %}
                                            {% if entry.tags.count > 2 %}
                                                <span class="px-1 md:px-2 py-1 text-xs bg-gray-700 text-gray-300 rounded">+{{ entry.tags.count|add:"-2" }}</span>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                    
                                    <!-- エントリーアクション -->
                                    <div class="flex items-center space-x-1" onclick="event.stopPropagation()">
                                        <button onclick="editEntry('{{ entry.pk }}')" 
                                                title="エントリー編集"
                                                class="p-1 text-gray-400 hover:text-green-400">
                                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                            </svg>
                                        </button>
                                        <button onclick="toggleEntryBookmark('{{ entry.pk }}')" 
                                                title="ブックマーク切り替え"
                                                class="bookmark-icon p-1 text-gray-400 hover:text-blue-400 {% if entry.is_bookmarked %}active{% endif %}">
                                            <svg class="h-4 w-4" fill="{% if entry.is_bookmarked %}currentColor{% else %}none{% endif %}" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- エントリー内容プレビュー -->
                            <div class="text-sm md:text-base text-gray-300">
                                {% if entry.entry_type == 'ANALYSIS' and entry.content.summary %}
                                    <p class="mb-2"><strong>サマリー:</strong> {{ entry.content.summary|truncatewords:30 }}</p>
                                {% elif entry.entry_type == 'NEWS' and entry.content.headline %}
                                    <p class="mb-2"><strong>ヘッドライン:</strong> {{ entry.content.headline }}</p>
                                {% elif entry.entry_type == 'CALCULATION' and entry.content.current_price %}
                                    <p class="mb-2"><strong>現在株価:</strong> {{ entry.content.current_price }}</p>
                                {% elif entry.entry_type == 'MEMO' and entry.content.observation %}
                                    <p class="mb-2">{{ entry.content.observation|truncatewords:30 }}</p>
                                {% endif %}
                                
                                <div class="mt-2 md:mt-3 text-xs md:text-sm text-gray-400">
                                    クリックして詳細を表示...
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <!-- ページネーション -->
            {% if is_paginated %}
                <div class="flex items-center justify-center space-x-2 md:space-x-4 mt-8">
                    <button onclick="previousPage()" 
                            {% if not page_obj.has_previous %}disabled{% endif %}
                            title="前のページ"
                            class="px-2 md:px-4 py-2 bg-gray-800 border border-gray-700 text-white rounded hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        <svg class="h-4 w-4 md:mr-1 md:inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        <span class="hidden md:inline ml-1">前のページ</span>
                    </button>
                    
                    <div class="flex items-center space-x-2">
                        <span class="text-gray-400 text-xs md:text-sm">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
                    </div>
                    
                    <button onclick="nextPage()" 
                            {% if not page_obj.has_next %}disabled{% endif %}
                            title="次のページ"
                            class="px-2 md:px-4 py-2 bg-gray-800 border border-gray-700 text-white rounded hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        <span class="hidden md:inline mr-1">次のページ</span>
                        <svg class="h-4 w-4 md:ml-1 md:inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            {% endif %}
        {% else %}
            <!-- エントリーなしの場合 -->
            <div class="text-center py-12 md:py-16">
                <div class="mx-auto h-16 w-16 md:h-24 md:w-24 text-gray-600 mb-4">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <h3 class="text-base md:text-lg font-medium text-gray-400 mb-2">まだエントリーがありません</h3>
                <p class="text-sm md:text-base text-gray-500 mb-6">最初の分析記録を作成しましょう</p>
                <button onclick="openNewEntryModal()" 
                        class="inline-flex items-center px-4 md:px-6 py-2 md:py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
                    <svg class="h-4 w-4 md:h-5 md:w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    <span class="hidden sm:inline">最初のエントリーを作成</span>
                    <span class="sm:hidden">エントリー作成</span>
                </button>
            </div>
        {% endif %}
    </div>
</div>

<!-- ★ 統計情報を更新するためのCSRFトークン -->
{% csrf_token %}

<!-- 新規エントリーモーダル -->
<div id="new-entry-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-2 md:p-4">
    <div class="bg-gray-900 border border-gray-700 rounded-lg w-full max-w-4xl max-h-[95vh] md:max-h-[90vh] overflow-hidden">
        <div class="flex items-center justify-between p-4 md:p-6 border-b border-gray-700">
            <div>
                <h2 class="text-lg md:text-2xl font-bold text-white">新規エントリー作成</h2>
                <p class="text-sm md:text-base text-gray-400">{{ notebook.title }} に新しい記録を追加します</p>
            </div>
            <button onclick="closeNewEntryModal()" class="text-gray-400 hover:text-white p-2">
                <svg class="h-5 w-5 md:h-6 md:w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <form id="entry-form" method="POST" action="{% url 'notes:entry_create' notebook.pk %}" class="overflow-y-auto max-h-[calc(95vh-140px)] md:max-h-[calc(90vh-140px)]">
            {% csrf_token %}
            <div class="p-4 md:p-6 space-y-4 md:space-y-6">
                <!-- エントリータイプ選択 -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-4">エントリータイプ</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-3">
                        <button type="button" data-entry-type="ANALYSIS" 
                                class="entry-type-btn p-3 md:p-4 rounded-lg border-2 border-gray-600 bg-gray-700 hover:bg-gray-600 transition-all text-center">
                            <div class="p-2 rounded-lg bg-blue-900 text-blue-300 mb-2 mx-auto w-fit">
                                <svg class="h-4 w-4 md:h-5 md:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-white text-xs md:text-sm">決算分析</h3>
                            <p class="text-xs text-gray-400 mt-1 hidden md:block">決算情報の分析記録</p>
                        </button>
                        
                        <button type="button" data-entry-type="NEWS" 
                                class="entry-type-btn p-3 md:p-4 rounded-lg border-2 border-gray-600 bg-gray-700 hover:bg-gray-600 transition-all text-center">
                            <div class="p-2 rounded-lg bg-green-900 text-green-300 mb-2 mx-auto w-fit">
                                <svg class="h-4 w-4 md:h-5 md:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9.5a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-white text-xs md:text-sm">ニュース</h3>
                            <p class="text-xs text-gray-400 mt-1 hidden md:block">関連ニュースの記録</p>
                        </button>
                        
                        <button type="button" data-entry-type="MEMO" 
                                class="entry-type-btn p-3 md:p-4 rounded-lg border-2 border-gray-600 bg-gray-700 hover:bg-gray-600 transition-all text-center">
                            <div class="p-2 rounded-lg bg-gray-700 text-gray-300 mb-2 mx-auto w-fit">
                                <svg class="h-4 w-4 md:h-5 md:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-white text-xs md:text-sm">メモ</h3>
                            <p class="text-xs text-gray-400 mt-1 hidden md:block">個人的な気づき・メモ</p>
                        </button>
                        
                        <button type="button" data-entry-type="GOAL" 
                                class="entry-type-btn p-3 md:p-4 rounded-lg border-2 border-gray-600 bg-gray-700 hover:bg-gray-600 transition-all text-center">
                            <div class="p-2 rounded-lg bg-yellow-900 text-yellow-300 mb-2 mx-auto w-fit">
                                <svg class="h-4 w-4 md:h-5 md:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-white text-xs md:text-sm">投資目標</h3>
                            <p class="text-xs text-gray-400 mt-1 hidden md:block">投資目標・戦略の設定</p>
                        </button>
                    </div>
                    <input type="hidden" id="entry_type" name="entry_type" required>
                </div>
                
                <!-- 基本情報 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- エントリータイトル -->
                    <div>
                        <label for="entry_title" class="block text-sm font-medium text-gray-300 mb-2">
                            エントリータイトル <span class="text-red-400">*</span>
                        </label>
                        <input type="text" 
                               id="entry_title" 
                               name="title" 
                               required
                               placeholder="エントリーのタイトルを入力してください"
                               class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <!-- サブノート選択 -->
                    {% if sub_notebooks %}
                        <div>
                            <label for="sub_notebook" class="block text-sm font-medium text-gray-300 mb-2">サブノート</label>
                            <select id="sub_notebook" 
                                    name="sub_notebook"
                                    class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">サブノートを選択（任意）</option>
                                {% for sub_notebook in sub_notebooks %}
                                    <option value="{{ sub_notebook.pk }}">{{ sub_notebook.title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    {% endif %}
                </div>
                
                <!-- 銘柄情報（★yfinance連携） -->
                <div>
                    <h4 class="text-sm font-medium text-gray-300 mb-3">銘柄情報（任意）</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="stock_code" class="block text-sm font-medium text-gray-300 mb-2">銘柄コード</label>
                            <div class="relative">
                                <input type="text" 
                                       id="stock_code" 
                                       name="stock_code" 
                                       placeholder="例: 7203"
                                       class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <div id="stock-code-loading" class="loading-company-name hidden absolute right-3 top-2">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">入力すると企業名を自動取得します</p>
                        </div>
                        
                        <div>
                            <label for="company_name" class="block text-sm font-medium text-gray-300 mb-2">企業名</label>
                            <input type="text" 
                                   id="company_name" 
                                   name="company_name" 
                                   placeholder="例: トヨタ自動車"
                                   class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label for="event_date" class="block text-sm font-medium text-gray-300 mb-2">イベント日</label>
                            <input type="date" 
                                   id="event_date" 
                                   name="event_date"
                                   class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
                
                <!-- オプション -->
                <div class="flex flex-wrap gap-4">
                    <label class="flex items-center">
                        <input type="checkbox" name="is_important" class="text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-300">重要フラグ</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="is_bookmarked" class="text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-300">ブックマーク</span>
                    </label>
                </div>
                
                <!-- エントリー固有フォーム -->
                <div id="entry-type-form">
                    <!-- 動的に生成されるフォーム内容 -->
                </div>
            </div>
            
            <div class="flex flex-col sm:flex-row items-center justify-between p-4 md:p-6 bg-gray-800 border-t border-gray-700 gap-3 sm:gap-0">
                <div class="text-xs md:text-sm text-gray-400 order-2 sm:order-1">
                    <svg class="h-3 w-3 md:h-4 md:w-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    作成日: {{ 'now'|date:"Y/m/d" }}
                </div>
                <div class="flex space-x-2 md:space-x-3 w-full sm:w-auto order-1 sm:order-2">
                    <button type="button" onclick="closeNewEntryModal()" 
                            class="flex-1 sm:flex-none px-4 md:px-6 py-2 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition-colors text-sm md:text-base">
                        キャンセル
                    </button>
                    <button type="submit" 
                            class="flex-1 sm:flex-none px-4 md:px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center justify-center text-sm md:text-base">
                        <svg class="h-3 w-3 md:h-4 md:w-4 mr-1 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="hidden sm:inline">エントリーを作成</span>
                        <span class="sm:hidden">作成</span>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- エントリー詳細モーダル -->
<div id="entry-detail-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-2 md:p-4">
    <div class="bg-gray-900 border border-gray-700 rounded-lg w-full max-w-4xl max-h-[95vh] md:max-h-[90vh] overflow-hidden">
        <div class="flex items-center justify-between p-4 md:p-6 border-b border-gray-700">
            <h3 class="text-lg md:text-xl font-semibold text-white" id="entry-detail-title">エントリー詳細</h3>
            <button onclick="closeEntryDetail()" class="text-gray-400 hover:text-white p-2">
                <svg class="h-5 w-5 md:h-6 md:w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div id="entry-detail-content" class="p-4 md:p-6 overflow-y-auto max-h-[calc(95vh-120px)] md:max-h-[60vh]">
            <!-- エントリー詳細内容がここに表示される -->
        </div>
    </div>
</div>

<!-- ★エントリー編集モーダル（新規追加） -->
<div id="entry-edit-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-2 md:p-4 edit-modal">
    <div class="bg-gray-900 border border-gray-700 rounded-lg w-full max-w-4xl max-h-[95vh] md:max-h-[90vh] overflow-hidden">
        <div class="flex items-center justify-between p-4 md:p-6 border-b border-gray-700">
            <div>
                <h2 class="text-lg md:text-2xl font-bold text-white">エントリー編集</h2>
                <p class="text-sm md:text-base text-gray-400" id="edit-entry-subtitle">エントリーの内容を修正します</p>
            </div>
            <button onclick="closeEntryEditModal()" class="text-gray-400 hover:text-white p-2">
                <svg class="h-5 w-5 md:h-6 md:w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <form id="entry-edit-form" method="POST" class="overflow-y-auto max-h-[calc(95vh-140px)] md:max-h-[calc(90vh-140px)]">
            {% csrf_token %}
            <div class="p-4 md:p-6 space-y-4 md:space-y-6">
                <!-- エントリータイプ選択（編集時は変更不可） -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">エントリータイプ</label>
                    <select id="edit_entry_type" 
                            name="entry_type"
                            class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="ANALYSIS">決算分析</option>
                        <option value="NEWS">ニュース</option>
                        <option value="MEMO">メモ</option>
                        <option value="GOAL">投資目標</option>
                        <option value="EARNINGS">決算発表</option>
                        <option value="IR_EVENT">IRイベント</option>
                        <option value="MARKET_EVENT">市場イベント</option>
                    </select>
                </div>
                
                <!-- 基本情報 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- エントリータイトル -->
                    <div>
                        <label for="edit_entry_title" class="block text-sm font-medium text-gray-300 mb-2">
                            エントリータイトル <span class="text-red-400">*</span>
                        </label>
                        <input type="text" 
                               id="edit_entry_title" 
                               name="title" 
                               required
                               class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <!-- サブノート選択 -->
                    <div>
                        <label for="edit_sub_notebook" class="block text-sm font-medium text-gray-300 mb-2">サブノート</label>
                        <select id="edit_sub_notebook" 
                                name="sub_notebook"
                                class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">サブノートを選択（任意）</option>
                            <!-- 動的に設定される -->
                        </select>
                    </div>
                </div>
                
                <!-- 銘柄情報（yfinance連携） -->
                <div>
                    <h4 class="text-sm font-medium text-gray-300 mb-3">銘柄情報（任意）</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="edit_stock_code" class="block text-sm font-medium text-gray-300 mb-2">銘柄コード</label>
                            <div class="relative">
                                <input type="text" 
                                       id="edit_stock_code" 
                                       name="stock_code"
                                       class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <div id="edit-stock-code-loading" class="loading-company-name hidden absolute right-3 top-2">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label for="edit_company_name" class="block text-sm font-medium text-gray-300 mb-2">企業名</label>
                            <input type="text" 
                                   id="edit_company_name" 
                                   name="company_name"
                                   class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label for="edit_event_date" class="block text-sm font-medium text-gray-300 mb-2">イベント日</label>
                            <input type="date" 
                                   id="edit_event_date" 
                                   name="event_date"
                                   class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
                
                <!-- オプション -->
                <div class="flex flex-wrap gap-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="edit_is_important" name="is_important" class="text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-300">重要フラグ</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="edit_is_bookmarked" name="is_bookmarked" class="text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-300">ブックマーク</span>
                    </label>
                </div>
                
                <!-- エントリー固有フォーム（編集用） -->
                <div id="edit-entry-type-form">
                    <!-- 動的に生成されるフォーム内容 -->
                </div>
            </div>
            
            <div class="flex flex-col sm:flex-row items-center justify-between p-4 md:p-6 bg-gray-800 border-t border-gray-700 gap-3 sm:gap-0">
                <div class="text-xs md:text-sm text-gray-400 order-2 sm:order-1">
                    <svg class="h-3 w-3 md:h-4 md:w-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    エントリーを編集中
                </div>
                <div class="flex space-x-2 md:space-x-3 w-full sm:w-auto order-1 sm:order-2">
                    <button type="button" onclick="closeEntryEditModal()" 
                            class="flex-1 sm:flex-none px-4 md:px-6 py-2 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition-colors text-sm md:text-base">
                        キャンセル
                    </button>
                    <button type="submit" 
                            class="flex-1 sm:flex-none px-4 md:px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors flex items-center justify-center text-sm md:text-base">
                        <svg class="h-3 w-3 md:h-4 md:w-4 mr-1 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="hidden sm:inline">変更を保存</span>
                        <span class="sm:hidden">保存</span>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- サブノート作成モーダル -->
<div id="sub-notebook-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-gray-900 border border-gray-700 rounded-lg w-full max-w-md">
        <div class="flex items-center justify-between p-6 border-b border-gray-700">
            <h3 class="text-lg font-semibold text-white">サブノート作成</h3>
            <button onclick="closeSubNotebookModal()" class="text-gray-400 hover:text-white">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="p-6">
            <div class="space-y-4">
                <div>
                    <label for="sub-notebook-title" class="block text-sm font-medium text-gray-300 mb-2">サブノート名 *</label>
                    <input type="text" 
                           id="sub-notebook-title" 
                           placeholder="例: 日本株"
                           class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="sub-notebook-description" class="block text-sm font-medium text-gray-300 mb-2">説明</label>
                    <textarea id="sub-notebook-description" 
                              rows="3"
                              placeholder="サブノートの説明（任意）"
                              class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeSubNotebookModal()" 
                        class="px-4 py-2 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition-colors">
                    キャンセル
                </button>
                <button onclick="createSubNotebook()" 
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                    作成
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- JavaScript部分のみ（detail.htmlの末尾に追加） -->

<script>
// ========================================
// グローバル変数・定数
// ========================================

let selectedEntryType = null;
let editingEntryId = null;
let currentFilters = {
    subNotebook: '',
    entryType: '',
    stockCode: '',
    isImportant: false,
    isBookmarked: false
};

// 通知マネージャー
const NotificationManager = {
    show: function(message, type = 'info', duration = 3000) {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transition-all transform translate-x-full`;
        
        const colors = {
            'success': 'bg-green-600 text-white',
            'error': 'bg-red-600 text-white',
            'warning': 'bg-yellow-600 text-white',
            'info': 'bg-blue-600 text-white'
        };
        
        notification.className += ` ${colors[type] || colors.info}`;
        notification.innerHTML = `
            <div class="flex items-center gap-2">
                ${this.getIcon(type)}
                <span>${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-2 hover:opacity-75">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // アニメーションで表示
        setTimeout(() => {
            notification.classList.remove('translate-x-full');
        }, 100);
        
        // 自動削除
        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => notification.remove(), 300);
        }, duration);
    },
    
    getIcon: function(type) {
        const icons = {
            'success': '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',
            'error': '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',
            'warning': '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>',
            'info': '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
        };
        return icons[type] || icons.info;
    }
};

// ページ初期化
document.addEventListener('DOMContentLoaded', function() {
    // エントリー編集フォームのイベントリスナー
    const editForm = document.getElementById('edit-entry-form');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault(); // デフォルトのフォーム送信を防ぐ
            
            const entryId = this.dataset.entryId; // フォームにentry-idデータ属性が必要
            if (entryId) {
                saveEditEntry(entryId);
            } else {
                console.error('エントリーIDが見つかりません');
            }
        });
    }
    console.log('ノート詳細ページが初期化されました');
    
    // 詳細セクションの状態復元
    restoreDetailSectionState();
    
    // フィルター機能の初期化
    setupFilters();
    
    // URLパラメータからフィルターを復元
    restoreFiltersFromUrl();
    
    // エントリータイプボタンのイベントリスナー設定
    setupEntryTypeButtons();
    
    // フォーム送信時の処理
    setupFormSubmission();
    
    // ★yfinance連携の初期化
    setupYfinanceIntegration();
    
    console.log('初期化完了');
});

function setupYfinanceIntegration() {
    console.log('yfinance連携を初期化');
    
    // 新規エントリー作成時の銘柄コード入力
    const stockCodeInput = document.getElementById('stock_code');
    if (stockCodeInput) {
        stockCodeInput.addEventListener('input', debounce(function() {
            const stockCode = this.value.trim();
            if (stockCode && /^\d{4}$/.test(stockCode)) {
                fetchCompanyNameFromStockCode(stockCode, 'company_name', 'stock-code-loading');
            }
        }, 1000));
    }
    
    // エントリー編集時の銘柄コード入力
    const editStockCodeInput = document.getElementById('edit_stock_code');
    if (editStockCodeInput) {
        editStockCodeInput.addEventListener('input', debounce(function() {
            const stockCode = this.value.trim();
            if (stockCode && /^\d{4}$/.test(stockCode)) {
                fetchCompanyNameFromStockCode(stockCode, 'edit_company_name', 'edit-stock-code-loading');
            }
        }, 1000));
    }
}

function fetchCompanyNameFromStockCode(stockCode, companyNameFieldId, loadingElementId) {
    console.log('企業名を取得中:', stockCode);
    
    const companyNameField = document.getElementById(companyNameFieldId);
    const loadingElement = document.getElementById(loadingElementId);
    
    if (!companyNameField) {
        console.error('企業名フィールドが見つかりません:', companyNameFieldId);
        return;
    }
    
    // ローディング表示
    if (loadingElement) {
        loadingElement.classList.remove('hidden');
    }
    
    // yfinance APIを呼び出し
    fetch(`/notes/api/company-name/?stock_code=${encodeURIComponent(stockCode)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.company_name) {
                companyNameField.value = data.company_name;
                companyNameField.classList.add('border-green-500');
                setTimeout(() => {
                    companyNameField.classList.remove('border-green-500');
                }, 2000);
                
                NotificationManager.show(`企業名を取得しました: ${data.company_name}`, 'success', 2000);
            } else {
                console.warn('企業名が取得できませんでした:', data.error);
                NotificationManager.show(data.error || '企業名が取得できませんでした', 'warning', 3000);
            }
        })
        .catch(error => {
            console.error('yfinance API エラー:', error);
            NotificationManager.show('企業名の取得に失敗しました', 'error', 3000);
        })
        .finally(() => {
            // ローディング非表示
            if (loadingElement) {
                loadingElement.classList.add('hidden');
            }
        });
}

// デバウンス関数（入力の頻度制限）
function debounce(func, delay) {
    let timeoutId;
    return function (...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
    };
}

// ========================================
// ★エントリー編集機能（新規追加）
// ========================================

function editEntry(entryId) {
    console.log('エントリー編集開始:', entryId);
    
    // エントリー編集データを取得
    fetch(`/notes/entry/${entryId}/edit/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // 編集フォームにデータを設定
            populateEditForm(data.entry, data.sub_notebooks);
            
            // フォーム送信イベントを設定
            setupEditFormSubmission(entryId);
            
            // モーダルを表示
            showModal('entry-edit-modal');
        } else {
            throw new Error(data.error || 'エントリー編集データの取得に失敗しました');
        }
    })
    .catch(error => {
        console.error('エントリー編集データ取得エラー:', error);
        showNotification(error.message, 'error');
    });
}

function openEntryEditModal() {
    console.log('エントリー編集モーダルを開く');
    const modal = document.getElementById('entry-edit-modal');
    if (modal) {
        modal.classList.remove('hidden');
    }
}

function closeEntryEditModal() {
    console.log('エントリー編集モーダルを閉じる');
    const modal = document.getElementById('entry-edit-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
    editingEntryId = null;
}

function setupEditFormSubmission() {
    const form = document.getElementById('entry-edit-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!editingEntryId) {
                NotificationManager.show('編集するエントリーが指定されていません', 'error');
                return;
            }
            
            // フォームデータを収集
            const formData = new FormData(this);
            const contentData = collectEditFormData();
            formData.append('content', JSON.stringify(contentData));
            
            // 送信ボタンを無効化
            const submitButton = form.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = `
                    <svg class="animate-spin h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    保存中...
                `;
            }
            
            // エントリー更新APIを呼び出し
            fetch(`/notes/entry/${editingEntryId}/edit/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    NotificationManager.show(data.message, 'success');
                    closeEntryEditModal();
                    
                    // ページをリロードして更新内容を反映
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    throw new Error(data.error || 'エントリーの更新に失敗しました');
                }
            })
            .catch(error => {
                console.error('エントリー更新エラー:', error);
                NotificationManager.show(error.message, 'error');
            })
            .finally(() => {
                // ボタンを元に戻す
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = `
                        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        変更を保存
                    `;
                }
            });
        });
    }
}

function collectEditFormData() {
    const contentData = {};
    
    // エントリータイプ固有のフィールドを収集
    const typeForm = document.getElementById('edit-entry-type-form');
    if (typeForm) {
        const inputs = typeForm.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
            if (input.value.trim()) {
                contentData[input.name] = input.value;
            }
        });
    }
    
    // エントリータイプに応じて構造化
    const entryType = document.getElementById('edit_entry_type').value;
    
    // key_metricsを別途作成（ANALYSIS用）
    if (entryType === 'ANALYSIS') {
        contentData.key_metrics = {};
        ['revenue', 'operating_profit', 'net_income', 'eps'].forEach(key => {
            if (contentData[key]) {
                contentData.key_metrics[key] = contentData[key];
                delete contentData[key];
            }
        });
    }
    
    return contentData;
}

function populateEditForm(entryData, subNotebooks) {
    console.log('編集フォームにデータを設定:', entryData);
    
    // 基本情報
    document.getElementById('edit_entry_type').value = entryData.entry_type;
    document.getElementById('edit_entry_title').value = entryData.title;
    document.getElementById('edit_stock_code').value = entryData.stock_code;
    document.getElementById('edit_company_name').value = entryData.company_name;
    document.getElementById('edit_event_date').value = entryData.event_date;
    document.getElementById('edit_is_important').checked = entryData.is_important;
    document.getElementById('edit_is_bookmarked').checked = entryData.is_bookmarked;
    
    // サブノート選択肢を更新
    const subNotebookSelect = document.getElementById('edit_sub_notebook');
    subNotebookSelect.innerHTML = '<option value="">サブノートを選択（任意）</option>';
    subNotebooks.forEach(sub => {
        const option = document.createElement('option');
        option.value = sub.id;
        option.textContent = sub.title;
        if (sub.id === entryData.sub_notebook) {
            option.selected = true;
        }
        subNotebookSelect.appendChild(option);
    });
    
    // エントリータイプ固有フォームを生成
    generateEditEntryTypeForm(entryData.entry_type, entryData.content);
}

// ========================================
// エントリー編集用フォーム生成関数
// ========================================

function generateEditEntryTypeForm(entryType, existingContent = {}) {
    console.log('エントリータイプフォーム生成:', entryType, existingContent);
    
    switch (entryType) {
        case 'ANALYSIS':
            return generateEditAnalysisForm(existingContent);
        case 'NEWS':
            return generateEditNewsForm(existingContent);
        case 'MEMO':
            return generateEditMemoForm(existingContent);
        case 'GOAL':
            return generateEditGoalForm(existingContent);
        case 'EARNINGS':
            return generateEditEarningsForm(existingContent);
        case 'IR_EVENT':
            return generateEditIrEventForm(existingContent);
        case 'MARKET_EVENT':
            return generateEditMarketEventForm(existingContent);
        default:
            return generateEditDefaultForm(existingContent);
    }
}

function generateEditAnalysisForm(content = {}) {
    return `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">サマリー</label>
                <textarea name="summary" 
                         class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                         rows="3" 
                         placeholder="決算結果の要約を記述してください">${content.summary || ''}</textarea>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">売上高</label>
                    <input type="text" name="revenue" 
                           value="${content.key_metrics?.revenue || ''}"
                           class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="例: 1,500億円">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">営業利益</label>
                    <input type="text" name="operating_profit" 
                           value="${content.key_metrics?.operating_profit || ''}"
                           class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="例: 200億円">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">純利益</label>
                    <input type="text" name="net_income" 
                           value="${content.key_metrics?.net_income || ''}"
                           class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="例: 150億円">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">EPS</label>
                    <input type="text" name="eps" 
                           value="${content.key_metrics?.eps || ''}"
                           class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="例: 120円">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">分析</label>
                <textarea name="analysis" 
                         class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                         rows="4" 
                         placeholder="決算内容の詳細分析を記述してください">${content.analysis || ''}</textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">今後の見通し</label>
                <textarea name="outlook" 
                         class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                         rows="3" 
                         placeholder="今後の業績見通しや注目ポイントを記述してください">${content.outlook || ''}</textarea>
            </div>
        </div>
    `;
}

function generateEditNewsForm(content = {}) {
    return `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">ヘッドライン</label>
                <input type="text" name="headline" 
                       value="${content.headline || ''}"
                       class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="ニュースのタイトルを入力してください">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">ニュース内容</label>
                <textarea name="content" 
                         class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                         rows="4" 
                         placeholder="ニュースの詳細内容を記述してください">${content.content || ''}</textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">事業への影響</label>
                <textarea name="impact" 
                         class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                         rows="3" 
                         placeholder="このニュースが事業に与える影響を分析してください">${content.impact || ''}</textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">株価への影響</label>
                <textarea name="stock_impact" 
                         class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                         rows="3" 
                         placeholder="株価に与える影響を分析してください">${content.stock_impact || ''}</textarea>
            </div>
        </div>
    `;
}

function generateEditMemoForm(content = {}) {
    return `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">観察事項</label>
                <textarea name="observation" 
                         class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                         rows="4" 
                         placeholder="気づいたことや観察事項を記録してください">${content.observation || ''}</textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">市場トレンド</label>
                <textarea name="market_trend" 
                         class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                         rows="3" 
                         placeholder="関連する市場トレンドについて記述してください">${content.market_trend || ''}</textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">個人的メモ</label>
                <textarea name="personal_note" 
                         class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                         rows="3" 
                         placeholder="個人的な考えやメモを記録してください">${content.personal_note || ''}</textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">次のアクション</label>
                <textarea name="next_action" 
                         class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                         rows="2" 
                         placeholder="今後取るべきアクションを記述してください">${content.next_action || ''}</textarea>
            </div>
        </div>
    `;
}

function generateEditGoalForm(content = {}) {
    return `
        <div class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">目標株価</label>
                    <input type="text" name="target_price" 
                           value="${content.target_price || ''}"
                           class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="例: 3,500円">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">売却タイミング</label>
                    <input type="text" name="sell_timing" 
                           value="${content.sell_timing || ''}"
                           class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="例: 目標株価到達時">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">投資理由</label>
                <textarea name="investment_reason" 
                         class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                         rows="4" 
                         placeholder="なぜこの投資目標を設定したかの理由を記述してください">${content.investment_reason || ''}</textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">期待される効果</label>
                <textarea name="expected_effect" 
                         class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                         rows="3" 
                         placeholder="この投資から期待される効果を記述してください">${content.expected_effect || ''}</textarea>
            </div>
        </div>
    `;
}

function generateEditEarningsForm(content = {}) {
    return `
        <div class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">決算発表日</label>
                    <input type="date" name="earnings_date" 
                           value="${content.earnings_date || ''}"
                           class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">対象四半期</label>
                    <input type="text" name="quarter" 
                           value="${content.quarter || ''}"
                           class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="例: 2025年Q1">
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">事前予想</label>
                <textarea name="expectations" 
                         class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                         rows="3" 
                         placeholder="決算発表前の市場予想や期待値を記述してください">${content.expectations || ''}</textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">注目ポイント</label>
                <textarea name="key_criteria" 
                         class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                         rows="3" 
                         placeholder="決算で特に注目すべきポイントを記述してください">${content.key_criteria || ''}</textarea>
            </div>
        </div>
    `;
}

function generateEditIrEventForm(content = {}) {
    return `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">イベント名</label>
                <input type="text" name="event_name" 
                       value="${content.event_name || ''}"
                       class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="例: 中期経営計画説明会">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">開催日時</label>
                <input type="datetime-local" name="event_datetime" 
                       value="${content.event_datetime || ''}"
                       class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">アジェンダ</label>
                <textarea name="agenda" 
                         class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                         rows="3" 
                         placeholder="イベントのアジェンダや内容を記述してください">${content.agenda || ''}</textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">主要なポイント</label>
                <textarea name="key_takeaways" 
                         class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                         rows="4" 
                         placeholder="イベントから得られた主要なポイントを記述してください">${content.key_takeaways || ''}</textarea>
            </div>
        </div>
    `;
}

function generateEditMarketEventForm(content = {}) {
    return `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">イベントタイトル</label>
                <input type="text" name="event_title" 
                       value="${content.event_title || ''}"
                       class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="例: 日銀金融政策決定会合">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">イベント日</label>
                <input type="date" name="event_date" 
                       value="${content.event_date || ''}"
                       class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">市場への影響</label>
                <textarea name="market_impact" 
                         class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                         rows="3" 
                         placeholder="このイベントが市場全体に与える影響を記述してください">${content.market_impact || ''}</textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">セクターへの影響</label>
                <textarea name="sector_impact" 
                         class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                         rows="3" 
                         placeholder="特定のセクターへの影響を記述してください">${content.sector_impact || ''}</textarea>
            </div>
        </div>
    `;
}

function generateEditDefaultForm(content = {}) {
    return `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">内容</label>
                <textarea name="content_text" 
                         class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                         rows="6" 
                         placeholder="エントリーの内容を記述してください">${JSON.stringify(content, null, 2)}</textarea>
            </div>
        </div>
    `;
}

// ========================================
// フォームデータ収集関数
// ========================================

function collectEditFormData(entryType) {
    const formData = new FormData();
    const form = document.getElementById('entry-edit-form'); // HTMLのIDに合わせて修正
    
    if (!form) {
        console.error('編集フォームが見つかりません');
        return null;
    }
    
    // 基本フィールドの収集
    const basicFields = ['entry_type', 'title', 'stock_code', 'company_name', 'sub_notebook', 'event_date'];
    basicFields.forEach(field => {
        const element = form.querySelector(`[name="${field}"]`);
        if (element) {
            formData.append(field, element.value);
        }
    });
    
    // チェックボックスの処理
    const checkboxFields = ['is_important', 'is_bookmarked'];
    checkboxFields.forEach(field => {
        const element = form.querySelector(`[name="${field}"]`);
        if (element && element.checked) {
            formData.append(field, 'on');
        }
    });
    
    // エントリータイプ別のコンテンツ収集
    const content = collectEntryTypeContent(entryType, form);
    formData.append('content', JSON.stringify(content));
    
    return formData;
}

// ========================================
// エントリー編集保存処理
// ========================================

function saveEditEntry(entryId) {
    const form = document.getElementById('entry-edit-form'); // HTMLのIDに合わせて修正
    if (!form) {
        console.error('編集フォームが見つかりません');
        return;
    }
    
    const entryType = form.querySelector('[name="entry_type"]')?.value;
    if (!entryType) {
        showNotification('エントリータイプが選択されていません', 'error');
        return;
    }
    
    // 保存ボタンを無効化
    const saveButton = form.querySelector('button[type="submit"]');
    if (saveButton) {
        saveButton.disabled = true;
        saveButton.innerHTML = '<span class="animate-spin mr-2">⟳</span>保存中...';
    }
    
    try {
        const formData = collectEditFormData(entryType);
        if (!formData) {
            throw new Error('フォームデータの収集に失敗しました');
        }
        
        // 正しいエントリー編集URLにPOST
        const editUrl = `/notes/entry/${entryId}/edit/`;
        
        fetch(editUrl, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showNotification(data.message || 'エントリーを更新しました', 'success');
                closeEntryEditModal(); // 関数名を正しく修正
                // エントリー一覧を更新
                refreshEntryList();
            } else {
                throw new Error(data.error || 'エントリーの更新に失敗しました');
            }
        })
        .catch(error => {
            console.error('エントリー編集エラー:', error);
            showNotification(error.message, 'error');
        })
        .finally(() => {
            // 保存ボタンを有効化
            if (saveButton) {
                saveButton.disabled = false;
                saveButton.innerHTML = `
                    <svg class="h-3 w-3 md:h-4 md:w-4 mr-1 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="hidden sm:inline">変更を保存</span>
                    <span class="sm:hidden">保存</span>
                `;
            }
        });
        
    } catch (error) {
        console.error('エントリー編集処理エラー:', error);
        showNotification(error.message, 'error');
        
        // 保存ボタンを有効化
        if (saveButton) {
            saveButton.disabled = false;
            saveButton.innerHTML = `
                <svg class="h-3 w-3 md:h-4 md:w-4 mr-1 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span class="hidden sm:inline">変更を保存</span>
                <span class="sm:hidden">保存</span>
            `;
        }
    }
}

// CSRFトークン取得
function getCsrfToken() {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }
    // CSRFトークンが見つからない場合は、metaタグから取得
    const csrfMeta = document.querySelector('meta[name="csrf-token"]');
    if (csrfMeta) {
        return csrfMeta.getAttribute('content');
    }
    return '';
}

// エントリー一覧の更新
function refreshEntryList() {
    // ページをリロードしてエントリー一覧を更新
    window.location.reload();
}

// ========================================
// フォーム送信イベントの設定
// ========================================

// DOMが読み込まれた後にイベントリスナーを設定
document.addEventListener('DOMContentLoaded', function() {
    console.log('エントリー編集機能を初期化中...');
    
    // エントリー編集フォームのイベントリスナー設定
    setupEditFormEventListeners();
});

function setupEditFormEventListeners() {
    // フォーム送信イベントの設定は動的に行う（モーダルが開かれた時）
    console.log('エントリー編集フォームのイベントリスナーを設定準備完了');
}

// モーダルが開かれた時に呼び出される関数
function setupEditFormSubmission(entryId) {
    const form = document.getElementById('entry-edit-form');
    if (!form) {
        console.error('編集フォームが見つかりません');
        return;
    }
    
    // 既存のイベントリスナーを削除
    const newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);
    
    // 新しいイベントリスナーを追加
    newForm.addEventListener('submit', function(e) {
        e.preventDefault(); // デフォルトのフォーム送信を防ぐ
        console.log('エントリー編集フォーム送信:', entryId);
        saveEditEntry(entryId);
    });
    
    console.log('エントリー編集フォームの送信イベントを設定しました:', entryId);
}

// ========================================
// モーダル操作関数
// ========================================

function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        // フェードイン効果
        setTimeout(() => {
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
                modalContent.classList.add('scale-100', 'opacity-100');
                modalContent.classList.remove('scale-95', 'opacity-0');
            }
        }, 10);
        
        // Escキーでモーダルを閉じる
        document.addEventListener('keydown', handleModalEscape);
    } else {
        console.error('モーダルが見つかりません:', modalId);
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        const modalContent = modal.querySelector('.modal-content');
        if (modalContent) {
            modalContent.classList.add('scale-95', 'opacity-0');
            modalContent.classList.remove('scale-100', 'opacity-100');
        }
        
        // アニメーション完了後にモーダルを非表示
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }, 150);
        
        // Escキーイベントリスナーを削除
        document.removeEventListener('keydown', handleModalEscape);
    }
}

function closeEntryEditModal() {
    closeModal('entry-edit-modal');
}

function handleModalEscape(e) {
    if (e.key === 'Escape') {
        // 現在表示されているモーダルを閉じる
        const visibleModals = document.querySelectorAll('.modal:not(.hidden)');
        visibleModals.forEach(modal => {
            closeModal(modal.id);
        });
    }
}

// ========================================
// 通知機能
// ========================================

function showNotification(message, type = 'info') {
    // 既存の通知を削除
    const existingNotification = document.getElementById('notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    // 通知の色を決定
    let bgColor, borderColor, textColor;
    switch (type) {
        case 'success':
            bgColor = 'bg-green-800';
            borderColor = 'border-green-600';
            textColor = 'text-green-100';
            break;
        case 'error':
            bgColor = 'bg-red-800';
            borderColor = 'border-red-600';
            textColor = 'text-red-100';
            break;
        case 'warning':
            bgColor = 'bg-yellow-800';
            borderColor = 'border-yellow-600';
            textColor = 'text-yellow-100';
            break;
        default:
            bgColor = 'bg-blue-800';
            borderColor = 'border-blue-600';
            textColor = 'text-blue-100';
    }
    
    // 通知要素を作成
    const notification = document.createElement('div');
    notification.id = 'notification';
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg border ${bgColor} ${borderColor} ${textColor} shadow-lg max-w-sm transition-all duration-300 transform translate-x-full opacity-0`;
    notification.innerHTML = `
        <div class="flex items-center">
            <div class="flex-1">
                <p class="font-medium">${message}</p>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-current hover:opacity-75">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    `;
    
    // ページに追加
    document.body.appendChild(notification);
    
    // アニメーション実行
    setTimeout(() => {
        notification.classList.remove('translate-x-full', 'opacity-0');
        notification.classList.add('translate-x-0', 'opacity-100');
    }, 10);
    
    // 3秒後に自動削除
    setTimeout(() => {
        if (notification.parentElement) {
            notification.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }
    }, 3000);
}

// ========================================
// エントリー編集フォーム入力処理
// ========================================

function populateEditForm(entryData, subNotebooks) {
    console.log('エントリー編集フォームにデータを設定:', entryData);
    
    try {
        // 基本情報の設定
        const form = document.getElementById('entry-edit-form');
        if (!form) {
            throw new Error('編集フォームが見つかりません');
        }
        
        // エントリータイプ
        const entryTypeSelect = form.querySelector('[name="entry_type"]');
        if (entryTypeSelect) {
            entryTypeSelect.value = entryData.entry_type;
        }
        
        // タイトル
        const titleInput = form.querySelector('[name="title"]');
        if (titleInput) {
            titleInput.value = entryData.title || '';
        }
        
        // 銘柄情報
        const stockCodeInput = form.querySelector('[name="stock_code"]');
        if (stockCodeInput) {
            stockCodeInput.value = entryData.stock_code || '';
        }
        
        const companyNameInput = form.querySelector('[name="company_name"]');
        if (companyNameInput) {
            companyNameInput.value = entryData.company_name || '';
        }
        
        // イベント日
        const eventDateInput = form.querySelector('[name="event_date"]');
        if (eventDateInput) {
            eventDateInput.value = entryData.event_date || '';
        }
        
        // サブノート選択肢を設定
        const subNotebookSelect = form.querySelector('[name="sub_notebook"]');
        if (subNotebookSelect && subNotebooks) {
            subNotebookSelect.innerHTML = '<option value="">サブノートを選択（任意）</option>';
            subNotebooks.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.id;
                option.textContent = sub.title;
                option.selected = entryData.sub_notebook === sub.id;
                subNotebookSelect.appendChild(option);
            });
        }
        
        // チェックボックス
        const importantCheckbox = form.querySelector('[name="is_important"]');
        if (importantCheckbox) {
            importantCheckbox.checked = entryData.is_important || false;
        }
        
        const bookmarkedCheckbox = form.querySelector('[name="is_bookmarked"]');
        if (bookmarkedCheckbox) {
            bookmarkedCheckbox.checked = entryData.is_bookmarked || false;
        }
        
        // エントリータイプ別フォームを生成
        generateEditEntryTypeForm(entryData.entry_type, entryData.content);
        
        console.log('エントリー編集フォームのデータ設定完了');
        
    } catch (error) {
        console.error('エントリー編集フォーム設定エラー:', error);
        showNotification('フォームの初期化に失敗しました', 'error');
    }
}

function generateEditEntryTypeForm(entryType, existingContent = {}) {
    console.log('エントリータイプフォーム生成:', entryType, existingContent);
    
    const container = document.getElementById('edit-entry-type-form');
    if (!container) {
        console.error('エントリータイプフォームコンテナが見つかりません');
        return;
    }
    
    let formHtml = '';
    
    switch (entryType) {
        case 'ANALYSIS':
            formHtml = generateEditAnalysisForm(existingContent);
            break;
        case 'NEWS':
            formHtml = generateEditNewsForm(existingContent);
            break;
        case 'MEMO':
            formHtml = generateEditMemoForm(existingContent);
            break;
        case 'GOAL':
            formHtml = generateEditGoalForm(existingContent);
            break;
        case 'EARNINGS':
            formHtml = generateEditEarningsForm(existingContent);
            break;
        case 'IR_EVENT':
            formHtml = generateEditIrEventForm(existingContent);
            break;
        case 'MARKET_EVENT':
            formHtml = generateEditMarketEventForm(existingContent);
            break;
        default:
            formHtml = generateEditDefaultForm(existingContent);
            break;
    }
    
    container.innerHTML = formHtml;
    console.log('エントリータイプフォーム生成完了');
}

function collectEntryTypeContent(entryType, form) {
    const content = {};
    
    switch (entryType) {
        case 'ANALYSIS':
            content.summary = form.querySelector('[name="summary"]')?.value || '';
            content.key_metrics = {
                revenue: form.querySelector('[name="revenue"]')?.value || '',
                operating_profit: form.querySelector('[name="operating_profit"]')?.value || '',
                net_income: form.querySelector('[name="net_income"]')?.value || '',
                eps: form.querySelector('[name="eps"]')?.value || ''
            };
            content.analysis = form.querySelector('[name="analysis"]')?.value || '';
            content.outlook = form.querySelector('[name="outlook"]')?.value || '';
            break;
            
        case 'NEWS':
            content.headline = form.querySelector('[name="headline"]')?.value || '';
            content.content = form.querySelector('[name="content"]')?.value || '';
            content.impact = form.querySelector('[name="impact"]')?.value || '';
            content.stock_impact = form.querySelector('[name="stock_impact"]')?.value || '';
            break;
            
        case 'MEMO':
            content.observation = form.querySelector('[name="observation"]')?.value || '';
            content.market_trend = form.querySelector('[name="market_trend"]')?.value || '';
            content.personal_note = form.querySelector('[name="personal_note"]')?.value || '';
            content.next_action = form.querySelector('[name="next_action"]')?.value || '';
            break;
            
        case 'GOAL':
            content.target_price = form.querySelector('[name="target_price"]')?.value || '';
            content.sell_timing = form.querySelector('[name="sell_timing"]')?.value || '';
            content.investment_reason = form.querySelector('[name="investment_reason"]')?.value || '';
            content.expected_effect = form.querySelector('[name="expected_effect"]')?.value || '';
            break;
            
        case 'EARNINGS':
            content.earnings_date = form.querySelector('[name="earnings_date"]')?.value || '';
            content.quarter = form.querySelector('[name="quarter"]')?.value || '';
            content.expectations = form.querySelector('[name="expectations"]')?.value || '';
            content.key_criteria = form.querySelector('[name="key_criteria"]')?.value || '';
            break;
            
        case 'IR_EVENT':
            content.event_name = form.querySelector('[name="event_name"]')?.value || '';
            content.event_datetime = form.querySelector('[name="event_datetime"]')?.value || '';
            content.agenda = form.querySelector('[name="agenda"]')?.value || '';
            content.key_takeaways = form.querySelector('[name="key_takeaways"]')?.value || '';
            break;
            
        case 'MARKET_EVENT':
            content.event_title = form.querySelector('[name="event_title"]')?.value || '';
            content.event_date = form.querySelector('[name="event_date"]')?.value || '';
            content.market_impact = form.querySelector('[name="market_impact"]')?.value || '';
            content.sector_impact = form.querySelector('[name="sector_impact"]')?.value || '';
            break;
            
        default:
            content.content_text = form.querySelector('[name="content_text"]')?.value || '';
            break;
    }
    
    return content;
}

// ========================================
// 詳細セクション展開機能
// ========================================

function toggleDetailSection() {
    const section = document.getElementById('detail-section');
    const content = document.getElementById('detail-content');
    const button = document.getElementById('detail-expand-btn');
    const chevron = button.querySelector('.chevron');
    const buttonText = button.querySelector('span');
    
    const isExpanded = content.classList.contains('expanded');
    
    if (isExpanded) {
        // 折りたたみ
        content.classList.remove('expanded');
        section.classList.remove('expanded');
        button.classList.remove('expanded');
        buttonText.textContent = 'ノート詳細情報を表示';
        
        // ローカルストレージに状態を保存
        localStorage.setItem('notebookDetailExpanded', 'false');
    } else {
        // 展開
        content.classList.add('expanded');
        section.classList.add('expanded');
        button.classList.add('expanded');
        buttonText.textContent = 'ノート詳細情報を隠す';
        
        // ローカルストレージに状態を保存
        localStorage.setItem('notebookDetailExpanded', 'true');
    }
    
    console.log('詳細セクション状態:', isExpanded ? '折りたたみ' : '展開');
}

// ページ読み込み時に前回の状態を復元
function restoreDetailSectionState() {
    const savedState = localStorage.getItem('notebookDetailExpanded');
    if (savedState === 'true') {
        const content = document.getElementById('detail-content');
        const section = document.getElementById('detail-section');
        const button = document.getElementById('detail-expand-btn');
        const buttonText = button.querySelector('span');
        
        content.classList.add('expanded');
        section.classList.add('expanded');
        button.classList.add('expanded');
        buttonText.textContent = 'ノート詳細情報を隠す';
    }
}

// ========================================
// エントリーブックマーク機能（修正版）
// ========================================

function toggleEntryBookmark(entryId) {
    console.log('エントリーブックマーク切り替え:', entryId);
    
    // ボタンを無効化
    const buttons = document.querySelectorAll(`[onclick*="toggleEntryBookmark('${entryId}')"]`);
    buttons.forEach(button => {
        button.style.pointerEvents = 'none';
        button.classList.add('opacity-50');
    });
    
    fetch(`/notes/entry/${entryId}/bookmark/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ボタンの見た目を更新
            updateBookmarkButtons(entryId, data.is_bookmarked);
            
            // 成功メッセージを表示
            NotificationManager.show(data.message, 'success');
        } else {
            throw new Error(data.error || 'ブックマーク更新に失敗しました');
        }
    })
    .catch(error => {
        console.error('ブックマーク更新エラー:', error);
        NotificationManager.show(error.message, 'error');
    })
    .finally(() => {
        // ボタンを有効化
        buttons.forEach(button => {
            button.style.pointerEvents = 'auto';
            button.classList.remove('opacity-50');
        });
    });
}

function updateBookmarkButtons(entryId, isBookmarked) {
    // カード内のブックマークボタン
    const cardButton = document.querySelector(`[data-entry-id="${entryId}"] .bookmark-icon`);
    if (cardButton) {
        const svg = cardButton.querySelector('svg');
        if (svg) {
            if (isBookmarked) {
                cardButton.classList.add('active');
                svg.setAttribute('fill', 'currentColor');
            } else {
                cardButton.classList.remove('active');
                svg.setAttribute('fill', 'none');
            }
        }
    }
    
    // モーダル内のブックマークボタン（あれば）
    const modalButton = document.querySelector(`#entry-detail-modal [onclick*="toggleEntryBookmark('${entryId}')"]`);
    if (modalButton) {
        const svg = modalButton.querySelector('svg');
        const span = modalButton.querySelector('span') || modalButton.lastChild;
        
        if (svg) {
            svg.setAttribute('fill', isBookmarked ? 'currentColor' : 'none');
        }
        
        if (span && span.nodeType === Node.TEXT_NODE) {
            span.textContent = isBookmarked ? 'ブックマーク済み' : 'ブックマーク';
        }
    }
}

// ========================================
// エントリー削除機能（新規追加）
// ========================================

function deleteEntry(entryId) {
    console.log('エントリー削除:', entryId);
    
    // 確認ダイアログ
    if (!confirm('このエントリーを削除してもよろしいですか？\n削除後は元に戻せません。')) {
        return;
    }
    
    // 削除ボタンを無効化
    const deleteButtons = document.querySelectorAll(`[onclick*="deleteEntry('${entryId}')"]`);
    deleteButtons.forEach(button => {
        button.disabled = true;
        button.innerHTML = `
            <svg class="animate-spin h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            削除中...
        `;
    });
    
    fetch(`/notes/entry/${entryId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 成功メッセージを表示
            NotificationManager.show(data.message, 'success');
            
            // エントリーカードを削除
            const entryCard = document.querySelector(`[data-entry-id="${entryId}"]`);
            if (entryCard) {
                entryCard.style.transition = 'all 0.3s ease-out';
                entryCard.style.opacity = '0';
                entryCard.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    entryCard.remove();
                    updateEntriesCount();
                }, 300);
            }
            
            // モーダルが開いている場合は閉じる
            const modal = document.getElementById('entry-detail-modal');
            if (modal && !modal.classList.contains('hidden')) {
                closeEntryDetail();
            }
            
            // 編集モーダルが開いている場合は閉じる
            const editModal = document.getElementById('entry-edit-modal');
            if (editModal && !editModal.classList.contains('hidden')) {
                closeEntryEditModal();
            }
            
            // 1秒後にページをリロード（統計更新のため）
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            throw new Error(data.error || 'エントリーの削除に失敗しました');
        }
    })
    .catch(error => {
        console.error('エントリー削除エラー:', error);
        NotificationManager.show(error.message, 'error');
        
        // ボタンを元に戻す
        deleteButtons.forEach(button => {
            button.disabled = false;
            button.innerHTML = `
                <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                削除
            `;
        });
    });
}

// ========================================
// エントリー詳細モーダル機能（修正版）
// ========================================

function openEntryDetail(entryId) {
    console.log('エントリー詳細表示:', entryId);
    
    const modal = document.getElementById('entry-detail-modal');
    if (!modal) {
        console.error('エントリー詳細モーダルが見つかりません');
        return;
    }
    
    // モーダルを表示
    modal.classList.remove('hidden');
    
    // ローディング表示
    updateEntryDetailModal('読み込み中...', `
        <div class="flex items-center justify-center py-8">
            <svg class="animate-spin h-8 w-8 text-blue-400" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="ml-2 text-gray-400">読み込み中...</span>
        </div>
    `);
    
    // エントリー詳細をAjaxで取得して表示
    fetch(`/notes/entry/${entryId}/`)
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('エントリー詳細取得成功:', data);
            if (data.success) {
                updateEntryDetailModal(data.title, data.html);
                
                // モーダル内のブックマークボタンに現在のentryIdを設定
                const bookmarkButton = document.querySelector('#entry-detail-modal [onclick*="toggleEntryBookmark"]');
                if (bookmarkButton) {
                    bookmarkButton.setAttribute('onclick', `toggleEntryBookmark('${entryId}')`);
                }
                
                // モーダル内の削除ボタンに現在のentryIdを設定
                const deleteButton = document.querySelector('#entry-detail-modal [onclick*="deleteEntry"]');
                if (deleteButton) {
                    deleteButton.setAttribute('onclick', `deleteEntry('${entryId}')`);
                }
                
                // モーダル内の編集ボタンに現在のentryIdを設定
                const editButton = document.querySelector('#entry-detail-modal [onclick*="editEntry"]');
                if (editButton) {
                    editButton.setAttribute('onclick', `editEntry('${entryId}')`);
                }
            } else {
                throw new Error(data.error || 'データの取得に失敗しました');
            }
        })
        .catch(error => {
            console.error('エントリー詳細取得エラー:', error);
            const errorHtml = `
                <div class="text-center py-8">
                    <div class="text-red-400 mb-2">エントリーの詳細を取得できませんでした</div>
                    <div class="text-gray-400 text-sm">${escapeHtml(error.message)}</div>
                    <button onclick="closeEntryDetail()" class="mt-4 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded">
                        閉じる
                    </button>
                </div>
            `;
            updateEntryDetailModal('エラー', errorHtml);
        });
}

function closeEntryDetail() {
    console.log('エントリー詳細モーダルを閉じます');
    const modal = document.getElementById('entry-detail-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

function updateEntryDetailModal(title, content) {
    const titleElement = document.getElementById('entry-detail-title');
    const contentElement = document.getElementById('entry-detail-content');
    
    if (titleElement) titleElement.textContent = title;
    if (contentElement) contentElement.innerHTML = content;
}


function closeEntryDetail() {
    console.log('エントリー詳細モーダルを閉じます');
    const modal = document.getElementById('entry-detail-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

function updateEntryDetailModal(title, content) {
    const titleElement = document.getElementById('entry-detail-title');
    const contentElement = document.getElementById('entry-detail-content');
    
    if (titleElement) titleElement.textContent = title;
    if (contentElement) contentElement.innerHTML = content;
}

// ========================================
// フィルター機能
// ========================================

function setupFilters() {
    // エントリータイプフィルター
    const entryTypeFilter = document.getElementById('entry-type-filter');
    if (entryTypeFilter) {
        entryTypeFilter.addEventListener('change', function() {
            currentFilters.entryType = this.value;
            applyFilters();
            updateUrl();
        });
    }
    
    // 銘柄フィルター
    const stockFilter = document.getElementById('stock-filter');
    if (stockFilter) {
        stockFilter.addEventListener('change', function() {
            currentFilters.stockCode = this.value;
            applyFilters();
            updateUrl();
        });
    }
    
    // ソート機能
    const sortOrder = document.getElementById('sort-order');
    if (sortOrder) {
        sortOrder.addEventListener('change', function() {
            applySorting(this.value);
        });
    }
}

function filterBySubNotebook(subNotebookId) {
    console.log('サブノートフィルター:', subNotebookId);
    
    currentFilters.subNotebook = subNotebookId;
    
    // タブの見た目を更新
    document.querySelectorAll('.sub-notebook-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.subNotebook === subNotebookId) {
            tab.classList.add('active');
        }
    });
    
    applyFilters();
    updateUrl();
}

function toggleImportantFilter() {
    const button = document.getElementById('important-filter');
    currentFilters.isImportant = !currentFilters.isImportant;
    
    if (currentFilters.isImportant) {
        button.classList.add('active');
        button.classList.remove('border-gray-600', 'text-gray-300');
        button.classList.add('border-yellow-500', 'bg-yellow-900/30', 'text-yellow-300');
    } else {
        button.classList.remove('active');
        button.classList.add('border-gray-600', 'text-gray-300');
        button.classList.remove('border-yellow-500', 'bg-yellow-900/30', 'text-yellow-300');
    }
    
    applyFilters();
    updateUrl();
}

function toggleBookmarkFilter() {
    const button = document.getElementById('bookmark-filter');
    currentFilters.isBookmarked = !currentFilters.isBookmarked;
    
    if (currentFilters.isBookmarked) {
        button.classList.add('active');
        button.classList.remove('border-gray-600', 'text-gray-300');
        button.classList.add('border-blue-500', 'bg-blue-900/30', 'text-blue-300');
    } else {
        button.classList.remove('active');
        button.classList.add('border-gray-600', 'text-gray-300');
        button.classList.remove('border-blue-500', 'bg-blue-900/30', 'text-blue-300');
    }
    
    applyFilters();
    updateUrl();
}

function applyFilters() {
    const entries = document.querySelectorAll('.entry-card');
    let visibleCount = 0;
    
    entries.forEach(entry => {
        let isVisible = true;
        
        // サブノートフィルター
        if (currentFilters.subNotebook && 
            entry.dataset.subNotebook !== currentFilters.subNotebook) {
            isVisible = false;
        }
        
        // エントリータイプフィルター
        if (currentFilters.entryType && 
            entry.dataset.entryType !== currentFilters.entryType) {
            isVisible = false;
        }
        
        // 銘柄フィルター
        if (currentFilters.stockCode && 
            entry.dataset.stockCode !== currentFilters.stockCode) {
            isVisible = false;
        }
        
        // 重要フラグフィルター
        if (currentFilters.isImportant && 
            entry.dataset.important !== 'true') {
            isVisible = false;
        }
        
        // ブックマークフィルター
        if (currentFilters.isBookmarked && 
            entry.dataset.bookmarked !== 'true') {
            isVisible = false;
        }
        
        // 表示/非表示の設定
        if (isVisible) {
            entry.style.display = 'block';
            visibleCount++;
        } else {
            entry.style.display = 'none';
        }
    });
    
    // エントリー数を更新
    updateEntriesCount(visibleCount);
    
    console.log(`フィルター適用完了: ${visibleCount}件表示`);
}

function applySorting(sortType) {
    const container = document.getElementById('entries-container');
    if (!container) return;
    
    const entries = Array.from(container.querySelectorAll('.entry-card'));
    
    entries.sort((a, b) => {
        switch (sortType) {
            case 'oldest':
                return new Date(a.dataset.created) - new Date(b.dataset.created);
            case 'important':
                // 重要度順（重要なものを先に）
                const aImportant = a.dataset.important === 'true';
                const bImportant = b.dataset.important === 'true';
                if (aImportant && !bImportant) return -1;
                if (!aImportant && bImportant) return 1;
                // 同じ重要度の場合は日付順
                return new Date(b.dataset.created) - new Date(a.dataset.created);
            case 'stock':
                const aStock = a.dataset.stockCode || '';
                const bStock = b.dataset.stockCode || '';
                return aStock.localeCompare(bStock);
            case 'newest':
            default:
                return new Date(b.dataset.created) - new Date(a.dataset.created);
        }
    });
    
    // DOMに再挿入
    entries.forEach(entry => container.appendChild(entry));
    
    console.log('ソート完了:', sortType);
}

function updateEntriesCount(count) {
    const countElement = document.getElementById('entries-count');
    if (countElement) {
        if (count !== undefined) {
            countElement.textContent = `(${count}件)`;
        } else {
            // 表示されているエントリーをカウント
            const visibleEntries = document.querySelectorAll('.entry-card[style*="display: block"], .entry-card:not([style*="display: none"])');
            countElement.textContent = `(${visibleEntries.length}件)`;
        }
    }
}

function updateUrl() {
    const url = new URL(window.location);
    
    // 現在のフィルターをURLに反映
    if (currentFilters.subNotebook) {
        url.searchParams.set('sub_notebook', currentFilters.subNotebook);
    } else {
        url.searchParams.delete('sub_notebook');
    }
    
    if (currentFilters.entryType) {
        url.searchParams.set('entry_type', currentFilters.entryType);
    } else {
        url.searchParams.delete('entry_type');
    }
    
    if (currentFilters.stockCode) {
        url.searchParams.set('stock_code', currentFilters.stockCode);
    } else {
        url.searchParams.delete('stock_code');
    }
    
    // 履歴を更新（ページをリロードしない）
    window.history.replaceState({}, '', url.toString());
}

function restoreFiltersFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // サブノートフィルター復元
    const subNotebook = urlParams.get('sub_notebook');
    if (subNotebook) {
        filterBySubNotebook(subNotebook);
    }
    
    // エントリータイプフィルター復元
    const entryType = urlParams.get('entry_type');
    if (entryType) {
        const filter = document.getElementById('entry-type-filter');
        if (filter) {
            filter.value = entryType;
            currentFilters.entryType = entryType;
        }
    }
    
    // 銘柄フィルター復元
    const stockCode = urlParams.get('stock_code');
    if (stockCode) {
        const filter = document.getElementById('stock-filter');
        if (filter) {
            filter.value = stockCode;
            currentFilters.stockCode = stockCode;
        }
    }
    
    // フィルターを適用
    if (subNotebook || entryType || stockCode) {
        applyFilters();
    }
}

// ========================================
// ユーティリティ関数
// ========================================

function getCsrfToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]');
    return token ? token.value : document.querySelector('meta[name=csrf-token]')?.content || '';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getNotebookId() {
    // データ属性から取得
    const notebookElement = document.querySelector('[data-notebook-id]');
    if (notebookElement) {
        return notebookElement.dataset.notebookId;
    }
    
    // URLパスから取得 (/notes/{notebook_id}/)
    const pathParts = window.location.pathname.split('/');
    const notesIndex = pathParts.indexOf('notes');
    if (notesIndex !== -1 && pathParts[notesIndex + 1]) {
        return pathParts[notesIndex + 1];
    }
    
    console.error('ノートブックIDが取得できませんでした');
    return null;
}

// エントリーカードクリック処理
function handleEntryCardClick(entryId) {
    console.log('エントリーカードクリック:', entryId);
    openEntryDetail(entryId);
}

// ノートお気に入り切り替え
function toggleFavorite() {
    const notebookId = getNotebookId();
    console.log('ノートお気に入り切り替え:', notebookId);
    
    if (!notebookId) {
        NotificationManager.show('ノートブックIDが取得できませんでした', 'error');
        return;
    }
    
    // ボタンを無効化
    const button = document.querySelector('.favorite-star');
    if (button) {
        button.style.pointerEvents = 'none';
    }
    
    fetch(`/notes/${notebookId}/favorite/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ボタンの見た目を更新
            updateFavoriteButton(data.is_favorite);
            
            // 成功メッセージを表示
            NotificationManager.show(data.message, 'success');
        } else {
            throw new Error(data.error || 'お気に入り更新に失敗しました');
        }
    })
    .catch(error => {
        console.error('お気に入り更新エラー:', error);
        NotificationManager.show(error.message, 'error');
    })
    .finally(() => {
        // ボタンを有効化
        if (button) {
            button.style.pointerEvents = 'auto';
        }
    });
}

function updateFavoriteButton(isFavorite) {
    const button = document.querySelector('.favorite-star');
    if (!button) return;
    
    const svg = button.querySelector('svg');
    if (!svg) return;
    
    if (isFavorite) {
        button.classList.add('active');
        svg.setAttribute('fill', 'currentColor');
    } else {
        button.classList.remove('active');
        svg.setAttribute('fill', 'none');
    }
}

// ページネーション関数
function previousPage() {
    const currentUrl = new URL(window.location);
    const currentPage = parseInt(currentUrl.searchParams.get('page') || '1');
    if (currentPage > 1) {
        currentUrl.searchParams.set('page', currentPage - 1);
        window.location.href = currentUrl.toString();
    }
}

function nextPage() {
    const currentUrl = new URL(window.location);
    const currentPage = parseInt(currentUrl.searchParams.get('page') || '1');
    currentUrl.searchParams.set('page', currentPage + 1);
    window.location.href = currentUrl.toString();
}

// ========================================
// モーダル・フォーム関連（新規エントリー作成用）
// ========================================

function openNewEntryModal() {
    console.log('新規エントリーモーダルを開きます');
    const modal = document.getElementById('new-entry-modal');
    if (modal) {
        modal.classList.remove('hidden');
        resetEntryForm();
    }
}

function closeNewEntryModal() {
    console.log('新規エントリーモーダルを閉じます');
    const modal = document.getElementById('new-entry-modal');
    if (modal) {
        modal.classList.add('hidden');
        resetEntryForm();
    }
}

function resetEntryForm() {
    const form = document.getElementById('entry-form');
    if (form) {
        form.reset();
    }
    
    const typeForm = document.getElementById('entry-type-form');
    if (typeForm) {
        typeForm.innerHTML = '';
    }
    
    selectedEntryType = null;
    
    // エントリータイプボタンをリセット
    document.querySelectorAll('.entry-type-btn').forEach(btn => {
        btn.classList.remove('selected', 'border-blue-500', 'bg-blue-900/30');
        btn.classList.add('border-gray-600', 'bg-gray-700');
    });
    
    // 隠しフィールドをクリア
    const hiddenFields = ['entry_type'];
    hiddenFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) field.value = '';
    });
}

function setupEntryTypeButtons() {
    const entryTypeButtons = document.querySelectorAll('.entry-type-btn');
    console.log('エントリータイプボタン数:', entryTypeButtons.length);
    
    entryTypeButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const entryType = this.getAttribute('data-entry-type');
            console.log('エントリータイプ選択:', entryType);
            
            if (entryType) {
                selectEntryType(entryType, this);
            }
        });
    });
}

function selectEntryType(type, buttonElement) {
    console.log('selectEntryType呼び出し:', type);
    selectedEntryType = type;
    
    // hidden inputに値を設定
    const entryTypeInput = document.getElementById('entry_type');
    if (entryTypeInput) {
        entryTypeInput.value = type;
        console.log('エントリータイプ設定完了:', entryTypeInput.value);
    }
    
    // すべてのボタンを未選択状態にリセット
    document.querySelectorAll('.entry-type-btn').forEach(btn => {
        btn.classList.remove('selected', 'border-blue-500', 'bg-blue-900/30');
        btn.classList.add('border-gray-600', 'bg-gray-700');
    });
    
    // 選択されたボタンをハイライト
    if (buttonElement) {
        buttonElement.classList.remove('border-gray-600', 'bg-gray-700');
        buttonElement.classList.add('selected', 'border-blue-500', 'bg-blue-900/30');
        console.log('ボタンハイライト完了');
    }
    
    // エントリータイプ固有フォームを生成
    generateEntryTypeForm(type);
}

function generateEntryTypeForm(type) {
    console.log('フォーム生成:', type);
    const container = document.getElementById('entry-type-form');
    if (!container) {
        console.error('entry-type-form コンテナが見つかりません');
        return;
    }
    
    const formTemplates = {
        'ANALYSIS': generateAnalysisForm(),
        'NEWS': generateNewsForm(),
        'MEMO': generateMemoForm(),
        'GOAL': generateGoalForm(),
        'EARNINGS': generateEarningsForm(),
        'IR_EVENT': generateIREventForm(),
        'MARKET_EVENT': generateMarketEventForm()
    };
    
    container.innerHTML = formTemplates[type] || '<p class="text-gray-400">このエントリータイプのフォームはまだ実装されていません。</p>';
    console.log('フォーム生成完了');
}

function setupFormSubmission() {
    const form = document.getElementById('entry-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('フォーム送信開始');
            
            if (!selectedEntryType) {
                e.preventDefault();
                NotificationManager.show('エントリータイプを選択してください', 'warning');
                return;
            }
            
            if (!document.getElementById('entry_title').value.trim()) {
                e.preventDefault();
                NotificationManager.show('エントリータイトルを入力してください', 'warning');
                return;
            }
            
            // フォームデータをJSONに変換
            const contentData = collectFormData();
            
            // content フィールドにJSONデータを設定
            const contentInput = document.createElement('input');
            contentInput.type = 'hidden';
            contentInput.name = 'content';
            contentInput.value = JSON.stringify(contentData);
            this.appendChild(contentInput);
            
            console.log('Content data:', contentData);
            
            // 送信ボタンを無効化（重複送信防止）
            const submitButton = this.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.textContent = '作成中...';
                
                // 送信後に元に戻す（エラー時のため）
                setTimeout(() => {
                    submitButton.disabled = false;
                    submitButton.innerHTML = `
                        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        エントリーを作成
                    `;
                }, 3000);
            }
        });
    }
}

function collectFormData() {
    const contentData = {};
    
    // エントリータイプ固有のフィールドを収集
    const typeForm = document.getElementById('entry-type-form');
    if (typeForm) {
        const inputs = typeForm.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
            if (input.value.trim()) {
                contentData[input.name] = input.value;
            }
        });
    }
    
    // key_metricsを別途作成（ANALYSIS用）
    if (selectedEntryType === 'ANALYSIS') {
        contentData.key_metrics = {};
        ['revenue', 'operating_profit', 'net_income', 'eps'].forEach(key => {
            if (contentData[key]) {
                contentData.key_metrics[key] = contentData[key];
                delete contentData[key];
            }
        });
    }
    
    // calculationsを別途作成（CALCULATION用）
    if (selectedEntryType === 'CALCULATION') {
        contentData.calculations = {};
        ['per', 'pbr', 'dividend_yield', 'roe'].forEach(key => {
            if (contentData[key]) {
                contentData.calculations[key] = contentData[key];
                delete contentData[key];
            }
        });
    }
    
    return contentData;
}

// サブノート作成機能
function openSubNotebookCreateModal() {
    console.log('サブノート作成モーダルを開きます');
    const modal = document.getElementById('sub-notebook-modal');
    if (modal) {
        modal.classList.remove('hidden');
        resetSubNotebookForm();
    }
}

function closeSubNotebookModal() {
    console.log('サブノート作成モーダルを閉じます');
    const modal = document.getElementById('sub-notebook-modal');
    if (modal) {
        modal.classList.add('hidden');
        resetSubNotebookForm();
    }
}

function resetSubNotebookForm() {
    const titleInput = document.getElementById('sub-notebook-title');
    const descriptionInput = document.getElementById('sub-notebook-description');
    
    if (titleInput) titleInput.value = '';
    if (descriptionInput) descriptionInput.value = '';
}

function createSubNotebook() {
    const titleInput = document.getElementById('sub-notebook-title');
    const descriptionInput = document.getElementById('sub-notebook-description');
    
    const title = titleInput?.value?.trim() || '';
    const description = descriptionInput?.value?.trim() || '';
    
    if (!title) {
        NotificationManager.show('サブノート名を入力してください', 'warning');
        titleInput?.focus();
        return;
    }
    
    // 作成ボタンを無効化
    const createButton = document.querySelector('#sub-notebook-modal button[onclick="createSubNotebook()"]');
    if (createButton) {
        createButton.disabled = true;
        createButton.textContent = '作成中...';
    }
    
    const notebookId = getNotebookId();
    if (!notebookId) {
        NotificationManager.show('ノートブックIDが取得できませんでした', 'error');
        enableCreateButton(createButton);
        return;
    }
    
    fetch(`/notes/${notebookId}/sub-notebook/create/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            title: title,
            description: description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 成功メッセージを表示
            NotificationManager.show(data.message, 'success');
            
            // サブノートタブを動的に追加
            addSubNotebookTab(data.sub_notebook);
            
            // モーダルを閉じる
            closeSubNotebookModal();
            
            // 新しく作成したサブノートでフィルタリング
            setTimeout(() => {
                filterBySubNotebook(data.sub_notebook.id);
            }, 500);
        } else {
            throw new Error(data.error || 'サブノートの作成に失敗しました');
        }
    })
    .catch(error => {
        console.error('サブノート作成エラー:', error);
        NotificationManager.show(error.message, 'error');
    })
    .finally(() => {
        enableCreateButton(createButton);
    });
}

function enableCreateButton(button) {
    if (button) {
        button.disabled = false;
        button.textContent = '作成';
    }
}

function addSubNotebookTab(subNotebook) {
    const tabContainer = document.querySelector('.sub-notebook-tab').parentElement;
    if (!tabContainer) return;
    
    // 新しいタブを作成
    const newTab = document.createElement('button');
    newTab.onclick = () => filterBySubNotebook(subNotebook.id);
    newTab.className = 'sub-notebook-tab px-3 py-2 text-sm rounded-lg bg-gray-700 text-gray-300';
    newTab.dataset.subNotebook = subNotebook.id;
    newTab.textContent = subNotebook.title;
    
    // 追加ボタンの前に挿入
    const addButton = tabContainer.querySelector('button[onclick="openSubNotebookCreateModal()"]');
    if (addButton) {
        tabContainer.insertBefore(newTab, addButton);
    } else {
        tabContainer.appendChild(newTab);
    }
    
    console.log('サブノートタブを追加しました:', subNotebook.title);
}

// ESCキーでモーダルを閉じる
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modals = document.querySelectorAll('.fixed.inset-0:not(.hidden)');
        modals.forEach(modal => {
            if (modal.id === 'entry-detail-modal') {
                closeEntryDetail();
            } else if (modal.id === 'new-entry-modal') {
                closeNewEntryModal();
            } else if (modal.id === 'sub-notebook-modal') {
                closeSubNotebookModal();
            }
        });
    }
});

// ========================================
// エントリータイプ別フォームテンプレート
// ========================================

function createFormField(type, name, label, placeholder = '', required = false, rows = null) {
    const requiredAttr = required ? 'required' : '';
    const requiredMark = required ? '<span class="text-red-400">*</span>' : '';
    
    if (type === 'textarea') {
        const rowsAttr = rows ? `rows="${rows}"` : 'rows="3"';
        return `
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">${label} ${requiredMark}</label>
                <textarea name="${name}" ${rowsAttr} placeholder="${placeholder}" ${requiredAttr}
                        class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
        `;
    } else {
        return `
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">${label} ${requiredMark}</label>
                <input type="${type}" name="${name}" placeholder="${placeholder}" ${requiredAttr}
                       class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
        `;
    }
}

function generateAnalysisForm() {
    return `
        <div class="space-y-4">
            ${createFormField('textarea', 'summary', 'サマリー', '決算の概要を記述してください', false, 3)}
            <div class="grid grid-cols-2 gap-4">
                ${createFormField('text', 'revenue', '売上高', '例: 8.7兆円 (+8.2%)')}
                ${createFormField('text', 'operating_profit', '営業利益', '例: 2.1兆円 (+12.1%)')}
                ${createFormField('text', 'net_income', '純利益', '例: 1.8兆円 (+15.3%)')}
                ${createFormField('text', 'eps', 'EPS', '例: 285円')}
            </div>
            ${createFormField('textarea', 'analysis', '分析', '決算内容の詳細分析を記述してください', false, 4)}
            ${createFormField('textarea', 'outlook', '今後の見通し', '今後の業績見通しや予想を記述してください')}
        </div>
    `;
}

function generateNewsForm() {
    return `
        <div class="space-y-4">
            ${createFormField('text', 'headline', 'ヘッドライン', 'ニュースのタイトルを入力してください')}
            ${createFormField('textarea', 'content', 'ニュース内容', 'ニュースの詳細内容を記述してください', false, 4)}
            ${createFormField('textarea', 'impact', '事業への影響', 'このニュースが事業に与える影響を分析してください')}
            ${createFormField('textarea', 'stock_impact', '株価への影響', '株価への影響や市場の反応を記述してください')}
        </div>
    `;
}

function generateMemoForm() {
    return `
        <div class="space-y-4">
            ${createFormField('textarea', 'observation', '観察事項', '市場や銘柄について気づいたことを記述してください')}
            ${createFormField('textarea', 'market_trend', '市場トレンド', '市場全体のトレンドや動向について記述してください')}
            ${createFormField('textarea', 'personal_note', '個人的メモ', '個人的な考えや戦略について記述してください')}
            ${createFormField('textarea', 'next_action', '次のアクション', '次に取るべきアクションや確認事項を記述してください')}
        </div>
    `;
}

function generateGoalForm() {
    return `
        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                ${createFormField('text', 'target_price', '目標株価', '例: 3,200円')}
                ${createFormField('text', 'sell_timing', '売却タイミング', '例: 配当利回り3%を下回った時点')}
            </div>
            ${createFormField('textarea', 'investment_reason', '投資理由・戦略', 'なぜこの銘柄に投資するのか、どのような戦略で臨むのかを記述してください', false, 4)}
            ${createFormField('textarea', 'expected_effect', '期待される効果', 'この目標達成により期待される効果を記述してください')}
        </div>
    `;
}

function generateEarningsForm() {
    return `
        <div class="space-y-4">
            ${createFormField('date', 'earnings_date', '決算発表日')}
            ${createFormField('text', 'quarter', '四半期', '例: 2025年Q1')}
            ${createFormField('textarea', 'expectations', '事前予想', '決算発表前の予想や期待を記述してください')}
            ${createFormField('textarea', 'key_criteria', '注目ポイント', '今回の決算で注目すべきポイントを記述してください')}
        </div>
    `;
}

function generateIREventForm() {
    return `
        <div class="space-y-4">
            ${createFormField('text', 'event_name', 'イベント名', '例: 決算説明会、株主総会')}
            ${createFormField('datetime-local', 'event_datetime', 'イベント日時')}
            ${createFormField('textarea', 'agenda', 'アジェンダ', 'イベントの議題や内容を記述してください')}
            ${createFormField('textarea', 'key_takeaways', '主要なポイント', 'イベントでの重要な発言や情報を記述してください')}
        </div>
    `;
}

function generateMarketEventForm() {
    return `
        <div class="space-y-4">
            ${createFormField('text', 'event_title', 'イベントタイトル', '例: 金利発表、GDP発表')}
            ${createFormField('date', 'event_date', 'イベント日')}
            ${createFormField('textarea', 'market_impact', '市場への影響', 'このイベントが市場に与える影響を分析してください')}
            ${createFormField('textarea', 'sector_impact', 'セクターへの影響', '特定のセクターや銘柄への影響を記述してください')}
        </div>
    `;
}

</script>
{% endblock %}