<!-- ========================================
templates/notes/detail.html - 見直し版（テーマ単位ノート対応）
======================================== -->

{% extends 'base.html' %}

{% block title %}{{ notebook.title }} - 株式分析記録アプリ{% endblock %}

{% block extra_css %}
<style>
    .entry-card {
        transition: all 0.2s ease-in-out;
    }
    .entry-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    .sub-notebook-tab {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
    }
    .sub-notebook-tab.active {
        background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
    }
    .sub-notebook-tab:hover:not(.active) {
        background-color: rgba(75, 85, 99, 0.5);
    }
    .stats-card {
        background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        border: 1px solid #374151;
    }
    .filter-chip {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
    }
    .filter-chip.active {
        background-color: #3b82f6;
        color: white;
    }
    .filter-chip:hover:not(.active) {
        background-color: rgba(75, 85, 99, 0.7);
    }
    .favorite-star {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
    }
    .favorite-star.active {
        color: #fbbf24;
    }
    .bookmark-icon {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
    }
    .bookmark-icon.active {
        color: #3b82f6;
    }
    
    /* タッチデバイス用の調整 */
    @media (max-width: 768px) {
        .entry-card {
            margin-bottom: 0.75rem;
        }
        
        /* タップ領域を確保 */
        button, .cursor-pointer {
            min-height: 44px;
            min-width: 44px;
        }
        
        .sub-notebook-tab {
            min-height: 36px;
            padding: 0.25rem 0.75rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-2 sm:px-4">
    <!-- ノートヘッダー -->
    <div class="bg-gray-800 border border-gray-700 rounded-lg mb-6 md:mb-8">
        <div class="p-4 md:p-6 border-b border-gray-700">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-0 mb-4">
                <div class="flex items-center space-x-3 md:space-x-4 min-w-0 flex-1">
                    <a href="{% url 'notes:list' %}" 
                       title="ノート一覧に戻る"
                       class="text-gray-400 hover:text-white transition-colors flex-shrink-0">
                        <svg class="h-5 w-5 md:h-6 md:w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </a>
                    <div class="min-w-0 flex-1">
                        <div class="flex items-center gap-2">
                            <h1 class="text-xl md:text-2xl font-bold text-white truncate">{{ notebook.title }}</h1>
                            <button onclick="toggleFavorite()" 
                                    title="お気に入り切り替え"
                                    class="favorite-star text-gray-400 hover:text-yellow-400 {% if notebook.is_favorite %}active{% endif %}">
                                <svg class="h-5 w-5" fill="{% if notebook.is_favorite %}currentColor{% else %}none{% endif %}" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                </svg>
                            </button>
                        </div>
                        {% if notebook.subtitle %}
                            <p class="text-sm md:text-base text-gray-400 truncate">{{ notebook.subtitle }}</p>
                        {% endif %}
                        <span class="inline-block px-2 py-1 text-xs rounded bg-gray-600 text-gray-300 mt-1">
                            {{ notebook.get_notebook_type_display }}
                        </span>
                    </div>
                </div>
                
                <div class="flex items-center space-x-2 md:space-x-3">
                    <span class="px-2 md:px-3 py-1 text-xs md:text-sm rounded-full 
                               {% if notebook.status == 'ACTIVE' %}bg-green-900 text-green-300
                               {% elif notebook.status == 'MONITORING' %}bg-yellow-900 text-yellow-300
                               {% elif notebook.status == 'ATTENTION' %}bg-red-900 text-red-300
                               {% else %}bg-gray-700 text-gray-300{% endif %}">
                        <span class="hidden sm:inline">{{ notebook.get_status_display }}</span>
                        <span class="sm:hidden">
                            {% if notebook.status == 'ACTIVE' %}●
                            {% elif notebook.status == 'MONITORING' %}⚠
                            {% elif notebook.status == 'ATTENTION' %}⚠
                            {% else %}○{% endif %}
                        </span>
                    </span>
                    
                    <button onclick="openNewEntryModal()" 
                            title="新規エントリー作成"
                            class="inline-flex items-center px-2 md:px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                        <svg class="h-4 w-4 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        <span class="hidden md:inline ml-2">新規エントリー</span>
                    </button>
                    
                    <a href="{% url 'notes:edit' notebook.pk %}" 
                       title="ノート編集"
                       class="inline-flex items-center px-2 md:px-4 py-2 border border-gray-600 text-gray-300 hover:bg-gray-700 rounded-lg transition-colors">
                        <svg class="h-4 w-4 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        <span class="hidden md:inline ml-2">編集</span>
                    </a>
                </div>
            </div>
            
            <!-- 統計情報 -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-4">
                <div class="stats-card p-3 md:p-4 rounded-lg text-center">
                    <div class="text-lg md:text-2xl font-bold text-blue-400">{{ stats.total_entries }}</div>
                    <div class="text-xs md:text-sm text-gray-400">総エントリー数</div>
                </div>
                <div class="stats-card p-3 md:p-4 rounded-lg text-center">
                    <div class="text-lg md:text-2xl font-bold text-green-400">{{ stats.stock_count }}</div>
                    <div class="text-xs md:text-sm text-gray-400">銘柄数</div>
                </div>
                <div class="stats-card p-3 md:p-4 rounded-lg text-center">
                    <div class="text-lg md:text-2xl font-bold text-purple-400">{{ stats.recent_entries }}</div>
                    <div class="text-xs md:text-sm text-gray-400">今週の記録</div>
                </div>
                <div class="stats-card p-3 md:p-4 rounded-lg text-center">
                    <div class="text-lg md:text-2xl font-bold text-yellow-400">{{ stats.important_entries }}</div>
                    <div class="text-xs md:text-sm text-gray-400">重要記録</div>
                </div>
            </div>
            
            <!-- タグ -->
            {% if notebook.tags.all %}
                <div class="flex flex-wrap gap-1 md:gap-2">
                    {% for tag in notebook.tags.all %}
                        <span class="px-1 md:px-2 py-1 text-xs border border-gray-600 text-gray-300 rounded hover:bg-gray-700 cursor-pointer transition-colors truncate max-w-24 sm:max-w-none">
                            {{ tag.name }}
                        </span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <!-- 投資戦略セクション -->
        <div class="p-4 md:p-6">
            <h3 class="text-base md:text-lg font-semibold text-white mb-4 flex items-center">
                <svg class="h-4 w-4 md:h-5 md:w-5 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                </svg>
                投資戦略・テーマ
            </h3>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                <!-- 投資戦略 -->
                <div class="lg:col-span-2">
                    <h4 class="text-sm font-medium text-gray-300 mb-2">投資戦略</h4>
                    <p class="text-sm md:text-base text-gray-300 leading-relaxed">{{ notebook.investment_strategy }}</p>
                </div>
                
                <!-- 目標配分 -->
                {% if notebook.target_allocation %}
                    <div>
                        <h4 class="text-sm font-medium text-gray-300 mb-2">目標配分</h4>
                        <p class="text-sm md:text-base text-green-400 font-semibold">{{ notebook.target_allocation }}</p>
                    </div>
                {% endif %}
            </div>
            
            <!-- 選定基準とリスク要因 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mt-4 md:mt-6">
                {% if notebook.key_criteria %}
                    <div>
                        <h4 class="text-sm font-medium text-gray-300 mb-3 flex items-center">
                            <svg class="h-3 w-3 md:h-4 md:w-4 mr-1 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            選定基準
                        </h4>
                        <ul class="space-y-2">
                            {% for criteria in notebook.key_criteria %}
                                <li class="flex items-start">
                                    <span class="w-1.5 h-1.5 md:w-2 md:h-2 bg-blue-400 rounded-full mt-2 mr-2 md:mr-3 flex-shrink-0"></span>
                                    <span class="text-sm md:text-base text-gray-300">{{ criteria }}</span>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
                
                {% if notebook.risk_factors %}
                    <div>
                        <h4 class="text-sm font-medium text-gray-300 mb-3 flex items-center">
                            <svg class="h-3 w-3 md:h-4 md:w-4 mr-1 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                            リスク要因
                        </h4>
                        <ul class="space-y-2">
                            {% for risk in notebook.risk_factors %}
                                <li class="flex items-start">
                                    <span class="w-1.5 h-1.5 md:w-2 md:h-2 bg-yellow-400 rounded-full mt-2 mr-2 md:mr-3 flex-shrink-0"></span>
                                    <span class="text-sm md:text-base text-gray-300">{{ risk }}</span>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- フィルター・サブノートタブ -->
    <div class="bg-gray-800 border border-gray-700 rounded-lg mb-4 md:mb-6">
        <div class="p-4 md:p-6">
            <!-- サブノートタブ -->
            {% if sub_notebooks %}
                <div class="mb-4">
                    <h3 class="text-sm font-medium text-gray-300 mb-3">サブノート</h3>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterBySubNotebook('')" 
                                class="sub-notebook-tab px-3 py-2 text-sm rounded-lg bg-gray-700 text-gray-300 active"
                                data-sub-notebook="">
                            すべて
                        </button>
                        {% for sub_notebook in sub_notebooks %}
                            <button onclick="filterBySubNotebook('{{ sub_notebook.pk }}')" 
                                    class="sub-notebook-tab px-3 py-2 text-sm rounded-lg bg-gray-700 text-gray-300"
                                    data-sub-notebook="{{ sub_notebook.pk }}">
                                {{ sub_notebook.title }}
                            </button>
                        {% endfor %}
                        <button onclick="openSubNotebookCreateModal()" 
                                title="サブノート追加"
                                class="px-3 py-2 text-sm rounded-lg border border-gray-600 text-gray-400 hover:text-white hover:border-blue-500 transition-colors">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            {% endif %}
            
            <!-- その他のフィルター -->
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-0">
                <div class="flex flex-wrap gap-2">
                    <!-- エントリータイプフィルター -->
                    <select id="entry-type-filter" class="bg-gray-700 border border-gray-600 text-white rounded px-2 md:px-3 py-1 text-xs md:text-sm">
                        <option value="">すべてのタイプ</option>
                        <option value="ANALYSIS">決算分析</option>
                        <option value="NEWS">ニュース</option>
                        <option value="CALCULATION">計算結果</option>
                        <option value="MEMO">メモ</option>
                        <option value="GOAL">投資目標</option>
                        <option value="EARNINGS">決算発表</option>
                        <option value="IR_EVENT">IRイベント</option>
                        <option value="MARKET_EVENT">市場イベント</option>
                    </select>
                    
                    <!-- 銘柄フィルター -->
                    {% if stocks %}
                        <select id="stock-filter" class="bg-gray-700 border border-gray-600 text-white rounded px-2 md:px-3 py-1 text-xs md:text-sm">
                            <option value="">すべての銘柄</option>
                            {% for stock in stocks %}
                                <option value="{{ stock.stock_code }}">
                                    {% if stock.stock_code and stock.company_name %}
                                        {{ stock.stock_code }} {{ stock.company_name }}
                                    {% elif stock.stock_code %}
                                        {{ stock.stock_code }}
                                    {% else %}
                                        {{ stock.company_name }}
                                    {% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    {% endif %}
                    
                    <!-- 重要フラグフィルター -->
                    <button onclick="toggleImportantFilter()" 
                            id="important-filter"
                            class="filter-chip px-3 py-1 text-xs md:text-sm rounded border border-gray-600 text-gray-300">
                        <svg class="h-3 w-3 md:h-4 md:w-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                        </svg>
                        重要
                    </button>
                    
                    <!-- ブックマークフィルター -->
                    <button onclick="toggleBookmarkFilter()" 
                            id="bookmark-filter"
                            class="filter-chip px-3 py-1 text-xs md:text-sm rounded border border-gray-600 text-gray-300">
                        <svg class="h-3 w-3 md:h-4 md:w-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                        </svg>
                        ブックマーク
                    </button>
                </div>
                
                <!-- ソート -->
                <div class="flex items-center space-x-2">
                    <span class="text-xs md:text-sm text-gray-400">並び順:</span>
                    <select id="sort-order" class="bg-gray-700 border border-gray-600 text-white rounded px-2 py-1 text-xs md:text-sm">
                        <option value="newest">新しい順</option>
                        <option value="oldest">古い順</option>
                        <option value="important">重要度順</option>
                        <option value="stock">銘柄順</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- エントリー一覧 -->
    <div class="space-y-4 md:space-y-6">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-0">
            <h2 class="text-lg md:text-xl font-semibold text-white flex items-center">
                <svg class="h-4 w-4 md:h-5 md:w-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
                <span class="hidden sm:inline">記録エントリー</span>
                <span class="sm:hidden">記録</span>
                <span class="ml-2 text-gray-400 text-sm md:text-base font-normal" id="entries-count">({{ entries.count }}件)</span>
            </h2>
        </div>
        
        {% if entries %}
            <!-- エントリーカード -->
            <div class="space-y-3 md:space-y-4" id="entries-container">
                {% for entry in entries %}
                    <div class="entry-card bg-gray-800 border border-gray-700 rounded-lg overflow-hidden cursor-pointer hover:bg-gray-750 transition-colors"
                         data-entry-type="{{ entry.entry_type }}"
                         data-entry-id="{{ entry.pk }}"
                         data-stock-code="{{ entry.stock_code }}"
                         data-sub-notebook="{{ entry.sub_notebook.pk|default:'' }}"
                         data-important="{{ entry.is_important|yesno:'true,false' }}"
                         data-bookmarked="{{ entry.is_bookmarked|yesno:'true,false' }}"
                         data-created="{{ entry.created_at|date:'Y-m-d' }}"
                         onclick="handleEntryCardClick('{{ entry.pk }}')">
                        <div class="p-4 md:p-6">
                            <!-- エントリーヘッダー -->
                            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-0 mb-4">
                                <div class="flex items-center space-x-3 min-w-0 flex-1">
                                    <div class="p-2 rounded-lg flex-shrink-0 {% if entry.entry_type == 'ANALYSIS' %}bg-blue-900 text-blue-300{% elif entry.entry_type == 'NEWS' %}bg-green-900 text-green-300{% elif entry.entry_type == 'CALCULATION' %}bg-orange-900 text-orange-300{% elif entry.entry_type == 'MEMO' %}bg-gray-700 text-gray-300{% elif entry.entry_type == 'EARNINGS' %}bg-purple-900 text-purple-300{% elif entry.entry_type == 'IR_EVENT' %}bg-indigo-900 text-indigo-300{% elif entry.entry_type == 'MARKET_EVENT' %}bg-pink-900 text-pink-300{% else %}bg-yellow-900 text-yellow-300{% endif %}">
                                        {% if entry.entry_type == 'ANALYSIS' %}
                                            <svg class="h-4 w-4 md:h-5 md:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                            </svg>
                                        {% elif entry.entry_type == 'NEWS' %}
                                            <svg class="h-4 w-4 md:h-5 md:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9.5a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
                                            </svg>
                                        {% elif entry.entry_type == 'CALCULATION' %}
                                            <svg class="h-4 w-4 md:h-5 md:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                            </svg>
                                        {% elif entry.entry_type == 'EARNINGS' %}
                                            <svg class="h-4 w-4 md:h-5 md:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                            </svg>
                                        {% else %}
                                            <svg class="h-4 w-4 md:h-5 md:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                            </svg>
                                        {% endif %}
                                    </div>
                                    <div class="min-w-0 flex-1">
                                        <div class="flex items-center gap-2">
                                            <h3 class="text-base md:text-lg font-semibold text-white truncate">{{ entry.title }}</h3>
                                            {% if entry.is_important %}
                                                <svg class="h-4 w-4 text-yellow-400 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                                </svg>
                                            {% endif %}
                                            {% if entry.is_bookmarked %}
                                                <svg class="h-4 w-4 text-blue-400 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                                                </svg>
                                            {% endif %}
                                        </div>
                                        <div class="text-xs md:text-sm text-gray-400 mt-1">
                                            <span class="hidden sm:inline">{{ entry.get_entry_type_display }}</span>
                                            <span class="sm:hidden">
                                                {% if entry.entry_type == 'ANALYSIS' %}分析
                                                {% elif entry.entry_type == 'NEWS' %}ニュース
                                                {% elif entry.entry_type == 'CALCULATION' %}計算
                                                {% elif entry.entry_type == 'MEMO' %}メモ
                                                {% elif entry.entry_type == 'EARNINGS' %}決算
                                                {% elif entry.entry_type == 'IR_EVENT' %}IR
                                                {% elif entry.entry_type == 'MARKET_EVENT' %}市場
                                                {% else %}目標{% endif %}
                                            </span>
                                            {% if entry.stock_code or entry.company_name %}
                                                • {{ entry.get_stock_display }}
                                            {% endif %}
                                            {% if entry.sub_notebook %}
                                                • {{ entry.sub_notebook.title }}
                                            {% endif %}
                                            • {{ entry.created_at|date:"m/d H:i" }}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex items-center space-x-1 sm:space-x-2 flex-shrink-0">
                                    {% if entry.tags.all %}
                                        <div class="flex space-x-1">
                                            {% for tag in entry.tags.all|slice:":2" %}
                                                <span class="px-1 md:px-2 py-1 text-xs bg-gray-700 text-gray-300 rounded truncate max-w-16 sm:max-w-none">{{ tag.name }}</span>
                                            {% endfor %}
                                            {% if entry.tags.count > 2 %}
                                                <span class="px-1 md:px-2 py-1 text-xs bg-gray-700 text-gray-300 rounded">+{{ entry.tags.count|add:"-2" }}</span>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                    
                                    <!-- エントリーアクション -->
                                    <div class="flex items-center space-x-1" onclick="event.stopPropagation()">
                                        <button onclick="toggleEntryBookmark('{{ entry.pk }}')" 
                                                title="ブックマーク切り替え"
                                                class="bookmark-icon p-1 text-gray-400 hover:text-blue-400 {% if entry.is_bookmarked %}active{% endif %}">
                                            <svg class="h-4 w-4" fill="{% if entry.is_bookmarked %}currentColor{% else %}none{% endif %}" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- エントリー内容プレビュー -->
                            <div class="text-sm md:text-base text-gray-300">
                                {% if entry.entry_type == 'ANALYSIS' and entry.content.summary %}
                                    <p class="mb-2"><strong>サマリー:</strong> {{ entry.content.summary|truncatewords:30 }}</p>
                                {% elif entry.entry_type == 'NEWS' and entry.content.headline %}
                                    <p class="mb-2"><strong>ヘッドライン:</strong> {{ entry.content.headline }}</p>
                                {% elif entry.entry_type == 'CALCULATION' and entry.content.current_price %}
                                    <p class="mb-2"><strong>現在株価:</strong> {{ entry.content.current_price }}</p>
                                {% elif entry.entry_type == 'MEMO' and entry.content.observation %}
                                    <p class="mb-2">{{ entry.content.observation|truncatewords:30 }}</p>
                                {% endif %}
                                
                                <!-- エントリー内容の詳細を表示 -->
                                <div class="mt-2 md:mt-3 text-xs md:text-sm text-gray-400">
                                    クリックして詳細を表示...
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <!-- ページネーション -->
            {% if is_paginated %}
                <div class="flex items-center justify-center space-x-2 md:space-x-4 mt-8">
                    <button onclick="previousPage()" 
                            {% if not page_obj.has_previous %}disabled{% endif %}
                            title="前のページ"
                            class="px-2 md:px-4 py-2 bg-gray-800 border border-gray-700 text-white rounded hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        <svg class="h-4 w-4 md:mr-1 md:inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        <span class="hidden md:inline ml-1">前のページ</span>
                    </button>
                    
                    <div class="flex items-center space-x-2">
                        <span class="text-gray-400 text-xs md:text-sm">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
                    </div>
                    
                    <button onclick="nextPage()" 
                            {% if not page_obj.has_next %}disabled{% endif %}
                            title="次のページ"
                            class="px-2 md:px-4 py-2 bg-gray-800 border border-gray-700 text-white rounded hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        <span class="hidden md:inline mr-1">次のページ</span>
                        <svg class="h-4 w-4 md:ml-1 md:inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            {% endif %}
        {% else %}
            <!-- エントリーなしの場合 -->
            <div class="text-center py-12 md:py-16">
                <div class="mx-auto h-16 w-16 md:h-24 md:w-24 text-gray-600 mb-4">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <h3 class="text-base md:text-lg font-medium text-gray-400 mb-2">まだエントリーがありません</h3>
                <p class="text-sm md:text-base text-gray-500 mb-6">最初の分析記録を作成しましょう</p>
                <button onclick="openNewEntryModal()" 
                        class="inline-flex items-center px-4 md:px-6 py-2 md:py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
                    <svg class="h-4 w-4 md:h-5 md:w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    <span class="hidden sm:inline">最初のエントリーを作成</span>
                    <span class="sm:hidden">エントリー作成</span>
                </button>
            </div>
        {% endif %}
    </div>
</div>

<!-- 新規エントリーモーダル（既存のものを使用） -->
<div id="new-entry-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-2 md:p-4">
    <div class="bg-gray-900 border border-gray-700 rounded-lg w-full max-w-4xl max-h-[95vh] md:max-h-[90vh] overflow-hidden">
        <div class="flex items-center justify-between p-4 md:p-6 border-b border-gray-700">
            <div>
                <h2 class="text-lg md:text-2xl font-bold text-white">新規エントリー作成</h2>
                <p class="text-sm md:text-base text-gray-400">{{ notebook.title }} に新しい記録を追加します</p>
            </div>
            <button onclick="closeNewEntryModal()" class="text-gray-400 hover:text-white p-2">
                <svg class="h-5 w-5 md:h-6 md:w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <form id="entry-form" method="POST" action="{% url 'notes:entry_create' notebook.pk %}" class="overflow-y-auto max-h-[calc(95vh-140px)] md:max-h-[calc(90vh-140px)]">
            {% csrf_token %}
            <div class="p-4 md:p-6 space-y-4 md:space-y-6">
                <!-- エントリータイプ選択 -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-4">エントリータイプ</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-3">
                        <button type="button" data-entry-type="ANALYSIS" 
                                class="entry-type-btn p-3 md:p-4 rounded-lg border-2 border-gray-600 bg-gray-700 hover:bg-gray-600 transition-all text-center">
                            <div class="p-2 rounded-lg bg-blue-900 text-blue-300 mb-2 mx-auto w-fit">
                                <svg class="h-4 w-4 md:h-5 md:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-white text-xs md:text-sm">決算分析</h3>
                            <p class="text-xs text-gray-400 mt-1 hidden md:block">決算情報の分析記録</p>
                        </button>
                        
                        <button type="button" data-entry-type="NEWS" 
                                class="entry-type-btn p-3 md:p-4 rounded-lg border-2 border-gray-600 bg-gray-700 hover:bg-gray-600 transition-all text-center">
                            <div class="p-2 rounded-lg bg-green-900 text-green-300 mb-2 mx-auto w-fit">
                                <svg class="h-4 w-4 md:h-5 md:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9.5a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-white text-xs md:text-sm">ニュース</h3>
                            <p class="text-xs text-gray-400 mt-1 hidden md:block">関連ニュースの記録</p>
                        </button>
                        
                        <button type="button" data-entry-type="CALCULATION" 
                                class="entry-type-btn p-3 md:p-4 rounded-lg border-2 border-gray-600 bg-gray-700 hover:bg-gray-600 transition-all text-center">
                            <div class="p-2 rounded-lg bg-orange-900 text-orange-300 mb-2 mx-auto w-fit">
                                <svg class="h-4 w-4 md:h-5 md:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-white text-xs md:text-sm">計算結果</h3>
                            <p class="text-xs text-gray-400 mt-1 hidden md:block">バリュエーション計算</p>
                        </button>
                        
                        <button type="button" data-entry-type="MEMO" 
                                class="entry-type-btn p-3 md:p-4 rounded-lg border-2 border-gray-600 bg-gray-700 hover:bg-gray-600 transition-all text-center">
                            <div class="p-2 rounded-lg bg-gray-700 text-gray-300 mb-2 mx-auto w-fit">
                                <svg class="h-4 w-4 md:h-5 md:w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                            </div>
                            <h3 class="font-semibold text-white text-xs md:text-sm">メモ</h3>
                            <p class="text-xs text-gray-400 mt-1 hidden md:block">個人的な気づき・メモ</p>
                        </button>
                    </div>
                    <input type="hidden" id="entry_type" name="entry_type" required>
                </div>
                
                <!-- 基本情報 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- エントリータイトル -->
                    <div>
                        <label for="entry_title" class="block text-sm font-medium text-gray-300 mb-2">
                            エントリータイトル <span class="text-red-400">*</span>
                        </label>
                        <input type="text" 
                               id="entry_title" 
                               name="title" 
                               required
                               placeholder="エントリーのタイトルを入力してください"
                               class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <!-- サブノート選択 -->
                    {% if sub_notebooks %}
                        <div>
                            <label for="sub_notebook" class="block text-sm font-medium text-gray-300 mb-2">サブノート</label>
                            <select id="sub_notebook" 
                                    name="sub_notebook"
                                    class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">サブノートを選択（任意）</option>
                                {% for sub_notebook in sub_notebooks %}
                                    <option value="{{ sub_notebook.pk }}">{{ sub_notebook.title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    {% endif %}
                </div>
                
                <!-- 銘柄情報 -->
                <div>
                    <h4 class="text-sm font-medium text-gray-300 mb-3">銘柄情報（任意）</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="stock_code" class="block text-sm font-medium text-gray-300 mb-2">銘柄コード</label>
                            <input type="text" 
                                   id="stock_code" 
                                   name="stock_code" 
                                   placeholder="例: 7203"
                                   class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label for="company_name" class="block text-sm font-medium text-gray-300 mb-2">企業名</label>
                            <input type="text" 
                                   id="company_name" 
                                   name="company_name" 
                                   placeholder="例: トヨタ自動車"
                                   class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label for="market" class="block text-sm font-medium text-gray-300 mb-2">市場</label>
                            <input type="text" 
                                   id="market" 
                                   name="market" 
                                   placeholder="例: 東証プライム"
                                   class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
                
                <!-- オプション -->
                <div class="flex flex-wrap gap-4">
                    <label class="flex items-center">
                        <input type="checkbox" name="is_important" class="text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-300">重要フラグ</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="is_bookmarked" class="text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-300">ブックマーク</span>
                    </label>
                    <div>
                        <label for="event_date" class="block text-sm font-medium text-gray-300 mb-2">イベント日</label>
                        <input type="date" 
                               id="event_date" 
                               name="event_date"
                               class="bg-gray-700 border border-gray-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <!-- エントリー固有フォーム -->
                <div id="entry-type-form">
                    <!-- 動的に生成されるフォーム内容 -->
                </div>
            </div>
            
            <div class="flex flex-col sm:flex-row items-center justify-between p-4 md:p-6 bg-gray-800 border-t border-gray-700 gap-3 sm:gap-0">
                <div class="text-xs md:text-sm text-gray-400 order-2 sm:order-1">
                    <svg class="h-3 w-3 md:h-4 md:w-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    作成日: {{ 'now'|date:"Y/m/d" }}
                </div>
                <div class="flex space-x-2 md:space-x-3 w-full sm:w-auto order-1 sm:order-2">
                    <button type="button" onclick="closeNewEntryModal()" 
                            class="flex-1 sm:flex-none px-4 md:px-6 py-2 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition-colors text-sm md:text-base">
                        キャンセル
                    </button>
                    <button type="submit" 
                            class="flex-1 sm:flex-none px-4 md:px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center justify-center text-sm md:text-base">
                        <svg class="h-3 w-3 md:h-4 md:w-4 mr-1 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="hidden sm:inline">エントリーを作成</span>
                        <span class="sm:hidden">作成</span>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- エントリー詳細モーダル（既存のものを使用） -->
<div id="entry-detail-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-2 md:p-4">
    <div class="bg-gray-900 border border-gray-700 rounded-lg w-full max-w-4xl max-h-[95vh] md:max-h-[90vh] overflow-hidden">
        <div class="flex items-center justify-between p-4 md:p-6 border-b border-gray-700">
            <h3 class="text-lg md:text-xl font-semibold text-white" id="entry-detail-title">エントリー詳細</h3>
            <button onclick="closeEntryDetail()" class="text-gray-400 hover:text-white p-2">
                <svg class="h-5 w-5 md:h-6 md:w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div id="entry-detail-content" class="p-4 md:p-6 overflow-y-auto max-h-[calc(95vh-120px)] md:max-h-[60vh]">
            <!-- エントリー詳細内容がここに表示される -->
        </div>
    </div>
</div>

<!-- サブノート作成モーダル -->
<div id="sub-notebook-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-gray-900 border border-gray-700 rounded-lg w-full max-w-md">
        <div class="flex items-center justify-between p-6 border-b border-gray-700">
            <h3 class="text-lg font-semibold text-white">サブノート作成</h3>
            <button onclick="closeSubNotebookModal()" class="text-gray-400 hover:text-white">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="p-6">
            <div class="space-y-4">
                <div>
                    <label for="sub-notebook-title" class="block text-sm font-medium text-gray-300 mb-2">サブノート名 *</label>
                    <input type="text" 
                           id="sub-notebook-title" 
                           placeholder="例: 日本株"
                           class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="sub-notebook-description" class="block text-sm font-medium text-gray-300 mb-2">説明</label>
                    <textarea id="sub-notebook-description" 
                              rows="3"
                              placeholder="サブノートの説明（任意）"
                              class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeSubNotebookModal()" 
                        class="px-4 py-2 border border-gray-600 text-gray-300 rounded-lg hover:bg-gray-700 transition-colors">
                    キャンセル
                </button>
                <button onclick="createSubNotebook()" 
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                    作成
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
let selectedEntryType = null;

// DOM準備完了時の初期化
document.addEventListener('DOMContentLoaded', function() {
    console.log('ノート詳細ページが初期化されました');
    
    // エントリータイプボタンのイベントリスナー設定
    setupEntryTypeButtons();
    
    // フォーム送信時の処理
    setupFormSubmission();
    
    // エントリータイプフィルター設定
    setupEntryTypeFilter();
});

// エントリータイプボタンの設定
function setupEntryTypeButtons() {
    const entryTypeButtons = document.querySelectorAll('.entry-type-btn');
    console.log('エントリータイプボタン数:', entryTypeButtons.length);
    
    entryTypeButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const entryType = this.getAttribute('data-entry-type');
            console.log('エントリータイプ選択:', entryType);
            
            if (entryType) {
                selectEntryType(entryType, this);
            }
        });
    });
}

// エントリータイプ選択
function selectEntryType(type, buttonElement) {
    console.log('selectEntryType呼び出し:', type);
    selectedEntryType = type;
    
    // hidden inputに値を設定
    const entryTypeInput = document.getElementById('entry_type');
    if (entryTypeInput) {
        entryTypeInput.value = type;
        console.log('エントリータイプ設定完了:', entryTypeInput.value);
    }
    
    // すべてのボタンを未選択状態にリセット
    document.querySelectorAll('.entry-type-btn').forEach(btn => {
        btn.classList.remove('selected', 'border-blue-500', 'bg-blue-900/30');
        btn.classList.add('border-gray-600', 'bg-gray-700');
    });
    
    // 選択されたボタンをハイライト
    if (buttonElement) {
        buttonElement.classList.remove('border-gray-600', 'bg-gray-700');
        buttonElement.classList.add('selected', 'border-blue-500', 'bg-blue-900/30');
        console.log('ボタンハイライト完了');
    }
    
    // エントリータイプ固有フォームを生成
    generateEntryTypeForm(type);
}

// エントリータイプ固有フォーム生成
function generateEntryTypeForm(type) {
    console.log('フォーム生成:', type);
    const container = document.getElementById('entry-type-form');
    let formHtml = '';
    
    switch(type) {
        case 'ANALYSIS':
            formHtml = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">サマリー</label>
                        <textarea name="summary" rows="3" placeholder="決算の概要を記述してください"
                                class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">売上高</label>
                            <input type="text" name="revenue" placeholder="例: 8.7兆円 (+8.2%)"
                                   class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">営業利益</label>
                            <input type="text" name="operating_profit" placeholder="例: 2.1兆円 (+12.1%)"
                                   class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">純利益</label>
                            <input type="text" name="net_income" placeholder="例: 1.8兆円 (+15.3%)"
                                   class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">EPS</label>
                            <input type="text" name="eps" placeholder="例: 285円"
                                   class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">分析</label>
                        <textarea name="analysis" rows="4" placeholder="決算内容の詳細分析を記述してください"
                                class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">今後の見通し</label>
                        <textarea name="outlook" rows="3" placeholder="今後の業績見通しや予想を記述してください"
                                class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>
            `;
            break;
            
        case 'NEWS':
            formHtml = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">ヘッドライン</label>
                        <input type="text" name="headline" placeholder="ニュースのタイトルを入力してください"
                               class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">ニュース内容</label>
                        <textarea name="content" rows="4" placeholder="ニュースの詳細内容を記述してください"
                                class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">事業への影響</label>
                        <textarea name="impact" rows="3" placeholder="このニュースが事業に与える影響を分析してください"
                                class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">株価への影響</label>
                        <textarea name="stock_impact" rows="3" placeholder="株価への影響や市場の反応を記述してください"
                                class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>
            `;
            break;
            
        case 'CALCULATION':
            formHtml = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">現在株価</label>
                        <input type="text" name="current_price" placeholder="例: 2,850円"
                               class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">PER</label>
                            <input type="text" name="per" placeholder="例: 12.5倍"
                                   class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">PBR</label>
                            <input type="text" name="pbr" placeholder="例: 1.1倍"
                                   class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">配当利回り</label>
                            <input type="text" name="dividend_yield" placeholder="例: 2.8%"
                                   class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">ROE</label>
                            <input type="text" name="roe" placeholder="例: 8.9%"
                                   class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">適正価格</label>
                        <input type="text" name="fair_value" placeholder="例: 3,100円 - 3,300円"
                               class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">推奨・コメント</label>
                        <textarea name="recommendation" rows="3" placeholder="計算結果に基づく推奨や分析コメントを記述してください"
                                class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>
            `;
            break;
            
        case 'MEMO':
            formHtml = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">観察事項</label>
                        <textarea name="observation" rows="3" placeholder="市場や銘柄について気づいたことを記述してください"
                                class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">市場トレンド</label>
                        <textarea name="market_trend" rows="3" placeholder="市場全体のトレンドや動向について記述してください"
                                class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">個人的メモ</label>
                        <textarea name="personal_note" rows="3" placeholder="個人的な考えや戦略について記述してください"
                                class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2 flex items-center">
                            <svg class="h-4 w-4 mr-1 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            次のアクション
                        </label>
                        <textarea name="next_action" rows="3" placeholder="次に取るべきアクションや確認事項を記述してください"
                                class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>
            `;
            break;
            
        case 'GOAL':
            formHtml = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">目標株価</label>
                            <input type="text" name="target_price" placeholder="例: 3,200円"
                                   class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">売却タイミング</label>
                            <input type="text" name="sell_timing" placeholder="例: 配当利回り3%を下回った時点"
                                   class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">投資理由・戦略</label>
                        <textarea name="investment_reason" rows="4" placeholder="なぜこの銘柄に投資するのか、どのような戦略で臨むのかを記述してください"
                                class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">期待される効果</label>
                        <textarea name="expected_effect" rows="3" placeholder="この目標達成により期待される効果を記述してください"
                                class="w-full bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>
            `;
            break;
    }
    
    container.innerHTML = formHtml;
    console.log('フォーム生成完了');
}

// エントリーカードクリック処理
function handleEntryCardClick(entryId) {
    console.log('エントリーカードクリック:', entryId);
    openEntryDetail(entryId);
}

// エントリー詳細表示
function openEntryDetail(entryId) {
    console.log('エントリー詳細表示:', entryId);
    
    // ローディング表示
    document.getElementById('entry-detail-title').textContent = '読み込み中...';
    document.getElementById('entry-detail-content').innerHTML = '<div class="flex items-center justify-center py-8"><div class="text-gray-400">読み込み中...</div></div>';
    document.getElementById('entry-detail-modal').classList.remove('hidden');
    
    // エントリー詳細をAjaxで取得して表示
    fetch(`/notes/entry/${entryId}/`)
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('エントリー詳細取得成功:', data);
            if (data.success) {
                document.getElementById('entry-detail-title').textContent = data.title;
                document.getElementById('entry-detail-content').innerHTML = data.html;
            } else {
                throw new Error(data.error || 'データの取得に失敗しました');
            }
        })
        .catch(error => {
            console.error('エントリー詳細取得エラー:', error);
            document.getElementById('entry-detail-title').textContent = 'エラー';
            document.getElementById('entry-detail-content').innerHTML = `
                <div class="text-center py-8">
                    <div class="text-red-400 mb-2">エントリーの詳細を取得できませんでした</div>
                    <div class="text-gray-400 text-sm">${error.message}</div>
                    <button onclick="closeEntryDetail()" class="mt-4 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded">
                        閉じる
                    </button>
                </div>
            `;
        });
}

function closeEntryDetail() {
    console.log('エントリー詳細モーダルを閉じます');
    document.getElementById('entry-detail-modal').classList.add('hidden');
}

// モーダル関連の関数
function openNewEntryModal() {
    console.log('新規エントリーモーダルを開きます');
    const modal = document.getElementById('new-entry-modal');
    modal.classList.remove('hidden');
    
    // モーダル表示中はページのスクロールを無効化
    document.body.style.overflow = 'hidden';
    
    // フォーカスをモーダル内に設定
    setTimeout(() => {
        const titleInput = document.getElementById('entry_title');
        if (titleInput) {
            titleInput.focus();
        }
    }, 100);
}

function closeNewEntryModal() {
    console.log('新規エントリーモーダルを閉じます');
    const modal = document.getElementById('new-entry-modal');
    modal.classList.add('hidden');
    
    // ページのスクロールを有効化
    document.body.style.overflow = '';
    
    // フォームをリセット
    const form = document.getElementById('entry-form');
    if (form) {
        form.reset();
    }
    
    const typeForm = document.getElementById('entry-type-form');
    if (typeForm) {
        typeForm.innerHTML = '';
    }
    
    selectedEntryType = null;
    
    // エントリータイプボタンをリセット
    document.querySelectorAll('.entry-type-btn').forEach(btn => {
        btn.classList.remove('selected', 'border-blue-500', 'bg-blue-900/30');
        btn.classList.add('border-gray-600', 'bg-gray-700');
    });
}

// フォーム送信処理の設定
function setupFormSubmission() {
    const form = document.getElementById('entry-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('フォーム送信開始');
            
            if (!selectedEntryType) {
                e.preventDefault();
                alert('エントリータイプを選択してください。');
                return;
            }
            
            if (!document.getElementById('entry_title').value.trim()) {
                e.preventDefault();
                alert('エントリータイトルを入力してください。');
                return;
            }
            
            // フォームデータをJSONに変換
            const contentData = {};
            
            // エントリータイプ固有のフィールドを収集
            const typeForm = document.getElementById('entry-type-form');
            if (typeForm) {
                const inputs = typeForm.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    if (input.value.trim()) {
                        contentData[input.name] = input.value;
                    }
                });
            }
            
            // key_metricsを別途作成（ANALYSIS用）
            if (selectedEntryType === 'ANALYSIS') {
                contentData.key_metrics = {};
                ['revenue', 'operating_profit', 'net_income', 'eps'].forEach(key => {
                    if (contentData[key]) {
                        contentData.key_metrics[key] = contentData[key];
                        delete contentData[key];
                    }
                });
            }
            
            // calculationsを別途作成（CALCULATION用）
            if (selectedEntryType === 'CALCULATION') {
                contentData.calculations = {};
                ['per', 'pbr', 'dividend_yield', 'roe'].forEach(key => {
                    if (contentData[key]) {
                        contentData.calculations[key] = contentData[key];
                        delete contentData[key];
                    }
                });
            }
            
            // content フィールドにJSONデータを設定
            const contentInput = document.createElement('input');
            contentInput.type = 'hidden';
            contentInput.name = 'content';
            contentInput.value = JSON.stringify(contentData);
            this.appendChild(contentInput);
            
            console.log('Content data:', contentData);
            
            // 送信ボタンを無効化（重複送信防止）
            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = '作成中...';
            
            // 送信後に元に戻す（エラー時のため）
            setTimeout(() => {
                submitButton.disabled = false;
                submitButton.innerHTML = `
                    <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    エントリーを作成
                `;
            }, 3000);
        });
    }
}

// エントリータイプフィルターの設定
function setupEntryTypeFilter() {
    const filter = document.getElementById('entry-type-filter');
    if (filter) {
        filter.addEventListener('change', function() {
            const selectedType = this.value;
            console.log('エントリータイプフィルター:', selectedType);
            const entries = document.querySelectorAll('.entry-card');
            
            entries.forEach(entry => {
                if (selectedType === '' || entry.dataset.entryType === selectedType) {
                    entry.style.display = 'block';
                } else {
                    entry.style.display = 'none';
                }
            });
        });
    }
}

// ページネーション関数
function previousPage() {
    {% if page_obj.has_previous %}
        window.location.href = '?page={{ page_obj.previous_page_number }}';
    {% endif %}
}

function nextPage() {
    {% if page_obj.has_next %}
        window.location.href = '?page={{ page_obj.next_page_number }}';
    {% endif %}
}

function goToPage(pageNum) {
    window.location.href = '?page=' + pageNum;
}

// ESCキーでモーダルを閉じる
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const newEntryModal = document.getElementById('new-entry-modal');
        const entryDetailModal = document.getElementById('entry-detail-modal');
        
        if (!newEntryModal.classList.contains('hidden')) {
            closeNewEntryModal();
        }
        if (!entryDetailModal.classList.contains('hidden')) {
            closeEntryDetail();
        }
    }
});
</script>
{% endblock %}
